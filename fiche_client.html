
<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Fiche client - Mendes Protection Incendie</title>
<link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet"/>
</head>
<body class="min-h-screen pb-24 bg-gray-100 text-gray-800">
<header class="bg-white shadow p-4">
<h1 class="text-xl font-bold text-red-700" id="clientTitle">Fiche client</h1>
<a class="text-sm text-blue-600 underline block mb-2" href="clients.html">← Retour à la liste des clients</a>
<a class="text-sm text-blue-600 underline block mt-1 mb-2" href="#documents">🧾 Voir les documents</a>
</header>
<main class="p-4 space-y-6">
<section class="bg-white shadow rounded-xl p-4" id="clientInfo">
<div class="flex justify-between items-start mb-4">
<h2 class="text-lg font-semibold">Informations client</h2>
<button class="text-sm text-blue-600 underline" onclick="basculerEdition()">✏️ Modifier</button>
</div>
<div class="space-y-2 text-sm text-gray-700" id="clientDetails"></div>
</section>
<section class="bg-white shadow rounded-xl p-4 hidden" id="formEdit">
<h2 class="text-lg font-semibold mb-2">Modifier le client</h2>
<form class="space-y-3" onsubmit="enregistrerModification(); return false;">
<input class="w-full p-2 border rounded" id="edit_nom" placeholder="Nom du client" required=""/>
<input class="w-full p-2 border rounded" id="edit_rue" placeholder="Rue"/>
<input class="w-full p-2 border rounded" id="edit_cp" placeholder="Code postal"/>
<input class="w-full p-2 border rounded" id="edit_ville" placeholder="Ville"/>
<input class="w-full p-2 border rounded" id="edit_dirigeant" placeholder="Nom du dirigeant"/>
<input class="w-full p-2 border rounded" id="edit_siret" placeholder="SIRET"/>
<input class="w-full p-2 border rounded" id="edit_telephone" placeholder="Téléphone"/>
<input class="w-full p-2 border rounded" id="edit_email_compta" placeholder="Email comptabilité"/>
<input class="w-full p-2 border rounded" id="edit_email_direction" placeholder="Email direction"/>
<input class="w-full p-2 border rounded" id="edit_contact" placeholder="Contact référent"/>
<button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded" type="submit">💾 Enregistrer</button>
</form>
</section>
<section class="bg-white shadow rounded-xl p-4">
<h2 class="text-lg font-semibold mb-2">📍 Lieux d’intervention</h2>
<ul class="list-disc ml-5 text-sm text-gray-700" id="lieux"></ul>
<div class="mt-4">
<button class="text-blue-600 underline text-sm mb-2" onclick="document.getElementById('formAjoutLieu').classList.toggle('hidden')">➕ Ajouter un lieu d’intervention</button>
<form class="space-y-2 hidden" id="formAjoutLieu" onsubmit="ajouterLieu(); return false;">
<input class="w-full p-2 border rounded" id="lieu_nom" placeholder="Nom du lieu" required=""/>
<input class="w-full p-2 border rounded" id="lieu_rue" placeholder="Rue"/>
<input class="w-full p-2 border rounded" id="lieu_cp" placeholder="Code postal"/>
<input class="w-full p-2 border rounded" id="lieu_ville" placeholder="Ville"/>
<input class="w-full p-2 border rounded" id="lieu_contact" placeholder="Contact sur place"/>
<button class="bg-blue-600 text-white px-4 py-2 rounded" type="submit">💾 Ajouter le lieu</button>
</form>
</div>
</section>
<section class="bg-white shadow rounded-xl p-4">
<h2 class="text-lg font-semibold mb-2">📄 Historique</h2>
<ul class="text-sm space-y-2 text-gray-700" id="historique"></ul>
</section>
<section class="bg-white shadow rounded-xl p-4" id="documents">
<h2 class="text-lg font-semibold mb-2">📁 Documents disponibles</h2>
<ul class="text-sm space-y-1 text-gray-700" id="liste-documents"></ul>
</section>
</main>
<footer class="fixed bottom-0 left-0 right-0 bg-white border-t shadow flex justify-around p-3 text-xs z-50">
<a class="flex flex-col items-center gap-1" href="index.html">
<span class="text-xl">🏠</span>
<span>Accueil</span>
</a>
<a class="flex flex-col items-center gap-1" href="clients.html">
<span class="text-xl">📁</span>
<span>Clients</span>
</a>
<a class="flex flex-col items-center gap-1" href="intervention.html">
<span class="text-xl">🛠️</span>
<span>Intervention</span>
</a>
</footer>
<script>
    let client;
    let index;

    function chargerClient() {
      const params = new URLSearchParams(window.location.search);
      const nom = params.get('client');
      const clients = JSON.parse(localStorage.getItem('clients') || '[]');
      index = clients.findIndex(c => c.nom === nom);
      if (index === -1) return document.getElementById('clientDetails').innerHTML = '<p class="text-red-600">Client introuvable.</p>';
      client = clients[index];
      document.getElementById('clientTitle').textContent = client.nom;
      afficherClient();
    }

    function afficherClient() {
      const infos = `
        <p><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</p>
        <p><strong>Dirigeant :</strong> ${client.dirigeant || '—'}</p>
        <p><strong>SIRET :</strong> ${client.siret || '—'}</p>
        <p><strong>Téléphone :</strong> ${client.telephone || '—'}</p>
        <p><strong>Email comptabilité :</strong> ${client.email_compta || '—'}</p>
        <p><strong>Email direction :</strong> ${client.email_direction || '—'}</p>
        <p><strong>Contact référent :</strong> ${client.contact || '—'}</p>`;
      document.getElementById('clientDetails').innerHTML = infos;

      const lieux = document.getElementById('lieux');
      lieux.innerHTML = '';
      (client.adresses_intervention || []).forEach((ad, i) => {
        lieux.innerHTML += `<li>${ad.nom || 'Lieu ' + (i + 1)} – ${ad.rue}, ${ad.cp} ${ad.ville} (${ad.contact || 'contact inconnu'})</li>`;
      });

      const historique = document.getElementById('historique');
      const historique = document.getElementById('historique');
      historique.innerHTML = '';
      if (client.historique) {
        const regroupement = {};
        client.historique.forEach(entry => {
          const cle = entry.annee + '-' + entry.mois;
          if (!regroupement[cle]) regroupement[cle] = { annee: entry.annee, mois: entry.mois, docs: [] };
          regroupement[cle].docs.push(...entry.documents);
        });

        const moisNoms = {
          "01": "Janvier", "02": "Février", "03": "Mars", "04": "Avril",
          "05": "Mai", "06": "Juin", "07": "Juillet", "08": "Août",
          "09": "Septembre", "10": "Octobre", "11": "Novembre", "12": "Décembre"
        };

        const parAnnee = {};
        Object.values(regroupement).forEach(e => {
          if (!parAnnee[e.annee]) parAnnee[e.annee] = [];
          parAnnee[e.annee].push({ mois: e.mois, docs: e.docs });
        });

        Object.keys(parAnnee).sort((a,b)=>b-a).forEach(annee => {
          historique.innerHTML += `<li><strong>${annee}</strong><ul class='ml-4 list-disc'>` +
            parAnnee[annee].sort((a,b)=>b.mois.localeCompare(a.mois)).map(e =>
              `<li><strong>${moisNoms[e.mois] || e.mois}</strong><ul class='ml-4 list-none'>` +
              e.docs.map(d => `<li>• ${d.label} ${d.lien ? `<a href='${d.lien}' class='text-blue-600 underline' target='_blank'>📄</a>` : ''}</li>`).join('') +
              '</ul></li>'
            ).join('') +
            '</ul></li>';
        });
      }
      if (client.historique) {
        const parAnnee = {};
        client.historique.forEach(h => {
          if (!parAnnee[h.annee]) parAnnee[h.annee] = [];
          parAnnee[h.annee].push(...h.mois);
        });
        Object.keys(parAnnee).sort((a,b)=>b-a).forEach(annee => {
          historique.innerHTML += `<li><strong>${annee}</strong><ul class='ml-4 list-disc'>${parAnnee[annee].map(m => `<li>${m}</li>`).join('')}</ul></li>`;
        });
      }
    }

    function basculerEdition() {
      document.getElementById('formEdit').classList.remove('hidden');
      document.getElementById('clientInfo').classList.add('hidden');
      for (const champ of ['nom','rue','cp','ville','dirigeant','siret','telephone','email_compta','email_direction','contact']) {
        document.getElementById('edit_' + champ).value = client[champ] || '';
      }
    }

    function enregistrerModification() {
      for (const champ of ['nom','rue','cp','ville','dirigeant','siret','telephone','email_compta','email_direction','contact']) {
        client[champ] = document.getElementById('edit_' + champ).value.trim();
      }
      const clients = JSON.parse(localStorage.getItem('clients') || '[]');
      clients[index] = client;
      localStorage.setItem('clients', JSON.stringify(clients));
      alert("Client modifié !");
      document.getElementById('formEdit').classList.add('hidden');
      document.getElementById('clientInfo').classList.remove('hidden');
      afficherClient();
    }

    
function ajouterLieu() {
  const nom = document.getElementById("lieu_nom").value.trim();
  const rue = document.getElementById("lieu_rue").value.trim();
  const cp = document.getElementById("lieu_cp").value.trim();
  const ville = document.getElementById("lieu_ville").value.trim();
  const contact = document.getElementById("lieu_contact").value.trim();
  if (!client.adresses_intervention) client.adresses_intervention = [];
  client.adresses_intervention.push({ nom, rue, cp, ville, contact });
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  clients[index] = client;
  localStorage.setItem("clients", JSON.stringify(clients));
  alert("Lieu ajouté !");
  document.getElementById("formAjoutLieu").reset();
  document.getElementById("formAjoutLieu").classList.add("hidden");
  afficherClient();
}


window.onload = () => { chargerClient(); setTimeout(() => const docList = document.getElementById('liste-documents');
      docList.innerHTML = '';
      const allDocs = (client.historique || []).flatMap(h => h.documents.map(d => ({
        label: `${d.label} (${h.mois}/${h.annee})`,
        lien: d.lien
      })));
      if (allDocs.length === 0) {
        docList.innerHTML = "<li><em>Aucun document disponible.</em></li>";
      } else {
        allDocs.forEach(doc => {
          docList.innerHTML += `<li>• ${doc.label} ${doc.lien ? `<a href="${doc.lien}" target="_blank" class="text-blue-600 underline">📄</a>` : ''}</li>`;
        });
      }, 200); };
  </script>
<script>
<script>
function lancerInterventionDepuisFiche(clientNom, lieuNom) {
  if (clientNom) {
    localStorage.setItem("nom_client", clientNom);
    localStorage.setItem("lieu_intervention", lieuNom || clientNom);
    window.location.href = "intervention.html";
  } else {
    alert("Nom du client introuvable.");
  }
}
</script>
</script></body>
</html>
