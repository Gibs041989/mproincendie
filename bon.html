
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Bon d’intervention - Mendes Protection Incendie</title>
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
</head>
<body class="min-h-screen bg-gray-100 text-gray-800 pb-24">

  <header class="bg-white shadow p-4">
    <h1 class="text-xl font-bold text-red-700">🧾 Bon d’intervention</h1>
    <div id="client-coordonnees" class="mt-2 text-sm space-y-1"></div>
    <div id="crm-resume" class="mt-3 text-sm bg-blue-50 border-l-4 border-blue-500 p-2"></div>
  </header>

  <main class="p-4 space-y-6">

    <section class="bg-white p-4 shadow rounded-xl">
      <h2 class="text-lg font-semibold mb-2">📦 Prestations & matériel</h2>
      <table class="w-full text-sm border">
        <thead class="bg-gray-200 text-left">
          <tr>
            <th class="p-2">Code article</th>
            <th class="p-2">Désignation</th>
            <th class="p-2 text-right">Qté</th>
            <th class="p-2 text-right">PU €</th>
            <th class="p-2 text-right">Total €</th>
          </tr>
        </thead>
        <tbody id="tableau-lignes" class="divide-y"></tbody>
      </table>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm mt-4">
        <div>
          <label class="block mb-1 text-gray-600">Montant total HT</label>
          <input id="montant-ht" class="w-full border p-2 rounded text-right" placeholder="€" readonly>
        </div>
        <div>
          <label class="block mb-1 text-gray-600">Montant TTC</label>
          <input id="montant-ttc" class="w-full border p-2 rounded text-right" placeholder="€" readonly>
        </div>
      </div>
      <button onclick="ajouterLigne()" class="mt-3 text-sm text-blue-600 underline">➕ Ajouter une ligne</button>
    </section>

    <section class="bg-white p-4 shadow rounded-xl">
      <h2 class="text-lg font-semibold mb-2">⚙️ Modalités de règlement</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4 text-sm">
        <div>
          <label class="block mb-1 text-gray-600">Mode de paiement</label>
          <select class="w-full border p-2 rounded" id="mode-paiement">
            <option>Virement</option>
            <option>Chèque</option>
            <option>Carte bancaire</option>
            <option>Espèces</option>
          </select>
        </div>
        <div>
          <label class="block mb-1 text-gray-600">Délai de paiement</label>
          <select class="w-full border p-2 rounded" id="delai-paiement">
            <option>A réception</option>
            <option>30 jours</option>
            <option>Fin de mois</option>
          </select>
        </div>
        <div>
          <label class="block mb-1 text-gray-600">Montant total HT</label>
          <input id="montant-ht" class="w-full border p-2 rounded text-right" placeholder="€" readonly>
        </div>
        <div>
          <label class="block mb-1 text-gray-600">Montant TTC</label>
          <input id="montant-ttc" class="w-full border p-2 rounded text-right" placeholder="€" readonly>
        </div>
      </div>
    </section>

    <section class="bg-white p-4 shadow rounded-xl">
      <h2 class="text-lg font-semibold mb-2">✍️ Signatures</h2>
      <div class="grid grid-cols-1 md:grid-cols-2 gap-6 text-sm">
        <div>
          <label class="block mb-1">Nom du client signataire</label>
          <input id="nom-client" class="w-full p-2 border rounded">
          <p class="mt-2 italic">Fait à <span id="lieu-signature"></span>, le <span id="date-signature"></span></p>
          <textarea class="w-full h-24 border border-dashed p-2 text-sm text-gray-700" placeholder="Signature manuscrite ou note client..."></textarea>
        </div>
        <div>
          <label class="block mb-1">Nom du technicien</label>
          <input id="nom-tech" class="w-full p-2 border rounded">
          <p class="mt-5 text-transparent">_</p>
          <textarea class="w-full h-24 border border-dashed p-2 text-sm text-gray-700" placeholder="Signature manuscrite ou note client..."></textarea>
        </div>
      </div>
    </section>
  
<section class="bg-white p-4 shadow rounded-xl mt-6">
  <button id="generer-pdf" onclick="genererPDF()" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-lg">📄 Générer le PDF</button>
</section>

</main>

  <footer class="fixed bottom-0 left-0 right-0 bg-white border-t shadow flex justify-around p-3 text-xs z-50">
    <a href="index.html" class="flex flex-col items-center gap-1">
      <span class="text-xl">🏠</span>
      <span>Accueil</span>
    </a>
    <a href="clients.html" class="flex flex-col items-center gap-1">
      <span class="text-xl">📁</span>
      <span>Clients</span>
    </a>
    <a href="intervention.html" class="flex flex-col items-center gap-1">
      <span class="text-xl">🛠️</span>
      <span>Intervention</span>
    </a>
  </footer>

<script>
function chargerCoordonnees() {
  const nomClient = new URLSearchParams(window.location.search).get("client") || localStorage.getItem("client_recent");
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  if (!client) return;

  const normaliseNom = client.nom.normalize("NFD").replace(/\p{Diacritic}/gu, "").replace(/\s+/g, '_').toUpperCase();
  const lieu = client.adresses_intervention?.[0];
  document.getElementById("client-coordonnees").innerHTML = `
    <div><strong>Client :</strong> ${client.nom}</div>
    <div><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</div>
    <div><strong>Lieu d’intervention :</strong> ${lieu?.nom || ''} - ${lieu?.rue || ''}, ${lieu?.ville || ''}</div>
  `;
  document.getElementById("lieu-signature").textContent = client.ville || '';

  const crmTypes = ["extincteurs", "baes", "ria", "desenfumage"];
  let resumeHTML = "<h3 class='font-semibold text-sm mb-2'>📋 Résumé des CRM liés</h3>";
  let trouvé = false;

  crmTypes.forEach(type => {
    const key = `crm_${type}_${normaliseNom}`;
    if (localStorage.getItem(key)) {
      trouvé = true;
      const data = JSON.parse(localStorage.getItem(key));
      const emoji = type === "extincteurs" ? "🧯" :
                    type === "baes" ? "💡" :
                    type === "ria" ? "🚿" :
                    type === "desenfumage" ? "💨" : "❓";
      resumeHTML += `<div class="mb-1"><strong>${emoji} ${type.toUpperCase()}</strong><br><span class="ml-2">${data.resume || "—"}</span></div>`;
      if (Array.isArray(data.articles)) {
        data.articles.forEach(item => {
          const ligne = document.createElement("tr");
          ligne.innerHTML = `
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.code || ''}"></td>
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.designation || ''}"></td>
            <td class="p-2 text-right"><input type="number" min="0" class="w-full p-1 border rounded text-right" value="${item.qte || 1}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right"><input type="number" step="0.01" class="w-full p-1 border rounded text-right" value="${item.pu || 0}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right total-ligne">0.00</td>
          `;
          document.getElementById("tableau-lignes").appendChild(ligne);
        });
      }
    }
  });

  document.getElementById("crm-resume").innerHTML = trouvé ? resumeHTML : "<em>Aucun CRM validé pour ce client.</em>";
  calculerTotal();
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  if (!client) return;

  const normaliseNom = client.nom.replace(/\s+/g, '_').toUpperCase();
  const lieu = client.adresses_intervention?.[0];
  document.getElementById("client-coordonnees").innerHTML = `
    <div><strong>Client :</strong> ${client.nom}</div>
    <div><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</div>
    <div><strong>Lieu d’intervention :</strong> ${lieu?.nom || ''} - ${lieu?.rue || ''}, ${lieu?.ville || ''}</div>
  `;
  document.getElementById("lieu-signature").textContent = client.ville || '';

  const crmTypes = ["extincteurs", "baes", "ria", "desenfumage"];
  let resume = "";
  crmTypes.forEach(type => {
    const key = `crm_${type}_${normaliseNom}`;
    if (localStorage.getItem(key)) {
      const data = JSON.parse(localStorage.getItem(key));
      const emoji = type === "extincteurs" ? "🧯" :
                    type === "baes" ? "💡" :
                    type === "ria" ? "🚿" :
                    type === "desenfumage" ? "💨" : "❓";
      if (data.resume) resume += `<div><strong>${emoji} ${type.toUpperCase()}</strong> : ${data.resume}</div>`;
      if (Array.isArray(data.articles)) {
        data.articles.forEach(item => {
          const ligne = document.createElement("tr");
          ligne.innerHTML = `
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.code || ''}"></td>
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.designation || ''}"></td>
            <td class="p-2 text-right"><input type="number" min="0" class="w-full p-1 border rounded text-right" value="${item.qte || 1}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right"><input type="number" step="0.01" class="w-full p-1 border rounded text-right" value="${item.pu || 0}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right total-ligne">0.00</td>
          `;
          document.getElementById("tableau-lignes").appendChild(ligne);
        });
      }
    }
  });
  document.getElementById("crm-resume").innerHTML = resume || "<em>Aucun CRM validé.</em>";
  calculerTotal();
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  if (!client) return;

  const lieu = client.adresses_intervention?.[0];
  document.getElementById("client-coordonnees").innerHTML = `
    <div><strong>Client :</strong> ${client.nom}</div>
    <div><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</div>
    <div><strong>Lieu d’intervention :</strong> ${lieu?.nom || ''} - ${lieu?.rue || ''}, ${lieu?.ville || ''}</div>
  `;
  document.getElementById("lieu-signature").textContent = client.ville || '';
}

function ajouterLigne() {
  const tbody = document.getElementById("tableau-lignes");
  const ligne = document.createElement("tr");
  ligne.innerHTML = `
    <td class="p-2"><input class="w-full p-1 border rounded" placeholder="Code"></td>
    <td class="p-2"><input class="w-full p-1 border rounded" placeholder="Désignation"></td>
    <td class="p-2 text-right"><input type="number" min="0" class="w-full p-1 border rounded text-right" value="1" onchange="calculerTotal()"></td>
    <td class="p-2 text-right"><input type="number" step="0.01" class="w-full p-1 border rounded text-right" value="0" onchange="calculerTotal()"></td>
    <td class="p-2 text-right total-ligne">0.00</td>
  `;
  tbody.appendChild(ligne);
  calculerTotal();
}

function calculerTotal() {
  let totalHT = 0;
  const lignes = document.querySelectorAll("#tableau-lignes tr");
  lignes.forEach(row => {
    const qte = parseFloat(row.cells[2].querySelector("input").value || 0);
    const pu = parseFloat(row.cells[3].querySelector("input").value || 0);
    const total = qte * pu;
    row.cells[4].textContent = total.toFixed(2);
    totalHT += total;
  });
  document.getElementById("montant-ht").value = totalHT.toFixed(2);
  document.getElementById("montant-ttc").value = (totalHT * 1.2).toFixed(2);
}

function genererPDF() {
  alert("Fonction de génération PDF à venir...");
}

window.onload = () => {
const nomClient = new URLSearchParams(window.location.search).get("client") || localStorage.getItem("client_recent");
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  if (!client) return;

  const normaliseNom = client.nom.normalize("NFD").replace(/\p{Diacritic}/gu, "").replace(/\s+/g, '_').toUpperCase();
  const lieu = client.adresses_intervention?.[0];
  document.getElementById("client-coordonnees").innerHTML = `
    <div><strong>Client :</strong> ${client.nom}</div>
    <div><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</div>
    <div><strong>Lieu d’intervention :</strong> ${lieu?.nom || ''} - ${lieu?.rue || ''}, ${lieu?.ville || ''}</div>
  `;
  document.getElementById("lieu-signature").textContent = client.ville || '';

  const crmTypes = ["extincteurs", "baes", "ria", "desenfumage"];
  let resumeHTML = "<h3 class='font-semibold text-sm mb-2'>📋 Résumé des CRM liés</h3>";
  let trouvé = false;

  crmTypes.forEach(type => {
    const key = `crm_${type}_${normaliseNom}`;
    if (localStorage.getItem(key)) {
      trouvé = true;
      const data = JSON.parse(localStorage.getItem(key));
      const emoji = type === "extincteurs" ? "🧯" :
                    type === "baes" ? "💡" :
                    type === "ria" ? "🚿" :
                    type === "desenfumage" ? "💨" : "❓";
      resumeHTML += `<div class="mb-1"><strong>${emoji} ${type.toUpperCase()}</strong><br><span class="ml-2">${data.resume || "—"}</span></div>`;
      if (Array.isArray(data.articles)) {
        data.articles.forEach(item => {
          const ligne = document.createElement("tr");
          ligne.innerHTML = `
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.code || ''}"></td>
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.designation || ''}"></td>
            <td class="p-2 text-right"><input type="number" min="0" class="w-full p-1 border rounded text-right" value="${item.qte || 1}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right"><input type="number" step="0.01" class="w-full p-1 border rounded text-right" value="${item.pu || 0}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right total-ligne">0.00</td>
          `;
          document.getElementById("tableau-lignes").appendChild(ligne);
        });
      }
    }
  });

  document.getElementById("crm-resume").innerHTML = trouvé ? resumeHTML : "<em>Aucun CRM validé pour ce client.</em>";
  calculerTotal();
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  if (!client) return;

  const normaliseNom = client.nom.replace(/\s+/g, '_').toUpperCase();
  const lieu = client.adresses_intervention?.[0];
  document.getElementById("client-coordonnees").innerHTML = `
    <div><strong>Client :</strong> ${client.nom}</div>
    <div><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</div>
    <div><strong>Lieu d’intervention :</strong> ${lieu?.nom || ''} - ${lieu?.rue || ''}, ${lieu?.ville || ''}</div>
  `;
  document.getElementById("lieu-signature").textContent = client.ville || '';

  const crmTypes = ["extincteurs", "baes", "ria", "desenfumage"];
  let resume = "";
  crmTypes.forEach(type => {
    const key = `crm_${type}_${normaliseNom}`;
    if (localStorage.getItem(key)) {
      const data = JSON.parse(localStorage.getItem(key));
      const emoji = type === "extincteurs" ? "🧯" :
                    type === "baes" ? "💡" :
                    type === "ria" ? "🚿" :
                    type === "desenfumage" ? "💨" : "❓";
      if (data.resume) resume += `<div><strong>${emoji} ${type.toUpperCase()}</strong> : ${data.resume}</div>`;
      if (Array.isArray(data.articles)) {
        data.articles.forEach(item => {
          const ligne = document.createElement("tr");
          ligne.innerHTML = `
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.code || ''}"></td>
            <td class="p-2"><input class="w-full p-1 border rounded" value="${item.designation || ''}"></td>
            <td class="p-2 text-right"><input type="number" min="0" class="w-full p-1 border rounded text-right" value="${item.qte || 1}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right"><input type="number" step="0.01" class="w-full p-1 border rounded text-right" value="${item.pu || 0}" onchange="calculerTotal()"></td>
            <td class="p-2 text-right total-ligne">0.00</td>
          `;
          document.getElementById("tableau-lignes").appendChild(ligne);
        });
      }
    }
  });
  document.getElementById("crm-resume").innerHTML = resume || "<em>Aucun CRM validé.</em>";
  calculerTotal();
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  if (!client) return;

  const lieu = client.adresses_intervention?.[0];
  document.getElementById("client-coordonnees").innerHTML = `
    <div><strong>Client :</strong> ${client.nom}</div>
    <div><strong>Adresse :</strong> ${client.rue || ''}, ${client.cp || ''} ${client.ville || ''}</div>
    <div><strong>Lieu d’intervention :</strong> ${lieu?.nom || ''} - ${lieu?.rue || ''}, ${lieu?.ville || ''}</div>
  `;
  document.getElementById("lieu-signature").textContent = client.ville || '';

  const crmKeys = Object.keys(localStorage).filter(k => k.startsWith("crm_") && k.includes(client.nom));
  let resume = "";
  crmKeys.forEach(k => {
    const data = JSON.parse(localStorage.getItem(k));
    const type = k.includes("extincteurs") ? "🧯 Extincteurs" :
                 k.includes("baes") ? "💡 BAES" :
                 k.includes("ria") ? "🚿 RIA" :
                 k.includes("desenfumage") ? "💨 Désenfumage" : "❓ Autre";
    if (data.resume) resume += `<div><strong>${type}</strong> : ${data.resume}</div>`;
    if (Array.isArray(data.articles)) {
      data.articles.forEach(item => {
        const ligne = document.createElement("tr");
        ligne.innerHTML = `
          <td class="p-2"><input class="w-full p-1 border rounded" value="${item.code || ''}"></td>
          <td class="p-2"><input class="w-full p-1 border rounded" value="${item.designation || ''}"></td>
          <td class="p-2 text-right"><input type="number" min="0" class="w-full p-1 border rounded text-right" value="${item.qte || 1}" onchange="calculerTotal()"></td>
          <td class="p-2 text-right"><input type="number" step="0.01" class="w-full p-1 border rounded text-right" value="${item.pu || 0}" onchange="calculerTotal()"></td>
          <td class="p-2 text-right total-ligne">0.00</td>
        `;
        document.getElementById("tableau-lignes").appendChild(ligne);
      });
    }
  });
  document.getElementById("crm-resume").innerHTML = resume || "<em>Aucun CRM validé.</em>";
  calculerTotal();
  chargerCoordonnees();
  document.getElementById("date-signature").textContent = new Date().toLocaleDateString();
};
</script>
</body>
</html>
