<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CRM Extincteurs</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        table tr { 
            cursor: pointer; 
        }
        table tr.active { 
            background: #f5f5f5; 
        }
        .action-buttons { 
            display: none; 
            text-align: right; 
            margin: 8px 0; 
        }
        .action-buttons button { 
            font-size: 14px; 
            padding: 5px; 
            margin-left: 10px; 
            border: none; 
            background: none; 
        }
        .section {
            margin-bottom: 40px; /* Plus d'espace entre les sections */
        }
        table {
            margin-bottom: 40px; /* Plus d'espace sous les tableaux */
        }
        .nav-buttons {
            margin-top: 40px; /* Plus d'espace au-dessus des boutons */
        }
        /* Styles pour le dialogue d'action */
        .action-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-radius: 8px;
        }
        .action-dialog p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        .action-dialog button {
            margin: 0 10px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
        }
        .action-dialog button:first-child { /* Valider modification */
            background-color: #10b981; /* Vert */
            color: #fff;
        }
        .action-dialog button:first-child:hover {
            background-color: #059669;
        }
        .action-dialog button:nth-child(2) { /* Supprimer */
            background-color: #e63946; /* Rouge */
            color: #fff;
        }
        .action-dialog button:nth-child(2):hover {
            background-color: #d00000;
        }
        .action-dialog button:last-child { /* Annuler */
            background-color: #f1f1f1;
            color: #555;
        }
        .action-dialog button:last-child:hover {
            background-color: #e0e0e0;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        @media (max-width: 600px) {
            .action-dialog {
                width: 80%;
            }
            .action-dialog button {
                margin: 5px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• CRM Extincteurs</h1>

        <section class="section">
            <h2>üìã Liste des extincteurs</h2>
            <table id="extincteursTable">
                <thead>
                    <tr>
                        <th>Num√©ro</th>
                        <th>Type</th>
                        <th>Emplacement</th>
                        <th>Date v√©rif.</th>
                        <th>Statut</th>
                    </tr>
                </thead>
                <tbody id="extincteursBody"></tbody>
            </table>
            <div id="actionButtons" class="action-buttons"></div>
            <button class="action" onclick="addExtincteur()">‚ûï Ajouter un extincteur</button>
        </section>

        <section class="section">
            <h2>üìù Formulaire d‚Äôajout/modification</h2>
            <label>Num√©ro: <input type="text" id="numero"></label>
            <label>Type: 
                <select id="type">
                    <option value="">S√©lectionner</option>
                    <option value="Poudre">Poudre</option>
                    <option value="Eau">Eau</option>
                    <option value="CO2">CO2</option>
                </select>
            </label>
            <label>Emplacement: <input type="text" id="emplacement"></label>
            <label>Date de v√©rification: <input type="date" id="dateVerification"></label>
            <label>Statut: 
                <select id="statut">
                    <option value="">S√©lectionner</option>
                    <option value="Conforme">Conforme</option>
                    <option value="√Ä remplacer">√Ä remplacer</option>
                    <option value="En maintenance">En maintenance</option>
                </select>
            </label>
        </section>

        <section class="section">
            <h2>üìÑ R√©sum√© des op√©rations</h2>
            <p id="crmSummary">Aucune op√©ration enregistr√©e.</p>
        </section>

        <section class="section nav-buttons">
            <button class="primary" onclick="validateCRM()">‚úÖ Valider le CRM</button>
            <a href="intervention.html"><button class="neutral">‚¨ÖÔ∏è Retour</button></a>
        </section>

        <div class="navigation nav-buttons">
            <a href="index.html">üè†</a>
            <a href="client.html">üìÅ</a>
            <a href="intervention.html">üõ†Ô∏è</a>
            <a href="parametres.html">‚öôÔ∏è</a>
        </div>
    </div>

    <script>
        window.onload = () => {
            const extincteursData = JSON.parse(localStorage.getItem('extincteursData')) || [];
            const tbody = document.getElementById('extincteursBody');
            extincteursData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.id = `row-${index}`;
                row.innerHTML = `
                    <td><input type="text" class="numero" value="${item.numero || ''}" readonly></td>
                    <td><input type="text" class="type" value="${item.type || ''}" readonly></td>
                    <td><input type="text" class="emplacement" value="${item.emplacement || ''}" readonly></td>
                    <td><input type="text" class="dateVerification" value="${item.dateVerification || ''}" readonly></td>
                    <td><input type="text" class="statut" value="${item.statut || ''}" readonly></td>
                `;
                row.classList.add('active');
                row.onclick = () => showActionDialog(index);
                tbody.appendChild(row);
            });
            updateSummary(); // Mise √† jour du r√©sum√© au chargement
        };

        let activeRow = null;

        function addExtincteur() {
            if (activeRow) {
                alert('Veuillez valider ou supprimer la ligne en cours avant d‚Äôajouter une nouvelle.');
                return;
            }
            const tbody = document.getElementById('extincteursBody');
            const row = document.createElement('tr');
            const index = tbody.children.length;
            row.id = `row-${index}`;
            row.innerHTML = `
                <td><input type="text" class="numero" placeholder="Num√©ro"></td>
                <td><select class="type">
                    <option value="">S√©lectionner</option>
                    <option value="Poudre">Poudre</option>
                    <option value="Eau">Eau</option>
                    <option value="CO2">CO2</option>
                </select></td>
                <td><input type="text" class="emplacement" placeholder="Emplacement"></td>
                <td><input type="date" class="dateVerification"></td>
                <td><select class="statut">
                    <option value="">S√©lectionner</option>
                    <option value="Conforme">Conforme</option>
                    <option value="√Ä remplacer">√Ä remplacer</option>
                    <option value="En maintenance">En maintenance</option>
                </select></td>
            `;
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="validate-btn" onclick="validateRow(this.parentElement.parentElement, this.parentElement)" title="Valider"><i class="fas fa-check-circle"></i></button>
                <button class="delete-btn" onclick="deleteRow(this.parentElement.parentElement)" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
            `;
            tbody.appendChild(row);
            row.appendChild(actionDiv);
            activeRow = row;
            actionDiv.style.display = 'block';
        }

        function validateRow(row, actionDiv) {
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.readOnly = true;
                    input.disabled = true; // D√©sactiver les selects pour qu'ils soient en lecture seule
                } else {
                    input.readOnly = true;
                }
            });
            row.classList.add('active');
            actionDiv.style.display = 'none';
            activeRow = null;
            row.onclick = () => showActionDialog(row.id.split('-')[1]);
            updateSummary();
        }

        function deleteRow(row) {
            row.remove();
            activeRow = null;
            updateSummary();
        }

        function showActionDialog(index) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'action-dialog';
            dialog.innerHTML = `
                <p>Que voulez-vous faire ?</p>
                <button onclick="editRow(this.parentElement, ${index})">Valider modification</button>
                <button onclick="deleteRowWithDialog(this.parentElement, ${index})">Supprimer</button>
                <button onclick="closeDialog(this.parentElement)">Annuler</button>
            `;
            document.body.appendChild(dialog);
        }

        function editRow(dialog, index) {
            if (activeRow) {
                alert('Veuillez valider ou supprimer la ligne en cours avant de modifier une autre.');
                closeDialog(dialog);
                return;
            }
            const row = document.getElementById(`row-${index}`);
            const inputs = row.querySelectorAll('input, select');
            inputs.forEach(input => {
                if (input.tagName === 'SELECT') {
                    input.readOnly = false;
                    input.disabled = false; // R√©activer les selects pour modification
                } else {
                    input.readOnly = false;
                }
            });
            activeRow = row;
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="validate-btn" onclick="validateRow(this.parentElement.parentElement, this.parentElement)" title="Valider"><i class="fas fa-check-circle"></i></button>
                <button class="delete-btn" onclick="deleteRow(this.parentElement.parentElement)" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
            `;
            row.appendChild(actionDiv);
            actionDiv.style.display = 'block';
            row.classList.remove('active');
            closeDialog(dialog);
        }

        function deleteRowWithDialog(dialog, index) {
            const row = document.getElementById(`row-${index}`);
            row.remove();
            activeRow = null;
            updateSummary();
            closeDialog(dialog);
        }

        function closeDialog(dialog) {
            dialog.previousElementSibling.remove();
            dialog.remove();
        }

        function updateSummary() {
            const extincteursData = [];
            document.querySelectorAll('#extincteursBody tr').forEach(row => {
                const extincteur = {
                    numero: row.querySelector('.numero').value,
                    type: row.querySelector('.type').value,
                    emplacement: row.querySelector('.emplacement').value,
                    dateVerification: row.querySelector('.dateVerification').value,
                    statut: row.querySelector('.statut').value
                };
                extincteursData.push(extincteur);
            });
            const summary = extincteursData.length > 0 
                ? `${extincteursData.length} extincteur(s) enregistr√©(s).`
                : 'Aucune op√©ration enregistr√©e.';
            document.getElementById('crmSummary').textContent = summary;
            localStorage.setItem('extincteursData', JSON.stringify(extincteursData));
        }

        function validateCRM() {
            const extincteursData = [];
            document.querySelectorAll('#extincteursBody tr').forEach(row => {
                const extincteur = {
                    numero: row.querySelector('.numero').value,
                    type: row.querySelector('.type').value,
                    emplacement: row.querySelector('.emplacement').value,
                    dateVerification: row.querySelector('.dateVerification').value,
                    statut: row.querySelector('.statut').value
                };
                if (extincteur.numero && extincteur.type && extincteur.emplacement && extincteur.dateVerification && extincteur.statut) {
                    extincteursData.push(extincteur);
                }
            });

            if (extincteursData.length === 0) {
                alert("Ajoutez au moins un extincteur valide.");
                return;
            }

            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            drafts['crm_extincteurs'] = extincteursData;
            localStorage.setItem('drafts', JSON.stringify(drafts));

            const summary = `${extincteursData.length} extincteur(s) enregistr√©(s).`;
            localStorage.setItem('crm_summary', summary);

            alert('CRM valid√© et sauvegard√© !');
            window.location.href = 'intervention.html';
        }
    </script>
</body>
</html>