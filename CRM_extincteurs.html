<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compte-rendu Extincteurs</title>
    <link rel="stylesheet" href="css/styles.css">
</head>
<body>
    <div class="container">
        <h1>Compte-rendu Extincteurs</h1>

        <section class="section">
            <h2>ğŸ§¾ Client</h2>
            <label>Nom client: <input type="text" id="clientName" placeholder="Nom du client" required></label>
            <label>Lieu dâ€™intervention: <input type="text" id="lieu" placeholder="Lieu dâ€™intervention"></label>
        </section>

        <section class="section">
            <h2>ğŸ“… DÃ©tails de lâ€™intervention</h2>
            <label>Date dâ€™intervention: <input type="date" id="interventionDate" value="2025-05-15" required></label>
            <label>Technicien intervenant: <input type="text" id="technician" placeholder="Nom du technicien"></label>
        </section>

        <section class="section">
            <h2>ğŸ§¯ Extincteurs</h2>
            <button onclick="addExtincteur()">â• Ajouter un extincteur</button>
            <div id="extincteursList"></div>
            <p id="extincteurError" class="error" style="display: none;">Veuillez ajouter au moins un extincteur.</p>
        </section>

        <section class="section">
            <h2>âœ… Devoir de conseil</h2>
            <label><input type="checkbox" id="registre"> Registre prÃ©sent et Ã  jour</label>
            <label><input type="checkbox" id="signaletique"> SignalÃ©tique Ã  jour</label>
            <label><input type="checkbox" id="baes"> BAES prÃ©sents</label>
            <label><input type="checkbox" id="plans"> Plans de sÃ©curitÃ© prÃ©sents et Ã  jour</label>
        </section>

        <section class="section">
            <h2>ğŸ“ Points Ã  amÃ©liorer / Observations</h2>
            <textarea id="observations" rows="4" placeholder="Notes sur l'intervention..."></textarea>
        </section>

        <section class="section">
            <button onclick="validateCRM()">âœ… Valider le compte rendu</button>
            <a href="bon_intervention.html"><button>â¡ï¸ Passer au bon dâ€™intervention</button></a>
            <a href="intervention.html"><button>â¬…ï¸ Retour Ã  lâ€™intervention</button></a>
        </section>

        <div class="navigation">
            <a href="index.html">ğŸ  Accueil</a>
            <a href="client.html">ğŸ“ Clients</a>
            <a href="intervention.html">ğŸ› ï¸ Intervention</a>
            <a href="CRM_ria.html">ğŸš¿ RIA</a>
            <a href="CRM_baes.html">ğŸ’¡ BAES</a>
            <a href="CRM_desenfumage.html">ğŸ’¨ DÃ©senfumage</a>
        </div>
    </div>

    <script>
        let extincteurCount = 0;

        // PrÃ©-remplir client et lieu depuis localStorage
        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (interventionData.client) {
                document.getElementById('clientName').value = interventionData.client;
            }
            if (interventionData.lieu) {
                document.getElementById('lieu').value = interventionData.lieu;
            }
        };

        function addExtincteur() {
            extincteurCount++;
            const div = document.createElement('div');
            div.className = 'extincteur';
            div.innerHTML = `
                <h3>Extincteur #${extincteurCount}</h3>
                <label>NÂ° extincteur: <input type="text" class="num" value="EXT-${extincteurCount}"></label>
                <label>Type d'extincteur: <input type="text" class="type" placeholder="Eau, CO2, etc."></label>
                <label>Ext. PP ? <input type="checkbox" class="pp"></label>
                <label>Fabricant: <input type="text" class="fabricant" placeholder="Nom du fabricant"></label>
                <label>MillÃ©sime: <input type="text" class="millesime" placeholder="AnnÃ©e"></label>
                <label>Niveau: <input type="text" class="niveau" placeholder="Bon, Moyen, Mauvais"></label>
                <label>Emplacement: <input type="text" class="emplacement" placeholder="Ex. Hall principal"></label>
                <h4>OpÃ©rations effectuÃ©es</h4>
                <label><input type="checkbox" class="op-verif"> VÃ©rification OK</label>
                <label><input type="checkbox" class="op-quinquennale"> RÃ©vision quinquennale</label>
                <label><input type="checkbox" class="op-recharge"> RechargÃ©</label>
                <label><input type="checkbox" class="op-mise-service"> Mise en service</label>
                <label><input type="checkbox" class="op-echange"> Ã‰change standard</label>
                <label>Observation: <textarea class="observation" rows="2"></textarea></label>
                <button onclick="this.parentElement.remove(); updateSummary()">Supprimer</button>
            `;
            document.getElementById('extincteursList').appendChild(div);
            updateSummary();
        }

        function updateSummary() {
            const extincteurs = document.querySelectorAll('.extincteur');
            let summary = 'RÃ©sumÃ© des extincteurs:\n';
            extincteurs.forEach((e, i) => {
                const num = e.querySelector('.num').value;
                const type = e.querySelector('.type').value;
                const emplacement = e.querySelector('.emplacement').value;
                const ops = Array.from(e.querySelectorAll('input[type="checkbox"]'))
                    .filter(cb => cb.checked)
                    .map(cb => cb.className.split('-')[1].charAt(0).toUpperCase())
                    .join('');
                summary += `${num} - ${type} (${emplacement}) [${ops}]\n`;
            });
            return summary;
        }

        function validateCRM() {
            // Validation des champs obligatoires
            const client = document.getElementById('clientName').value;
            const date = document.getElementById('interventionDate').value;
            const extincteurs = document.querySelectorAll('.extincteur');

            if (!client) {
                alert('Le nom du client est obligatoire.');
                return;
            }
            if (!date) {
                alert('La date dâ€™intervention est obligatoire.');
                return;
            }
            if (extincteurs.length === 0) {
                document.getElementById('extincteurError').style.display = 'block';
                return;
            }

            const summary = updateSummary();
            const observations = document.getElementById('observations').value;
            const devoirConseil = {
                registre: document.getElementById('registre').checked,
                signaletique: document.getElementById('signaletique').checked,
                baes: document.getElementById('baes').checked,
                plans: document.getElementById('plans').checked
            };
            const crmData = {
                client: client,
                lieu: document.getElementById('lieu').value,
                date: date,
                technician: document.getElementById('technician').value,
                summary: summary,
                observations: observations,
                devoirConseil: devoirConseil
            };

            // Sauvegarde comme brouillon
            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            drafts['crm_extincteurs'] = crmData;
            localStorage.setItem('drafts', JSON.stringify(drafts));

            // Mise Ã  jour de lâ€™intervention en cours
            let interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            interventionData.crm_extincteurs = crmData;
            localStorage.setItem('currentIntervention', JSON.stringify(interventionData));

            alert('Compte-rendu validÃ© et sauvegardÃ© !');
        }
    </script>
</body>
</html>