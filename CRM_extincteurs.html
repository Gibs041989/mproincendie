<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
    <title>Compte-rendu Extincteurs - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .extincteur { 
            border: 1px solid #ddd; 
            padding: 15px; 
            margin: 15px 0; 
            border-radius: 8px; 
            background-color: #f9f9f9; 
        }
        .extincteur h3 { 
            margin-top: 0; 
            color: #c62828; 
        }
        .summary { 
            margin-top: 10px; 
            padding: 10px; 
            background-color: #e0f7fa; 
            border-radius: 4px; 
            cursor: pointer; 
            transition: background-color 0.3s ease; 
        }
        .summary:hover { 
            background-color: #b3e5fc; 
        }
        .summary-content { 
            display: flex; 
            align-items: center; 
            gap: 5px; 
        }
        .summary-content::before { 
            content: "üßØ"; 
        }
        .footer-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: #f5f5f5; 
            padding: 10px 0; 
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); 
            z-index: 1000; 
        }
        .footer-nav .navigation { 
            margin: 0; 
            display: flex; 
            flex-direction: row; 
            flex-wrap: nowrap; 
            justify-content: space-around; 
            align-items: center; 
            gap: 20px; 
        }
        .footer-nav a { 
            flex: 1; 
            text-align: center; 
            padding: 10px; 
            font-size: 22px; 
            background-color: transparent; 
            border-radius: 8px; 
            transition: background-color 0.3s ease; 
        }
        .footer-nav a:hover { 
            background-color: #ffebee; 
        }
        .checkbox-container { 
            display: flex; 
            align-items: center; 
            padding: 8px; 
            margin: 5px 0; 
            border: 1px solid #ddd; 
            border-radius: 4px; 
            background-color: #fff; 
            cursor: pointer; 
            transition: background-color 0.3s ease; 
        }
        .checkbox-container:hover { 
            background-color: #f0f0f0; 
        }
        .checkbox-container.checked { 
            background-color: #e0f7fa; 
        }
        .checkbox-container label { 
            margin: 0; 
            font-weight: normal; 
            white-space: nowrap; 
        }
        .checkbox-container input { 
            margin-left: auto; 
            width: 20px; 
            height: 20px; 
        }
        .custom-input { 
            display: none; 
            margin-top: 5px; 
        }
        .extincteur-counter { 
            font-style: italic; 
            color: #666; 
            margin-top: 5px; 
        }
        .error-message { 
            color: #d32f2f; 
            font-size: 0.9em; 
            margin-top: 5px; 
            display: none; 
        }
        .extincteur .form-content { 
            display: block; 
        }
        .extincteur .form-content.hidden { 
            display: none; 
        }
        .extincteur .form-content.read-only input,
        .extincteur .form-content.read-only select,
        .extincteur .form-content.read-only textarea,
        .extincteur .form-content.read-only .checkbox-container input {
            background-color: #e0e0e0;
            pointer-events: none;
        }
        .extincteur .form-content.read-only button { 
            display: none; 
        }
        .action-dialog {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: #fff;
            border: 1px solid #ddd;
            padding: 20px;
            z-index: 1000;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            text-align: center;
            border-radius: 8px;
            min-width: 300px;
        }
        .action-dialog p {
            margin-bottom: 15px;
            font-size: 16px;
        }
        .action-dialog button {
            margin: 0 10px;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 14px;
            cursor: pointer;
            transition: background-color 0.3s ease;
            display: inline-block;
        }
        .action-dialog button:first-child {
            background-color: #10b981;
            color: #fff;
        }
        .action-dialog button:first-child:hover {
            background-color: #059669;
        }
        .action-dialog button:nth-child(2) {
            background-color: #e63946;
            color: #fff;
        }
        .action-dialog button:nth-child(2):hover {
            background-color: #d00000;
        }
        .action-dialog button:last-child {
            background-color: #f1f1f1;
            color: #555;
        }
        .action-dialog button:last-child:hover {
            background-color: #e0e0e0;
        }
        .overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
        }
        .section {
            margin-bottom: 40px;
        }
        .nav-buttons {
            margin-top: 40px;
            padding-bottom: 60px;
        }
        @media (max-width: 600px) {
            .nav-buttons a, .nav-buttons button { 
                flex: 1 1 100%; 
                padding: 12px; 
                font-size: 20px; 
            }
            .extincteur { 
                padding: 12px; 
            }
            .footer-nav a { 
                font-size: 24px; 
                padding: 10px; 
            }
            .checkbox-container { 
                padding: 8px; 
            }
            .checkbox-container label { 
                font-size: 18px; 
            }
            .checkbox-container input { 
                width: 28px; 
                height: 28px; 
            }
            .summary { 
                padding: 10px; 
                font-size: 18px; 
            }
            .action-dialog {
                width: 90%;
                min-width: 280px;
            }
            .action-dialog button {
                margin: 5px;
                padding: 6px 12px;
                font-size: 12px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <section class="section">
            <h2>üßæ Client</h2>
            <p><strong>Client:</strong> <span id="clientName">Non s√©lectionn√©</span></p>
            <p><strong>Lieu d‚Äôintervention:</strong> <span id="lieu">Non s√©lectionn√©</span></p>
        </section>

        <section class="section">
            <h2>üìÖ D√©tails de l‚Äôintervention</h2>
            <label>Date d‚Äôintervention: <input type="date" id="interventionDate" required></label>
            <span class="error-message" id="dateError">Veuillez indiquer une date</span>
            <label>Technicien intervenant: <input type="text" id="technician" placeholder="Nom du technicien"></label>
        </section>

        <section class="section">
            <h2>üßØ Extincteurs</h2>
            <div id="extincteursList"></div>
            <p class="extincteur-counter" id="extincteurCounter">Extincteurs valid√©s : 0</p>
            <button class="action" onclick="addExtincteur()">‚ûï Ajouter un extincteur</button>
            <p id="extincteurError" class="error-message">Veuillez ajouter au moins un extincteur.</p>
        </section>

        <section class="section">
            <h2>‚úÖ Devoir de conseil</h2>
            <div class="checkbox-container">
                <label for="registre">Registre pr√©sent et √† jour</label>
                <input type="checkbox" id="registre" onchange="updateCheckboxStyle(this)">
            </div>
            <div class="checkbox-container">
                <label for="signaletique">Signal√©tique √† jour</label>
                <input type="checkbox" id="signaletique" onchange="updateCheckboxStyle(this)">
            </div>
            <div class="checkbox-container">
                <label for="baes">BAES pr√©sents</label>
                <input type="checkbox" id="baes" onchange="updateCheckboxStyle(this)">
            </div>
            <div class="checkbox-container">
                <label for="plans">Plans de s√©curit√© pr√©sents et √† jour</label>
                <input type="checkbox" id="plans" onchange="updateCheckboxStyle(this)">
            </div>
        </section>

        <section class="section">
            <h2>üìù Observations g√©n√©rales</h2>
            <textarea id="observations" rows="4" placeholder="Notes sur l'intervention..."></textarea>
        </section>

        <section class="section nav-buttons">
            <button class="primary" onclick="validateCRM()">‚úÖ Valider le compte rendu</button>
            <a href="bon_intervention.html"><button class="action">‚û°Ô∏è Passer au bon d‚Äôintervention</button></a>
        </section>
    </div>

    <div class="footer-nav">
        <div class="navigation nav-buttons">
            <a href="index.html">üè†</a>
            <a href="crm_extincteurs.html">üßØ</a>
            <a href="crm_ria.html">üöø</a>
            <a href="crm_baes.html">üí°</a>
            <a href="crm_desenfumage.html">üí®</a>
        </div>
    </div>

    <script>
        let extincteurCount = 0;
        let extincteursValides = JSON.parse(localStorage.getItem('extincteursValides')) || {};

        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (!interventionData || !interventionData.client) {
                alert('Aucun client s√©lectionn√©. Veuillez choisir un client depuis la page Interventions.');
                window.location.href = 'intervention.html';
                return;
            }
            document.getElementById('clientName').textContent = interventionData.client || 'Non s√©lectionn√©';
            document.getElementById('lieu').textContent = interventionData.lieu || 'Non s√©lectionn√©';
            document.getElementById('interventionDate').value = interventionData.date || '';
            document.getElementById('technician').value = interventionData.technician || '';
            document.getElementById('observations').value = interventionData.observations || '';
            if (interventionData.devoirConseil) {
                document.getElementById('registre').checked = interventionData.devoirConseil.registre;
                document.getElementById('signaletique').checked = interventionData.devoirConseil.signaletique;
                document.getElementById('baes').checked = interventionData.devoirConseil.baes;
                document.getElementById('plans').checked = interventionData.devoirConseil.plans;
                document.querySelectorAll('.checkbox-container input').forEach(cb => updateCheckboxStyle(cb));
            }
            loadExtincteurs();
            saveDraft(); // Sauvegarde initiale
        };

        function addExtincteur() {
            extincteurCount++;
            const div = document.createElement('div');
            div.className = 'extincteur';
            div.id = `extincteur-${extincteurCount}`;
            div.innerHTML = `
                <div class="form-content">
                    <h3>üßØ Nouvel extincteur #${extincteurCount}</h3>
                    <label>N¬∞ extincteur: <input type="text" class="num" value="EXT-${extincteurCount}"></label>
                    <label>Type d'extincteur: 
                        <select class="type" onchange="toggleCustomInput(this, 'customType-${extincteurCount}')">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Eau 6L">Eau 6L</option>
                            <option value="CO2 2kg">CO2 2kg</option>
                            <option value="Poudre 5kg">Poudre 5kg</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <input type="text" class="custom-input customType-${extincteurCount}" placeholder="Type personnalis√©">
                    </label>
                    <label>Ext. PP ? <input type="checkbox" id="pp-${extincteurCount}" class="pp" onchange="updateCheckboxStyle(this)"></label>
                    <label>Fabricant: 
                        <select class="fabricant" onchange="toggleCustomInput(this, 'customFabricant-${extincteurCount}')">
                            <option value="">-- S√©lectionner --</option>
                            <option value="Desautel">Desautel</option>
                            <option value="Kidde">Kidde</option>
                            <option value="Sicli">Sicli</option>
                            <option value="Autre">Autre</option>
                        </select>
                        <input type="text" class="custom-input customFabricant-${extincteurCount}" placeholder="Fabricant personnalis√©">
                    </label>
                    <label>Mill√©sime: 
                        <select class="millesime" onchange="toggleCustomInput(this, 'customMillesime-${extincteurCount}')">
                            <option value="">-- S√©lectionner --</option>
                            ${Array.from({length: 11}, (_, i) => 2015 + i).map(year => `<option value="${year}">${year}</option>`).join('')}
                            <option value="Autre">Autre</option>
                        </select>
                        <input type="text" class="custom-input customMillesime-${extincteurCount}" placeholder="Ann√©e personnalis√©e">
                    </label>
                    <label>√âtage: <input type="text" class="etage" placeholder="Ex. Rez-de-chauss√©e, 1er √©tage"></label>
                    <label>Emplacement: <input type="text" class="emplacement" placeholder="Ex. Hall principal"></label>
                    <h4 class="operations-title">Op√©rations effectu√©es</h4>
                    <div class="checkbox-container">
                        <label for="op-verif-${extincteurCount}">V√©rification OK</label>
                        <input type="checkbox" id="op-verif-${extincteurCount}" class="op-verif" onchange="updateCheckboxStyle(this)">
                    </div>
                    <div class="checkbox-container">
                        <label for="op-quinquennale-${extincteurCount}">R√©vision quinquennale</label>
                        <input type="checkbox" id="op-quinquennale-${extincteurCount}" class="op-quinquennale" onchange="updateCheckboxStyle(this)">
                    </div>
                    <div class="checkbox-container">
                        <label for="op-recharge-${extincteurCount}">Recharg√©</label>
                        <input type="checkbox" id="op-recharge-${extincteurCount}" class="op-recharge" onchange="updateCheckboxStyle(this)">
                    </div>
                    <div class="checkbox-container">
                        <label for="op-mise-service-${extincteurCount}">Mise en service</label>
                        <input type="checkbox" id="op-mise-service-${extincteurCount}" class="op-mise-service" onchange="updateCheckboxStyle(this)">
                    </div>
                    <div class="checkbox-container">
                        <label for="op-echange-${extincteurCount}">√âchange standard</label>
                        <input type="checkbox" id="op-echange-${extincteurCount}" class="op-echange" onchange="updateCheckboxStyle(this)">
                    </div>
                    <label>Observation: <textarea class="observation" rows="2"></textarea></label>
                    <button class="action" onclick="validateExtincteur(${extincteurCount})">‚úÖ Valider extincteur</button>
                    <button class="secondary" onclick="removeExtincteur(${extincteurCount})">üóëÔ∏è Supprimer</button>
                    <p class="error-message" id="error-${extincteurCount}"></p>
                </div>
                <div class="summary hidden" id="summary-${extincteurCount}" onclick="showActionDialog(${extincteurCount})">
                    <div class="summary-content"></div>
                </div>
            `;
            document.getElementById('extincteursList').appendChild(div);
            div.querySelectorAll('.checkbox-container').forEach(container => {
                container.addEventListener('click', (e) => {
                    const checkbox = container.querySelector('input[type="checkbox"]');
                    if (e.target !== checkbox && !container.closest('.form-content').classList.contains('read-only')) {
                        checkbox.click();
                    }
                });
            });
            saveDraft();
        }

        function toggleCustomInput(select, inputId) {
            const input = document.querySelector(`.${inputId}`);
            if (select.value === 'Autre') {
                input.style.display = 'block';
                input.classList.add('visible');
            } else {
                input.style.display = 'none';
                input.classList.remove('visible');
                input.value = '';
            }
            saveDraft();
        }

        function updateCheckboxStyle(checkbox) {
            const container = checkbox.closest('.checkbox-container');
            if (checkbox.checked) {
                container.classList.add('checked');
            } else {
                container.classList.remove('checked');
            }
            saveDraft();
        }

        function showActionDialog(id) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'action-dialog';
            dialog.innerHTML = `
                <p>Que voulez-vous faire ?</p>
                <button onclick="openExtincteurForm(${id})">‚úèÔ∏è Modifier</button>
                <button onclick="removeExtincteurWithDialog(${id})">üóëÔ∏è Supprimer</button>
                <button onclick="closeDialog(this.parentElement)">Annuler</button>
            `;
            document.body.appendChild(dialog);
        }

        function openExtincteurForm(id) {
            closeDialog(document.querySelector('.action-dialog'));
            const extincteur = document.getElementById(`extincteur-${id}`);
            const formContent = extincteur.querySelector('.form-content');
            formContent.classList.remove('hidden', 'read-only');
            extincteur.querySelectorAll('input, select, textarea').forEach(elem => {
                elem.removeAttribute('readonly');
                elem.removeAttribute('disabled');
                elem.style.pointerEvents = 'auto';
            });
            extincteur.querySelectorAll('.checkbox-container input').forEach(cb => {
                cb.removeAttribute('disabled');
                cb.style.pointerEvents = 'auto';
                updateCheckboxStyle(cb);
            });
            const validateButton = extincteur.querySelector('button[onclick^="validateExtincteur"], button[onclick^="updateExtincteur"]');
            if (validateButton) {
                validateButton.textContent = '‚úÖ Valider modification';
                validateButton.setAttribute('onclick', `updateExtincteur(${id})`);
                validateButton.style.display = 'inline';
            }
            extincteur.querySelector('button[onclick^="removeExtincteur"]').style.display = 'inline';
        }

        function validateExtincteur(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            const formContent = extincteur.querySelector('.form-content');
            const summaryDiv = document.getElementById(`summary-${id}`);
            const errorDiv = document.getElementById(`error-${id}`);
            errorDiv.style.display = 'none';
            errorDiv.textContent = '';

            const num = extincteur.querySelector('.num').value;
            const typeSelect = extincteur.querySelector('.type');
            const type = typeSelect.value === 'Autre' ? extincteur.querySelector(`.customType-${id}`).value : typeSelect.value;
            const fabricantSelect = extincteur.querySelector('.fabricant');
            const fabricant = fabricantSelect.value === 'Autre' ? extincteur.querySelector(`.customFabricant-${id}`).value : fabricantSelect.value;
            const millesimeSelect = extincteur.querySelector('.millesime');
            const millesime = millesimeSelect.value === 'Autre' ? extincteur.querySelector(`.customMillesime-${id}`).value : millesimeSelect.value;
            const etage = extincteur.querySelector('.etage').value;
            const emplacement = extincteur.querySelector('.emplacement').value;
            const observation = extincteur.querySelector('.observation').value.trim();

            if (!num || !type || !millesime || !etage || !emplacement) {
                errorDiv.textContent = 'Veuillez remplir tous les champs obligatoires : N¬∞ Extincteur, Type, Mill√©sime, √âtage, Emplacement.';
                errorDiv.style.display = 'block';
                return;
            }

            const operations = Array.from(extincteur.querySelectorAll('input[type="checkbox"]'))
                .filter(cb => cb.checked && cb.className !== 'pp');
            if (operations.length === 0 && observation === '') {
                errorDiv.textContent = 'Veuillez cocher au moins une op√©ration ou ajouter une observation.';
                errorDiv.style.display = 'block';
                return;
            }

            const pp = extincteur.querySelector('.pp').checked ? 'PP' : '';
            const ops = operations.map(cb => {
                if (cb.className.includes('verif')) return '[VF]';
                if (cb.className.includes('recharge')) return '[RE]';
                if (cb.className.includes('quinquennale')) return '[RQ]';
                if (cb.className.includes('echange')) return '[ES]';
                if (cb.className.includes('mise-service')) return '[MES]';
                return '';
            }).join('');

            const summary = `${num} - ${type} (${emplacement}) ${ops}${pp ? `[${pp}]` : ''}`;
            summaryDiv.querySelector('.summary-content').textContent = summary;
            summaryDiv.classList.remove('hidden');
            formContent.classList.add('hidden');

            extincteursValides[id] = {
                id: num,
                type: type,
                pp: pp,
                fabricant: fabricant,
                millesime: millesime,
                etage: etage,
                emplacement: emplacement,
                operations: ops,
                observation: observation
            };

            updateExtincteurCounter();
            localStorage.setItem('extincteursValides', JSON.stringify(extincteursValides));
            saveDraft();
        }

        function updateExtincteur(id) {
            validateExtincteur(id); // R√©utilise la logique de validation
        }

        function removeExtincteurWithDialog(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            if (extincteur) {
                extincteur.remove();
                delete extincteursValides[id];
                updateExtincteurCounter();
                localStorage.setItem('extincteursValides', JSON.stringify(extincteursValides));
                saveDraft();
            }
            closeDialog(document.querySelector('.action-dialog'));
        }

        function removeExtincteur(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            if (extincteur) {
                extincteur.remove();
                delete extincteursValides[id];
                updateExtincteurCounter();
                localStorage.setItem('extincteursValides', JSON.stringify(extincteursValides));
                saveDraft();
            }
        }

        function closeDialog(dialog) {
            if (dialog) {
                const overlay = dialog.previousElementSibling;
                if (overlay && overlay.className === 'overlay') {
                    overlay.remove();
                }
                dialog.remove();
            }
        }

        function updateExtincteurCounter() {
            const count = Object.keys(extincteursValides).length;
            document.getElementById('extincteurCounter').textContent = `Extincteurs valid√©s : ${count}`;
        }

        function loadExtincteurs() {
            Object.entries(extincteursValides).forEach(([id, ext]) => {
                extincteurCount = Math.max(extincteurCount, parseInt(id));
                addExtincteur();
                const extincteur = document.getElementById(`extincteur-${id}`);
                extincteur.querySelector('.num').value = ext.num;
                const typeSelect = extincteur.querySelector('.type');
                if (['Eau 6L', 'CO2 2kg', 'Poudre 5kg'].includes(ext.type)) {
                    typeSelect.value = ext.type;
                } else {
                    typeSelect.value = 'Autre';
                    extincteur.querySelector(`.customType-${id}`).value = ext.type;
                    extincteur.querySelector(`.customType-${id}`).style.display = 'block';
                }
                extincteur.querySelector(`#pp-${id}`).checked = ext.pp === 'PP';
                const fabricantSelect = extincteur.querySelector('.fabricant');
                if (['Desautel', 'Kidde', 'Sicli'].includes(ext.fabricant)) {
                    fabricantSelect.value = ext.fabricant;
                } else {
                    fabricantSelect.value = 'Autre';
                    extincteur.querySelector(`.customFabricant-${id}`).value = ext.fabricant;
                    extincteur.querySelector(`.customFabricant-${id}`).style.display = 'block';
                }
                const millesimeSelect = extincteur.querySelector('.millesime');
                if (ext.millesime >= 2015 && ext.millesime <= 2025) {
                    millesimeSelect.value = ext.millesime;
                } else {
                    millesimeSelect.value = 'Autre';
                    extincteur.querySelector(`.customMillesime-${id}`).value = ext.millesime;
                    extincteur.querySelector(`.customMillesime-${id}`).style.display = 'block';
                }
                extincteur.querySelector('.etage').value = ext.etage;
                extincteur.querySelector('.emplacement').value = ext.emplacement;
                extincteur.querySelector('.observation').value = ext.observation;
                if (ext.operations.includes('[VF]')) extincteur.querySelector(`#op-verif-${id}`).checked = true;
                if (ext.operations.includes('[RQ]')) extincteur.querySelector(`#op-quinquennale-${id}`).checked = true;
                if (ext.operations.includes('[RE]')) extincteur.querySelector(`#op-recharge-${id}`).checked = true;
                if (ext.operations.includes('[MES]')) extincteur.querySelector(`#op-mise-service-${id}`).checked = true;
                if (ext.operations.includes('[ES]')) extincteur.querySelector(`#op-echange-${id}`).checked = true;
                extincteur.querySelectorAll('.checkbox-container input').forEach(cb => updateCheckboxStyle(cb));
                validateExtincteur(id);
            });
        }

        function saveDraft() {
            const crmData = {
                client: document.getElementById('clientName').textContent,
                lieu: document.getElementById('lieu').textContent,
                date: document.getElementById('interventionDate').value,
                technician: document.getElementById('technician').value,
                extincteurs: Object.values(extincteursValides),
                observations: document.getElementById('observations').value,
                devoirConseil: {
                    registre: document.getElementById('registre').checked,
                    signaletique: document.getElementById('signaletique').checked,
                    baes: document.getElementById('baes').checked,
                    plans: document.getElementById('plans').checked
                },
                timestamp: new Date().toISOString()
            };
            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            drafts['crm_extincteurs'] = crmData;
            localStorage.setItem('drafts', JSON.stringify(drafts));
            let interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            interventionData.crm_extincteurs = crmData;
            localStorage.setItem('currentIntervention', JSON.stringify(interventionData));
        }

        function validateCRM() {
            const client = document.getElementById('clientName').textContent;
            const date = document.getElementById('interventionDate').value;
            const extincteurs = Object.values(extincteursValides);

            let isValid = true;
            document.getElementById('dateError').style.display = 'none';
            document.getElementById('extincteurError').style.display = 'none';
            document.getElementById('interventionDate').classList.remove('error');

            if (!client || client === 'Non s√©lectionn√©') {
                alert('Le nom du client est obligatoire.');
                isValid = false;
            }
            if (!date) {
                document.getElementById('dateError').style.display = 'block';
                document.getElementById('interventionDate').classList.add('error');
                isValid = false;
            }
            if (extincteurs.length === 0) {
                document.getElementById('extincteurError').style.display = 'block';
                isValid = false;
            }

            if (isValid) {
                const crmData = {
                    client: client,
                    lieu: document.getElementById('lieu').textContent,
                    date: date,
                    technician: document.getElementById('technician').value,
                    extincteurs: extincteurs,
                    observations: document.getElementById('observations').value,
                    devoirConseil: {
                        registre: document.getElementById('registre').checked,
                        signaletique: document.getElementById('signaletique').checked,
                        baes: document.getElementById('baes').checked,
                        plans: document.getElementById('plans').checked
                    },
                    timestamp: new Date().toISOString()
                };

                // Enregistrement dans l'historique client
                let clientHistory = JSON.parse(localStorage.getItem('clientHistory')) || {};
                const clientId = JSON.parse(localStorage.getItem('currentIntervention'))?.clientId || client;
                if (!clientHistory[clientId]) clientHistory[clientId] = [];
                clientHistory[clientId].push(crmData);
                localStorage.setItem('clientHistory', JSON.stringify(clientHistory));

                // Mise √† jour de currentIntervention
                let interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
                interventionData.crm_extincteurs = crmData;
                localStorage.setItem('currentIntervention', JSON.stringify(interventionData));

                // Nettoyage des brouillons
                let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
                delete drafts['crm_extincteurs'];
                localStorage.setItem('drafts', JSON.stringify(drafts));
                localStorage.removeItem('extincteursValides');

                alert('Compte-rendu valid√© avec succ√®s !');
                window.location.href = 'bon_intervention.html';
            }
        }

        document.querySelectorAll('.checkbox-container').forEach(container => {
            container.addEventListener('click', (e) => {
                const checkbox = container.querySelector('input[type="checkbox"]');
                if (e.target !== checkbox && !container.closest('.form-content').classList.contains('read-only')) {
                    checkbox.click();
                }
            });
        });
    </script>
</body>
</html>
