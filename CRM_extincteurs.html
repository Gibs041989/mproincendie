<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Compte-rendu Extincteurs - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .extincteur { border: 1px solid #ddd; padding: 15px; margin: 10px 0; border-radius: 8px; background-color: #f9f9f9; }
        .extincteur h3 { margin-top: 0; color: #c62828; }
        .summary { margin-top: 10px; padding: 10px; background-color: #e0f7fa; border-radius: 4px; cursor: pointer; transition: background-color 0.3s ease; }
        .summary:hover { background-color: #b3e5fc; }
        .summary-content { display: flex; align-items: center; gap: 5px; }
        .summary-content::before { content: "üßØ"; }
        .edit-buttons { display: none; margin-top: 5px; }
        .nav-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .nav-buttons a, .nav-buttons button { flex: 1 1 150px; text-align: center; padding: 12px; font-size: 16px; }
        .footer-nav { position: fixed; bottom: 0; left: 0; right: 0; background-color: #f5f5f5; padding: 10px 0; box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); }
        .footer-nav .navigation { margin: 0; display: flex; justify-content: space-around; }
        .footer-nav a { flex: 1 1 auto; padding: 10px; font-size: 22px; }
        .checkbox-container { display: flex; justify-content: space-between; align-items: center; padding: 8px; margin: 5px 0; border: 1px solid #ddd; border-radius: 4px; background-color: #fff; cursor: pointer; transition: background-color 0.3s ease; }
        .checkbox-container:hover { background-color: #f0f0f0; }
        .checkbox-container.checked { background-color: #e0f7fa; }
        .checkbox-container label { margin: 0; font-weight: normal; flex: 1; }
        .checkbox-container input { margin: 0; }
        .custom-input { display: none; margin-top: 5px; }
        .extincteur-counter { font-style: italic; color: #666; margin-top: 5px; }
        @media (max-width: 600px) {
            .nav-buttons a, .nav-buttons button { flex: 1 1 100%; }
            .extincteur { padding: 10px; }
            .footer-nav a { font-size: 18px; padding: 8px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Compte-rendu Extincteurs</h1>

        <section class="section">
            <h2>üßæ Client</h2>
            <p><strong>Client:</strong> <span id="clientName">Non s√©lectionn√©</span></p>
            <p><strong>Lieu d‚Äôintervention:</strong> <span id="lieu">Non s√©lectionn√©</span></p>
        </section>

        <section class="section">
            <h2>üìÖ D√©tails de l‚Äôintervention</h2>
            <label>Date d‚Äôintervention: <input type="date" id="interventionDate" value="2025-05-15" required></label>
            <label>Technicien intervenant: <input type="text" id="technician" placeholder="Nom du technicien"></label>
        </section>

        <section class="section">
            <h2>üßØ Extincteurs</h2>
            <div id="extincteursList"></div>
            <p class="extincteur-counter" id="extincteurCounter">Extincteurs valid√©s : 0</p>
            <button onclick="addExtincteur()">‚ûï Ajouter un extincteur</button>
            <p id="extincteurError" class="error" style="display: none;">Veuillez ajouter au moins un extincteur.</p>
        </section>

        <section class="section">
            <h2>‚úÖ Devoir de conseil</h2>
            <div class="checkbox-container" onclick="toggleCheckbox('registre')">
                <label for="registre">Registre pr√©sent et √† jour</label>
                <input type="checkbox" id="registre">
            </div>
            <div class="checkbox-container" onclick="toggleCheckbox('signaletique')">
                <label for="signaletique">Signal√©tique √† jour</label>
                <input type="checkbox" id="signaletique">
            </div>
            <div class="checkbox-container" onclick="toggleCheckbox('baes')">
                <label for="baes">BAES pr√©sents</label>
                <input type="checkbox" id="baes">
            </div>
            <div class="checkbox-container" onclick="toggleCheckbox('plans')">
                <label for="plans">Plans de s√©curit√© pr√©sents et √† jour</label>
                <input type="checkbox" id="plans">
            </div>
        </section>

        <section class="section">
            <h2>üìù Observations g√©n√©rales</h2>
            <textarea id="observations" rows="4" placeholder="Notes sur l'intervention..."></textarea>
        </section>

        <section class="section nav-buttons">
            <button onclick="validateCRM()">‚úÖ Valider le compte rendu</button>
            <a href="bon_intervention.html"><button>‚û°Ô∏è Passer au bon d‚Äôintervention</button></a>
        </section>
    </div>

    <div class="footer-nav">
        <div class="navigation nav-buttons">
            <a href="index.html">üè†</a>
            <a href="CRM_extincteurs.html">üßØ</a>
            <a href="CRM_ria.html">üöø</a>
            <a href="CRM_baes.html">üí°</a>
            <a href="CRM_desenfumage.html">üí®</a>
        </div>
    </div>

    <script>
        let extincteurCount = 0;
        let extincteursValides = [];

        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (!interventionData || !interventionData.client) {
                alert('Aucun client s√©lectionn√©. Veuillez choisir un client depuis la page Interventions.');
                window.location.href = 'intervention.html';
                return;
            }
            document.getElementById('clientName').textContent = interventionData.client || 'Non s√©lectionn√©';
            document.getElementById('lieu').textContent = interventionData.lieu || 'Non s√©lectionn√©';
            loadDraft();
        };

        function addExtincteur() {
            extincteurCount++;
            const div = document.createElement('div');
            div.className = 'extincteur';
            div.id = `extincteur-${extincteurCount}`;
            div.innerHTML = `
                <h3>üßØ Nouvel extincteur #${extincteurCount}</h3>
                <label>N¬∞ extincteur: <input type="text" class="num" value="EXT-${extincteurCount}" readonly></label>
                <label>Type d'extincteur: 
                    <select class="type" onchange="toggleCustomInput(this, 'customType-${extincteurCount}')">
                        <option value="Eau 6L">Eau 6L</option>
                        <option value="CO2 2kg">CO2 2kg</option>
                        <option value="Poudre 5kg">Poudre 5kg</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <input type="text" class="custom-input customType-${extincteurCount}" placeholder="Type personnalis√©">
                </label>
                <label>Ext. PP ? <input type="checkbox" class="pp"></label>
                <label>Fabricant: 
                    <select class="fabricant" onchange="toggleCustomInput(this, 'customFabricant-${extincteurCount}')">
                        <option value="Desautel">Desautel</option>
                        <option value="Kidde">Kidde</option>
                        <option value="Sicli">Sicli</option>
                        <option value="Autre">Autre</option>
                    </select>
                    <input type="text" class="custom-input customFabricant-${extincteurCount}" placeholder="Fabricant personnalis√©">
                </label>
                <label>Mill√©sime: 
                    <select class="millesime" onchange="toggleCustomInput(this, 'customMillesime-${extincteurCount}')">
                        ${Array.from({length: 11}, (_, i) => 2015 + i).map(year => `<option value="${year}">${year}</option>`).join('')}
                        <option value="Autre">Autre</option>
                    </select>
                    <input type="text" class="custom-input customMillesime-${extincteurCount}" placeholder="Ann√©e personnalis√©e">
                </label>
                <label>Niveau: <input type="text" class="niveau" placeholder="Bon, Moyen, Mauvais"></label>
                <label>Emplacement: <input type="text" class="emplacement" placeholder="Ex. Hall principal"></label>
                <h4>Op√©rations effectu√©es</h4>
                <div class="checkbox-container" onclick="toggleCheckbox('op-verif-${extincteurCount}')">
                    <label for="op-verif-${extincteurCount}">V√©rification OK</label>
                    <input type="checkbox" id="op-verif-${extincteurCount}" class="op-verif">
                </div>
                <div class="checkbox-container" onclick="toggleCheckbox('op-quinquennale-${extincteurCount}')">
                    <label for="op-quinquennale-${extincteurCount}">R√©vision quinquennale</label>
                    <input type="checkbox" id="op-quinquennale-${extincteurCount}" class="op-quinquennale">
                </div>
                <div class="checkbox-container" onclick="toggleCheckbox('op-recharge-${extincteurCount}')">
                    <label for="op-recharge-${extincteurCount}">Recharg√©</label>
                    <input type="checkbox" id="op-recharge-${extincteurCount}" class="op-recharge">
                </div>
                <div class="checkbox-container" onclick="toggleCheckbox('op-mise-service-${extincteurCount}')">
                    <label for="op-mise-service-${extincteurCount}">Mise en service</label>
                    <input type="checkbox" id="op-mise-service-${extincteurCount}" class="op-mise-service">
                </div>
                <div class="checkbox-container" onclick="toggleCheckbox('op-echange-${extincteurCount}')">
                    <label for="op-echange-${extincteurCount}">√âchange standard</label>
                    <input type="checkbox" id="op-echange-${extincteurCount}" class="op-echange">
                </div>
                <label>Observation: <textarea class="observation" rows="2"></textarea></label>
                <button onclick="validateExtincteur(${extincteurCount})">‚úÖ Valider extincteur</button>
                <button onclick="removeExtincteur(${extincteurCount})">Supprimer</button>
                <div class="summary" id="summary-${extincteurCount}">
                    <div class="summary-content"></div>
                    <div class="edit-buttons" id="edit-buttons-${extincteurCount}">
                        <button onclick="editExtincteur(${extincteurCount})">‚úèÔ∏è Modifier</button>
                        <button onclick="deleteExtincteur(${extincteurCount})">üóëÔ∏è Supprimer</button>
                    </div>
                </div>
            `;
            document.getElementById('extincteursList').appendChild(div);
        }

        function toggleCustomInput(select, inputId) {
            const input = document.querySelector(`.${inputId}`);
            if (select.value === 'Autre') {
                input.style.display = 'block';
            } else {
                input.style.display = 'none';
                input.value = '';
            }
        }

        function toggleCheckbox(id) {
            const checkbox = document.getElementById(id);
            checkbox.checked = !checkbox.checked;
            const container = checkbox.closest('.checkbox-container');
            if (checkbox.checked) {
                container.classList.add('checked');
            } else {
                container.classList.remove('checked');
            }
        }

        function validateExtincteur(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            const num = extincteur.querySelector('.num').value;
            const typeSelect = extincteur.querySelector('.type');
            const type = typeSelect.value === 'Autre' ? extincteur.querySelector(`.customType-${id}`).value : typeSelect.value;
            const pp = extincteur.querySelector('.pp').checked ? 'PP' : '';
            const fabricantSelect = extincteur.querySelector('.fabricant');
            const fabricant = fabricantSelect.value === 'Autre' ? extincteur.querySelector(`.customFabricant-${id}`).value : fabricantSelect.value;
            const millesimeSelect = extincteur.querySelector('.millesime');
            const millesime = millesimeSelect.value === 'Autre' ? extincteur.querySelector(`.customMillesime-${id}`).value : millesimeSelect.value;
            const emplacement = extincteur.querySelector('.emplacement').value;
            const ops = Array.from(extincteur.querySelectorAll('input[type="checkbox"]'))
                .filter(cb => cb.checked && cb.className !== 'pp')
                .map(cb => cb.className.split('-')[1].charAt(0).toUpperCase())
                .join('');
            const summary = `${num} - ${type} (${emplacement}) [${ops}${pp}]`;

            const summaryDiv = document.getElementById(`summary-${id}`);
            const summaryContent = summaryDiv.querySelector('.summary-content');
            summaryContent.textContent = summary;
            summaryDiv.style.display = 'block';

            extincteursValides[id] = {
                num: num,
                type: type,
                pp: pp,
                fabricant: fabricant,
                millesime: millesime,
                niveau: extincteur.querySelector('.niveau').value,
                emplacement: emplacement,
                operations: ops,
                observation: extincteur.querySelector('.observation').value
            };

            extincteur.querySelectorAll('h3, label, input, select, textarea, .checkbox-container').forEach(elem => {
                elem.style.display = 'none';
            });
            extincteur.querySelectorAll('button[onclick^="validateExtincteur"], button[onclick^="removeExtincteur"]').forEach(btn => btn.style.display = 'none');
            updateExtincteurCounter();
        }

        function editExtincteur(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            const summaryDiv = document.getElementById(`summary-${id}`);
            const editButtons = document.getElementById(`edit-buttons-${id}`);
            editButtons.style.display = editButtons.style.display === 'block' ? 'none' : 'block';
            if (editButtons.style.display === 'block') return;

            extincteur.querySelectorAll('input, select, textarea').forEach(elem => {
                elem.removeAttribute('readonly');
                if (elem.tagName === 'SELECT') elem.disabled = false;
            });
            extincteur.querySelectorAll('input[type="checkbox"]').forEach(cb => cb.disabled = false);
            extincteur.querySelectorAll('h3, label, .checkbox-container').forEach(elem => elem.style.display = 'block');
            extincteur.querySelectorAll('.custom-input').forEach(elem => {
                if (elem.value) elem.style.display = 'block';
            });
            summaryDiv.style.display = 'none';
            extincteur.querySelector('button[onclick^="validateExtincteur"]').style.display = 'inline';
            extincteur.querySelector('button[onclick^="removeExtincteur"]').style.display = 'inline';
        }

        function deleteExtincteur(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            if (extincteur) {
                extincteur.remove();
                delete extincteursValides[id];
                updateExtincteurCounter();
            }
        }

        function removeExtincteur(id) {
            const extincteur = document.getElementById(`extincteur-${id}`);
            if (extincteur) {
                extincteur.remove();
            }
        }

        function updateExtincteurCounter() {
            const count = Object.keys(extincteursValides).length;
            document.getElementById('extincteurCounter').textContent = `Extincteurs valid√©s : ${count}`;
        }

        function loadDraft() {
            const drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            const draft = drafts['crm_extincteurs'];
            if (draft) {
                document.getElementById('clientName').textContent = draft.client || 'Non s√©lectionn√©';
                document.getElementById('lieu').textContent = draft.lieu || 'Non s√©lectionn√©';
                document.getElementById('interventionDate').value = draft.date;
                document.getElementById('technician').value = draft.technician;
                document.getElementById('observations').value = draft.observations;
                if (draft.devoirConseil) {
                    document.getElementById('registre').checked = draft.devoirConseil.registre;
                    document.getElementById('signaletique').checked = draft.devoirConseil.signaletique;
                    document.getElementById('baes').checked = draft.devoirConseil.baes;
                    document.getElementById('plans').checked = draft.devoirConseil.plans;
                }
            }
        }

        function validateCRM() {
            const client = document.getElementById('clientName').textContent;
            const lieu = document.getElementById('lieu').textContent;
            const date = document.getElementById('interventionDate').value;
            const extincteurs = Object.values(extincteursValides);

            if (!client || client === 'Non s√©lectionn√©') {
                alert('Le nom du client est obligatoire.');
                return;
            }
            if (!date) {
                alert('La date d‚Äôintervention est obligatoire.');
                return;
            }
            if (extincteurs.length === 0) {
                document.getElementById('extincteurError').style.display = 'block';
                return;
            }

            const summary = Object.values(extincteursValides).map(ext => {
                const ops = ext.operations || '';
                return `${ext.num} - ${ext.type} (${ext.emplacement}) [${ops}${ext.pp}]`;
            }).join('\n');

            const observations = document.getElementById('observations').value;
            const devoirConseil = {
                registre: document.getElementById('registre').checked,
                signaletique: document.getElementById('signaletique').checked,
                baes: document.getElementById('baes').checked,
                plans: document.getElementById('plans').checked
            };
            const crmData = {
                client: client,
                lieu: lieu,
                date: date,
                technician: document.getElementById('technician').value,
                extincteurs: extincteurs,
                summary: summary,
                observations: observations,
                devoirConseil: devoirConseil
            };

            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            drafts['crm_extincteurs'] = crmData;
            localStorage.setItem('drafts', JSON.stringify(drafts));

            let interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            interventionData.crm_extincteurs = crmData;
            localStorage.setItem('currentIntervention', JSON.stringify(interventionData));

            alert('Compte-rendu valid√© et sauvegard√© !');
        }
    </script>
</body>
</html>