<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'Intervention - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <style>
        .section { margin-bottom: 20px; padding: 10px; border-bottom: 1px solid #eee; }
        .info-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .info-box { flex: 1; min-width: 250px; }
        .info-box input.error, .info-box select.error, .info-box textarea.error { border: 1px solid #e63946; }
        #totalsTable { max-width: 220px; margin: 10px 0; }
        .add-btn { background-color: #10b981; color: white; padding: 8px 16px; border-radius: 8px; }
        .add-btn:hover { background-color: #059669; }
        .validated { background-color: #f0fdf4; }
        .check-icon { color: #10b981; margin-left: 8px; }
        .check-icon.disabled { color: #ccc; }
        .edit-icon { color: #3b82f6; }
        .delete-icon { color: #ef4444; }
        .shortcuts { display: flex; justify-content: space-evenly; gap: 15px; margin-top: 20px; }
        .shortcut-btn { background: #9ca3af; color: white; padding: 10px; border-radius: 8px; }
        .shortcut-btn:hover { background: #8b929e; }
        @media (max-width: 600px) {
            .info-container { flex-direction: column; }
            table td:before { font-size: 12px; }
            table td select, table td input { font-size: 13px; }
            #totalsTable { max-width: 160px; margin-left: auto; }
        }
        @media print {
            .shortcuts, .add-btn { display: none; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bon d'Intervention</h1>

        <section class="section">
            <h2>R√©sum√© CRM</h2>
            <table id="crmTable">
                <thead>
                    <tr><th>Date</th><th>Intervention</th><th>Technicien</th><th>Montant TTC</th></tr>
                </thead>
                <tbody id="crmBody"></tbody>
            </table>
        </section>

        <section class="section">
            <h2>Informations Client</h2>
            <div class="info-container">
                <div class="info-box">
                    <label for="clientName">Nom du client *</label>
                    <input type="text" id="clientName" placeholder="Nom du client">
                </div>
                <div class="info-box">
                    <label for="clientAddress">Adresse</label>
                    <input type="text" id="clientAddress" placeholder="Adresse">
                </div>
                <div class="info-box">
                    <label for="clientPhone">T√©l√©phone</label>
                    <input type="text" id="clientPhone" placeholder="T√©l√©phone">
                </div>
            </div>
        </section>

        <section class="section">
            <h2>D√©tails Intervention</h2>
            <div class="info-container">
                <div class="info-box">
                    <label for="interventionDate">Date *</label>
                    <input type="date" id="interventionDate">
                </div>
                <div class="info-box">
                    <label for="technician">Technicien *</label>
                    <input type="text" id="technician" placeholder="Nom du technicien">
                </div>
                <div class="info-box">
                    <label for="status">Statut</label>
                    <select id="status">
                        <option value="en_cours">En cours</option>
                        <option value="termine">Termin√©</option>
                        <option value="annule">Annul√©</option>
                    </select>
                </div>
                <div class="info-box">
                    <label for="paymentTerms">Modalit√©s de paiement</label>
                    <select id="paymentTerms">
                        <option value="virement_30j">Virement 30 jours</option>
                        <option value="cheque">Ch√®que √† r√©ception</option>
                        <option value="especes">Esp√®ces</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="section">
            <h2>üìã Prestations & Mat√©riel</h2>
            <table id="prestationsTable">
                <thead>
                    <tr><th>D√©signation</th><th>Qt√©</th><th>PU HT (‚Ç¨)</th><th>Total HT</th></tr>
                </thead>
                <tbody id="prestationsBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow()">‚ûï Ajouter une ligne</button>
            <table id="totalsTable">
                <tr><th>Total HT</th><td id="totalHT">0.00 ‚Ç¨</td></tr>
                <tr><th>TVA 20%</th><td id="tva">0.00 ‚Ç¨</td></tr>
                <tr><th>Total TTC</th><td id="totalTTC">0.00 ‚Ç¨</td></tr>
            </table>
        </section>

        <div class="shortcuts">
            <button class="shortcut-btn" onclick="saveIntervention()" title="Enregistrer"><i class="fas fa-save"></i></button>
            <button class="shortcut-btn" onclick="printIntervention()" title="PDF"><i class="fas fa-file-pdf"></i></button>
            <button class="shortcut-btn" onclick="sendIntervention()" title="Envoyer"><i class="fas fa-envelope"></i></button>
            <button class="shortcut-btn" onclick="cancelIntervention()" title="Annuler"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        emailjs.init("YOUR_EMAILJS_USER_ID"); // Remplacer par ton ID EmailJS
        let index = document.querySelectorAll('#prestationsBody tr').length;
        let isValidated = false;
        const articlesDB = [
            { name: "Extincteur CO2 5kg", unitPrice: 150.00 },
            { name: "Maintenance RIA", unitPrice: 80.00 },
            { name: "BAES Type 1", unitPrice: 120.00 }
        ];

        function addRow() {
            const tbody = document.getElementById('prestationsBody');
            const row = document.createElement('tr');
            row.id = `row-${index}`;
            row.innerHTML = `
                <td data-label="D√©signation">
                    <select class="designation" id="des-${index}" onchange="onInputChange(${index})">
                        <option value="">--Choisir--</option>
                        ${articlesDB.map(article => `<option value="${article.name}" data-price="${article.unitPrice}">${article.name}</option>`).join('')}
                        <option value="custom">Autre</option>
                    </select>
                    <input type="text" class="custom-designation" id="cust-${index}" style="display:none;" placeholder="Saisie libre" oninput="onInputChange(${index})">
                    <span class="icon-holder">
                        <i class="fas fa-check-circle check-icon" onclick="validateRow(${index})" title="Valider"></i>
                        <i class="fas fa-pen edit-icon disabled" title="Modifier"></i>
                        <i class="fas fa-trash delete-icon disabled" title="Supprimer"></i>
                    </span>
                </td>
                <td data-label="Qt√©"><input type="number" class="quantity" id="qte-${index}" min="1" onblur="onInputChange(${index})"/></td>
                <td data-label="PU HT"><input type="number" step="0.01" class="unitPrice" id="pu-${index}" placeholder="en ‚Ç¨" onblur="onInputChange(${index})"/></td>
                <td data-label="Total HT"><input type="number" class="total no-arrows" id="total-${index}" readonly /></td>`;
            tbody.appendChild(row);
            index++;
            savePrestations();
            updateTotals();
        }

        function onInputChange(i) {
            const row = document.getElementById(`row-${i}`);
            const desSel = document.getElementById(`des-${i}`);
            const custInput = document.getElementById(`cust-${i}`);
            const qteInput = document.getElementById(`qte-${i}`);
            const puInput = document.getElementById(`pu-${i}`);
            const total = document.getElementById(`total-${i}`);

            if (desSel.value === "custom") {
                custInput.style.display = "block";
                puInput.value = "";
            } else {
                custInput.style.display = "none";
                if (desSel.selectedOptions[0].dataset.price) {
                    puInput.value = desSel.selectedOptions[0].dataset.price;
                }
            }

            const qte = parseFloat(qteInput.value) || 0;
            const pu = parseFloat(puInput.value) || 0;
            if (qte <= 0 || isNaN(qte)) {
                qteInput.classList.add('error');
                total.value = "";
                return;
            } else {
                qteInput.classList.remove('error');
            }
            if (pu <= 0 || isNaN(pu)) {
                puInput.classList.add('error');
                total.value = "";
                return;
            } else {
                puInput.classList.remove('error');
            }
            total.value = (qte * pu).toFixed(2);
            savePrestations();
            updateTotals();
        }

        function validateRow(i) {
            const row = document.getElementById(`row-${i}`);
            const desSel = document.getElementById(`des-${i}`);
            const custInput = document.getElementById(`cust-${i}`);
            const qteInput = document.getElementById(`qte-${i}`);
            const puInput = document.getElementById(`pu-${i}`);
            const designation = desSel.value === "custom" ? custInput.value.trim() : desSel.value;
            const quantity = parseFloat(qteInput.value) || 0;
            const unitPrice = parseFloat(puInput.value) || 0;

            if (!designation || quantity <= 0 || unitPrice <= 0) {
                alert('Remplir d√©signation, quantit√© (>0) et PU HT (>0).');
                return;
            }
            row.querySelectorAll('input, select').forEach(input => input.disabled = true);
            row.classList.add('validated');
            row.querySelector('.icon-holder').innerHTML = `
                <i class="fas fa-check-circle check-icon disabled" title="Valid√©"></i>
                <i class="fas fa-pen edit-icon" onclick="enableEdit(${i})" title="Modifier"></i>
                <i class="fas fa-trash delete-icon" onclick="deleteRow(${i})" title="Supprimer"></i>`;
            savePrestations();
            updateTotals();
            addRow();
        }

        function enableEdit(i) {
            const row = document.getElementById(`row-${i}`);
            row.querySelectorAll('input, select').forEach(input => input.disabled = false);
            row.classList.remove('validated');
            row.querySelector('.icon-holder').innerHTML = `
                <i class="fas fa-check-circle check-icon" onclick="validateRow(${i})" title="Valider"></i>
                <i class="fas fa-pen edit-icon disabled" title="Modifier"></i>
                <i class="fas fa-trash delete-icon disabled" title="Supprimer"></i>`;
            savePrestations();
            updateTotals();
        }

        function deleteRow(i) {
            document.getElementById(`row-${i}`)?.remove();
            savePrestations();
            updateTotals();
        }

        function savePrestations() {
            const prestationsData = [];
            document.querySelectorAll('#prestationsBody tr').forEach(row => {
                const select = row.querySelector('.designation');
                const custom = row.querySelector('.custom-designation');
                const designation = select?.value === 'custom' ? custom?.value.trim() : select?.value;
                const quantity = row.querySelector('.quantity')?.value;
                const unitPrice = row.querySelector('.unitPrice')?.value;
                const total = row.querySelector('.total')?.value;
                if (designation && quantity && unitPrice && total) {
                    prestationsData.push({ designation, quantity, unitPrice, total });
                }
            });
            try {
                localStorage.setItem('prestationsData', JSON.stringify(prestationsData));
            } catch {
                alert('Erreur sauvegarde : stockage plein.');
            }
        }

        function loadPrestations() {
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            const tbody = document.getElementById('prestationsBody');
            prestationsData.forEach((item, i) => {
                const isCustom = !articlesDB.some(article => article.name === item.designation);
                const row = document.createElement('tr');
                row.id = `row-${i}`;
                row.innerHTML = `
                    <td data-label="D√©signation">
                        <select class="designation" id="des-${i}" onchange="onInputChange(${i})" disabled>
                            <option value="">--Choisir--</option>
                            ${articlesDB.map(article => `<option value="${article.name}" data-price="${article.unitPrice}" ${article.name === item.designation ? 'selected' : ''}>${article.name}</option>`).join('')}
                            <option value="custom" ${isCustom ? 'selected' : ''}>Autre</option>
                        </select>
                        <input type="text" class="custom-designation" id="cust-${i}" value="${isCustom ? item.designation : ''}" style="display:${isCustom ? 'block' : 'none'};" disabled>
                        <span class="icon-holder">
                            <i class="fas fa-check-circle check-icon disabled" title="Valid√©"></i>
                            <i class="fas fa-pen edit-icon" onclick="enableEdit(${i})" title="Modifier"></i>
                            <i class="fas fa-trash delete-icon" onclick="deleteRow(${i})" title="Supprimer"></i>
                        </span>
                    </td>
                    <td data-label="Qt√©"><input type="number" class="quantity" id="qte-${i}" value="${item.quantity}" min="1" onblur="onInputChange(${i})" disabled/></td>
                    <td data-label="PU HT"><input type="number" step="0.01" class="unitPrice" id="pu-${i}" value="${item.unitPrice}" onblur="onInputChange(${i})" disabled/></td>
                    <td data-label="Total HT"><input type="number" class="total no-arrows" id="total-${i}" value="${item.total}" readonly /></td>`;
                row.classList.add('validated');
                tbody.appendChild(row);
            });
            index = prestationsData.length;
            updateTotals();
            if (!prestationsData.length) addRow();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#prestationsBody tr').forEach(row => {
                const total = parseFloat(row.querySelector('.total')?.value) || 0;
                if (total > 0) totalHT += total;
            });
            const tva = totalHT * 0.2;
            const totalTTC = totalHT + tva;
            document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
            document.getElementById('tva').textContent = tva.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
        }

        function saveIntervention() {
            const clientData = {
                clientName: document.getElementById('clientName').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                interventionDate: document.getElementById('interventionDate').value,
                technician: document.getElementById('technician').value.trim(),
                status: document.getElementById('status').value,
                paymentTerms: document.getElementById('paymentTerms').value
            };
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            if (!clientData.clientName || !clientData.interventionDate || !clientData.technician) {
                alert('Champs obligatoires : Nom du client, Date, Technicien.');
                ['clientName', 'interventionDate', 'technician'].forEach(id => {
                    if (!document.getElementById(id).value) document.getElementById(id).classList.add('error');
                });
                return;
            }
            if (!prestationsData.length) {
                alert('Ajoutez au moins une prestation valid√©e.');
                return;
            }
            isValidated = true;
            localStorage.setItem('interventionData', JSON.stringify(clientData));
            const crmData = JSON.parse(localStorage.getItem('crmData') || '[]');
            crmData.push({
                date: clientData.interventionDate,
                intervention: `Intervention pour ${clientData.clientName}`,
                technician: clientData.technician,
                montantTTC: document.getElementById('totalTTC').textContent
            });
            localStorage.setItem('crmData', JSON.stringify(crmData));
            alert('Bon valid√© et enregistr√© !');
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            loadCrmData();
        }

        function loadIntervention() {
            const clientData = JSON.parse(localStorage.getItem('interventionData') || '{}');
            document.getElementById('clientName').value = clientData.clientName || '';
            document.getElementById('clientAddress').value = clientData.clientAddress || '';
            document.getElementById('clientPhone').value = clientData.clientPhone || '';
            document.getElementById('interventionDate').value = clientData.interventionDate || '';
            document.getElementById('technician').value = clientData.technician || '';
            document.getElementById('status').value = clientData.status || 'en_cours';
            document.getElementById('paymentTerms').value = clientData.paymentTerms || 'virement_30j';
        }

        function loadCrmData() {
            const crmData = JSON.parse(localStorage.getItem('crmData') || '[]');
            const tbody = document.getElementById('crmBody');
            tbody.innerHTML = '';
            crmData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${item.date}</td><td>${item.intervention}</td><td>${item.technician}</td><td>${item.montantTTC}</td>`;
                tbody.appendChild(row);
            });
        }

        function printIntervention() {
            if (!isValidated) {
                alert('Veuillez valider le bon.');
                return;
            }
            const element = document.querySelector('.container');
            html2pdf().set({ filename: 'bon_intervention.pdf', margin: 10 }).from(element).save();
        }

        function sendIntervention() {
            if (!isValidated) {
                alert('Veuillez valider le bon.');
                return;
            }
            const clientData = JSON.parse(localStorage.getItem('interventionData') || '{}');
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                to_email: clientData.clientPhone || 'client@example.com',
                client: clientData.clientName,
                date: clientData.interventionDate,
                prestations: JSON.stringify(prestationsData),
                total: document.getElementById('totalTTC').textContent
            }).then(() => alert('Email envoy√© !'), () => alert('Erreur envoi.'));
        }

        function cancelIntervention() {
            if (confirm('Annuler le bon d‚Äôintervention ?')) {
                localStorage.removeItem('interventionData');
                localStorage.removeItem('prestationsData');
                window.location.reload();
            }
        }

        window.onload = () => {
            loadIntervention();
            loadPrestations();
            loadCrmData();
        };
    </script>
</body>
</html>