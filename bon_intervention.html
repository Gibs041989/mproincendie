<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'intervention</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 0; padding: 20px; background-color: #f4f4f4; }
        .container { max-width: 800px; margin: auto; background: white; padding: 20px; border-radius: 8px; }
        h1 { color: #d32f2f; }
        table { width: 100%; border-collapse: collapse; margin: 10px 0; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #d32f2f; color: white; }
        input, select { width: 100%; padding: 5px; margin: 5px 0; }
        button { padding: 10px; background-color: #d32f2f; color: white; border: none; border-radius: 4px; cursor: pointer; }
        button:hover { background-color: #b71c1c; }
        .navigation { margin-top: 20px; }
        .navigation a { margin-right: 10px; text-decoration: none; color: #d32f2f; }
        @media (max-width: 600px) { .container { padding: 10px; } button { width: 100%; } }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßæ Bon d‚Äôintervention</h1>

        <section>
            <h2>üì¶ Prestations & mat√©riel</h2>
            <table id="facturationTable">
                <thead>
                    <tr>
                        <th>Code article</th>
                        <th>D√©signation</th>
                        <th>Qt√©</th>
                        <th>PU ‚Ç¨</th>
                        <th>Total ‚Ç¨</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody id="facturationBody"></tbody>
            </table>
            <button onclick="addPrestation()">‚ûï Ajouter une ligne</button>
            <p>Montant total HT: <span id="totalHT">0</span> ‚Ç¨</p>
            <p>Montant TTC: <span id="totalTTC">0</span> ‚Ç¨</p>
        </section>

        <section>
            <h2>‚öôÔ∏è Modalit√©s de r√®glement</h2>
            <label>Mode de paiement:
                <select id="paymentMode">
                    <option value="virement">Virement</option>
                    <option value="cheque">Ch√®que</option>
                    <option value="cb">Carte bancaire</option>
                    <option value="especes">Esp√®ces</option>
                </select>
            </label>
            <label>D√©lai de paiement:
                <select id="paymentDelay">
                    <option value="reception">A r√©ception</option>
                    <option value="30jours">30 jours</option>
                    <option value="finmois">Fin de mois</option>
                </select>
            </label>
        </section>

        <section>
            <h2>‚úçÔ∏è Signatures</h2>
            <label>Nom du client signataire: <input type="text" id="signatureClient"></label>
            <label>Fait √†: <input type="text" id="signatureLieu" value="Paris"></label>
            <label>Le: <input type="date" id="signatureDate" value="2025-05-15"></label>
            <label>Nom du technicien: <input type="text" id="signatureTech"></label>
        </section>

        <section>
            <h2>üìÑ R√©sum√© CRM</h2>
            <p id="crmSummary">Aucun CRM associ√© pour le moment.</p>
        </section>

        <button onclick="generatePDF()">üìÑ G√©n√©rer le PDF</button>

        <div class="navigation">
            <a href="index.html">üè† Accueil</a>
            <a href="client.html">üìÅ Clients</a>
            <a href="intervention.html">üõ†Ô∏è Intervention</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        let prestations = [];

        function addPrestation() {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" placeholder="Code"></td>
                <td><input type="text" class="designation" placeholder="D√©signation"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="0" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="total">0</td>
                <td><button onclick="this.parentElement.parentElement.remove(); updateTotals()">Supprimer</button></td>
            `;
            tbody.appendChild(row);
            updateTotals();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#facturationBody tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const pu = parseFloat(row.querySelector('.pu').value) || 0;
                const total = qty * pu;
                row.querySelector('.total').textContent = total.toFixed(2);
                totalHT += total;
            });
            const tva = 0.2; // 20% TVA
            const totalTTC = totalHT * (1 + tva);
            document.getElementById('totalHT').textContent = totalHT.toFixed(2);
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2);
        }

        function generatePDF() {
            const element = document.querySelector('.container');
            const opt = {
                margin: 1,
                filename: 'bon_intervention.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        // Simuler r√©cup√©ration du r√©sum√© CRM (√† connecter avec CRM_extincteurs.html)
        window.onload = () => {
            const savedDraft = JSON.parse(localStorage.getItem('drafts')) || {};
            if (savedDraft.crm) {
                document.getElementById('crmSummary').textContent = savedDraft.crm;
            }
        };
    </script>
</body>
</html>
