<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'Intervention - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .container {
            padding-bottom: 70px; /* Espace pour footer-nav */
        }
        table tr { 
            cursor: pointer; 
        }
        table tr.active { 
            background: #f5f5f5; 
        }
        .action-buttons { 
            display: none; 
            text-align: right; 
            margin: 8px 0; 
        }
        .action-buttons button { 
            font-size: 14px; 
            padding: 5px; 
            margin-left: 10px; 
            border: none; 
            background: none; 
        }
        .section {
            margin-bottom: 40px; /* Plus d'espace entre les sections */
        }
        table {
            margin-bottom: 20px; 
            width: 100%; 
            border-collapse: collapse;
            box-sizing: border-box; /* Inclure bordures dans la largeur */
        }
        /* Conteneur pour permettre le d√©filement horizontal sur mobile */
        .table-container {
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
            width: 100%;
        }
        /* Styles pour le tableau des prestations */
        #prestationsTable th, #prestationsTable td {
            padding: 10px; 
            min-width: 80px; 
            text-align: left;
            border: 1px solid #ddd;
            font-size: 16px;
        }
        #prestationsTable th:nth-child(1), #prestationsTable td:nth-child(1) { /* D√©signation */
            min-width: 200px;
        }
        #prestationsTable th:nth-child(2), #prestationsTable td:nth-child(2) { /* Qt√© */
            min-width: 70px;
        }
        #prestationsTable th:nth-child(3), #prestationsTable td:nth-child(3) { /* PU HT */
            min-width: 100px;
        }
        #prestationsTable th:nth-child(4), #prestationsTable td:nth-child(4) { /* Prix Total HT */
            min-width: 100px;
        }
        /* Styles pour le tableau des totaux */
        #totalsTable {
            width: 100%;
            max-width: 300px;
            margin: 20px 0;
            border-collapse: collapse;
        }
        #totalsTable th, #totalsTable td {
            padding: 10px;
            border: 1px solid #ddd;
            text-align: left;
        }
        #totalsTable th {
            background-color: #f5f5f5;
            width: 50%;
        }
        .nav-buttons {
            margin-top: 40px; 
            padding-bottom: 60px; 
        }
        .footer-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background-color: #f5f5f5; 
            padding: 10px 0; 
            box-shadow: 0 -2px 8px rgba(0, 0, 0, 0.1); 
            z-index: 1000; 
        }
        .footer-nav .navigation { 
            margin: 0; 
            display: flex; 
            flex-direction: row; 
            flex-wrap: nowrap; 
            justify-content: space-around; 
            align-items: center; 
            gap: 20px; 
        }
        .footer-nav a { 
            flex: 1; 
            text-align: center; 
            padding: 10px; 
            font-size: 22px; 
            background-color: transparent; 
            border-radius: 8px; 
            transition: background-color 0.3s ease; 
        }
        .footer-nav a:hover { 
            background-color: #ffebee; 
        }
        .signature-pad {
            border: 1px solid #ddd;
            border-radius: 8px;
            margin-top: 10px;
            width: 400px;
            height: 200px;
        }
        @media (max-width: 600px) {
            .section {
                margin-bottom: 20px; /* R√©duire les marges */
            }
            #prestationsTable {
                width: 100%; /* Prendre toute la largeur de l'√©cran */
            }
            #prestationsTable th, #prestationsTable td {
                padding: 12px; /* Augmenter le padding pour plus de lisibilit√© */
                min-width: 70px; /* R√©duction pour mobile */
                font-size: 14px; /* Taille de police plus grande */
            }
            #prestationsTable th:nth-child(1), #prestationsTable td:nth-child(1) {
                min-width: 120px;
            }
            #prestationsTable th:nth-child(2), #prestationsTable td:nth-child(2) {
                min-width: 60px;
            }
            #prestationsTable th:nth-child(3), #prestationsTable td:nth-child(3) {
                min-width: 80px;
            }
            #prestationsTable th:nth-child(4), #prestationsTable td:nth-child(4) {
                min-width: 80px;
            }
            label {
                display: block; /* Labels au-dessus des champs */
            }
            label input {
                width: 100%;
                box-sizing: border-box;
            }
            .nav-buttons a, .nav-buttons button {
                flex: 1 1 100%;
                padding: 12px;
                font-size: 20px;
            }
            .footer-nav a {
                font-size: 24px;
                padding: 10px;
            }
            .signature-pad {
                width: 100%; 
                height: 120px; /* Hauteur encore plus petite */
            }
            .signature-pad::before {
                content: 'Signez ici';
                position: absolute;
                color: #ccc;
                font-size: 16px;
                top: 50%;
                left: 50%;
                transform: translate(-50%, -50%);
            }
            .signature-pad-buttons {
                display: flex;
                justify-content: center;
                gap: 10px;
            }
            .signature-pad-buttons button {
                padding: 8px;
                font-size: 14px;
            }
            #totalsTable {
                max-width: 200px; /* R√©duire la taille */
                margin-left: auto; /* Aligner √† droite */
                margin-right: 0;
            }
            #totalsTable th, #totalsTable td {
                padding: 8px; /* R√©duire le padding */
                font-size: 14px; /* R√©duire la taille de la police */
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üî• Bon d'Intervention</h1>

        <section class="section">
            <h2>üßæ Client</h2>
            <p><strong>Client:</strong> <span id="clientName">Non s√©lectionn√©</span></p>
            <p><strong>Adresse:</strong> <span id="adresse">Non s√©lectionn√©e</span></p>
            <p><strong>Code postal:</strong> <span id="codePostal">Non s√©lectionn√©</span></p>
            <p><strong>Ville:</strong> <span id="ville">Non s√©lectionn√©e</span></p>
            <p><strong>T√©l√©phone:</strong> <span id="telephone">Non s√©lectionn√©</span></p>
            <p><strong>Email:</strong> <span id="email">Non s√©lectionn√©</span></p>
        </section>

        <section class="section" id="crmSummary">
            <h2>üìÑ R√©sum√© des CRM</h2>
            <p id="crmSummaryText">Aucun CRM enregistr√©.</p>
        </section>

        <section class="section">
            <h2>üìã Prestations & Mat√©riel</h2>
            <div class="table-container">
                <table id="prestationsTable">
                    <thead>
                        <tr>
                            <th>D√©signation</th>
                            <th>Qt√©</th>
                            <th>PU HT</th>
                            <th>Prix Total HT</th>
                        </tr>
                    </thead>
                    <tbody id="prestationsBody"></tbody>
                </table>
            </div>
            <table id="totalsTable">
                <tr>
                    <th>Total HT</th>
                    <td id="totalHT">0.00 ‚Ç¨</td>
                </tr>
                <tr>
                    <th>TVA 20%</th>
                    <td id="tva">0.00 ‚Ç¨</td>
                </tr>
                <tr>
                    <th>Total TTC</th>
                    <td id="totalTTC">0.00 ‚Ç¨</td>
                </tr>
            </table>
            <button class="action" onclick="addPrestation()">‚ûï Ajouter une prestation</button>
        </section>

        <section class="section">
            <h2>üìÖ D√©tails de l‚Äôintervention</h2>
            <label>Date d‚Äôintervention: <input type="date" id="interventionDate" value="2025-05-18" required></label>
            <label>Technicien intervenant: <input type="text" id="technician" placeholder="Nom du technicien"></label>
            <label>Dur√©e (heures): <input type="number" id="duration" placeholder="Dur√©e en heures"></label>
        </section>

        <section class="section">
            <h2>‚úçÔ∏è Signature du client</h2>
            <canvas id="signature-pad" class="signature-pad"></canvas>
            <div class="signature-pad-buttons">
                <button class="secondary" onclick="clearSignature()"><i class="fas fa-eraser"></i></button>
                <button class="action" onclick="validateSignature()"><i class="fas fa-check"></i></button>
            </div>
        </section>

        <section class="section nav-buttons">
            <button class="secondary" onclick="generatePDF()">üìÑ G√©n√©rer le PDF</button>
            <button class="secondary" onclick="sendEmail()">üìß Envoyer par email</button>
            <a href="intervention.html"><button class="neutral">‚¨ÖÔ∏è Retour</button></a>
        </section>
    </div>

    <div class="footer-nav">
        <div class="navigation nav-buttons">
            <a href="index.html">üè†</a>
            <a href="client.html">üìÅ</a>
            <a href="intervention.html">üõ†Ô∏è</a>
            <a href="parametres.html">‚öôÔ∏è</a>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.0.0/dist/signature_pad.umd.min.js"></script>
    <script>
        const canvas = document.getElementById('signature-pad');
        const signaturePad = new SignaturePad(canvas);

        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            signaturePad.clear();
        }

        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();

        function clearSignature() {
            signaturePad.clear();
        }

        function validateSignature() {
            if (signaturePad.isEmpty()) {
                alert('Veuillez apposer une signature avant de valider.');
                return;
            }
            alert('Signature valid√©e avec succ√®s !');
        }

        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (!interventionData || !interventionData.client) {
                alert('Aucun client s√©lectionn√©. Veuillez choisir un client depuis la page Interventions.');
                window.location.href = 'intervention.html';
                return;
            }
            document.getElementById('clientName').textContent = interventionData.client || 'Non s√©lectionn√©';
            document.getElementById('adresse').textContent = interventionData.adresse || 'Non s√©lectionn√©e';
            document.getElementById('codePostal').textContent = interventionData.codePostal || 'Non s√©lectionn√©';
            document.getElementById('ville').textContent = interventionData.ville || 'Non s√©lectionn√©e';
            document.getElementById('telephone').textContent = interventionData.telephone || 'Non s√©lectionn√©';
            document.getElementById('email').textContent = interventionData.email || 'Non s√©lectionn√©';

            const drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            if (drafts['crm_extincteurs']) {
                document.getElementById('crmSummaryText').textContent = drafts['crm_extincteurs'].summary || 'Aucun CRM enregistr√©.';
            }

            loadPrestations();
        };

        let activeRow = null;

        function addPrestation() {
            if (activeRow) {
                alert('Veuillez valider ou supprimer la ligne en cours avant d‚Äôajouter une nouvelle.');
                return;
            }
            const tbody = document.getElementById('prestationsBody');
            const index = tbody.children.length;

            const row = document.createElement('tr');
            row.id = `row-${index}`;
            row.innerHTML = `
                <td><input type="text" class="designation" placeholder="D√©signation"></td>
                <td><input type="number" class="quantity" placeholder="Qt√©" oninput="calculateTotal(this)"></td>
                <td><input type="number" class="unitPrice" placeholder="PU HT" oninput="calculateTotal(this)"></td>
                <td><input type="number" class="total" readonly></td>
            `;
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="validate-btn" onclick="validateRow(this.parentElement.parentElement, this.parentElement, ${index})" title="Valider"><i class="fas fa-check-circle"></i></button>
                <button class="delete-btn" onclick="removeRow(${index})" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
            `;
            tbody.appendChild(row);
            row.appendChild(actionDiv);
            activeRow = row;
            actionDiv.style.display = 'block';
        }

        function calculateTotal(input) {
            const row = input.closest('tr');
            const quantity = parseFloat(row.querySelector('.quantity').value) || 0;
            const unitPrice = parseFloat(row.querySelector('.unitPrice').value) || 0;
            const totalInput = row.querySelector('.total');
            totalInput.value = quantity && unitPrice ? (quantity * unitPrice).toFixed(2) : '';
            updateTotals();
        }

        function validateRow(row, actionDiv, index) {
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => input.readOnly = true);
            row.classList.add('active');
            actionDiv.style.display = 'none';
            activeRow = null;
            row.onclick = () => editRow(index);
            savePrestations();
        }

        function editRow(index) {
            if (activeRow) {
                alert('Veuillez valider ou supprimer la ligne en cours avant de modifier une autre.');
                return;
            }
            const row = document.getElementById(`row-${index}`);
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => input.readOnly = false);
            activeRow = row;
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="validate-btn" onclick="validateRow(this.parentElement.parentElement, this.parentElement, ${index})" title="Valider"><i class="fas fa-check-circle"></i></button>
                <button class="delete-btn" onclick="removeRow(${index})" title="Supprimer"><i class="fas fa-trash-alt"></i></button>
            `;
            row.appendChild(actionDiv);
            actionDiv.style.display = 'block';
            row.classList.remove('active');
        }

        function removeRow(index) {
            const row = document.getElementById(`row-${index}`);
            if (row) row.remove();
            activeRow = null;
            savePrestations();
            updateTotals();
        }

        function savePrestations() {
            const prestationsData = [];
            document.querySelectorAll('#prestationsBody tr').forEach(row => {
                const prestation = {
                    designation: row.querySelector('.designation').value,
                    quantity: row.querySelector('.quantity').value,
                    unitPrice: row.querySelector('.unitPrice').value,
                    total: row.querySelector('.total').value
                };
                prestationsData.push(prestation);
            });
            localStorage.setItem('prestationsData', JSON.stringify(prestationsData));
        }

        function loadPrestations() {
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData')) || [];
            const tbody = document.getElementById('prestationsBody');
            prestationsData.forEach((item, index) => {
                const row = document.createElement('tr');
                row.id = `row-${index}`;
                row.innerHTML = `
                    <td><input type="text" class="designation" value="${item.designation || ''}" readonly></td>
                    <td><input type="number" class="quantity" value="${item.quantity || ''}" readonly></td>
                    <td><input type="number" class="unitPrice" value="${item.unitPrice || ''}" readonly></td>
                    <td><input type="number" class="total" value="${item.total || ''}" readonly></td>
                `;
                row.classList.add('active');
                row.onclick = () => editRow(index);
                tbody.appendChild(row);
            });
            updateTotals();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#prestationsBody tr').forEach(row => {
                const total = parseFloat(row.querySelector('.total').value) || 0;
                totalHT += total;
            });
            const tva = totalHT * 0.2;
            const totalTTC = totalHT + tva;

            document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
            document.getElementById('tva').textContent = tva.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
        }

        function generatePDF() {
            alert('Fonctionnalit√© de g√©n√©ration de PDF √† impl√©menter.');
        }

        function sendEmail() {
            alert('Fonctionnalit√© d‚Äôenvoi par email √† impl√©menter.');
        }
    </script>
</body>
</html>