<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'intervention</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .facturation-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .prestations { flex: 1; }
        .facturation-section table { width: 100%; border-collapse: collapse; }
        .facturation-section th, td { padding: 10px; border: 1px solid #ddd; }
        .facturation-section input, select, textarea { 
            width: 100%; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; 
        }
        .facturation-section th:nth-child(1) { width: 15%; } /* Code article */
        .facturation-section th:nth-child(2) { width: 35%; } /* D√©signation */
        .facturation-section th:nth-child(3) { width: 10%; } /* Quantit√© */
        .facturation-section th:nth-child(4) { width: 15%; } /* PU HT */
        .facturation-section th:nth-child(5) { width: 15%; } /* Total HT */
        .facturation-section th:nth-child(6) { width: 10%; } /* Action */
        .action-btn { background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; }
        .action-btn:disabled { opacity: 0.5; cursor: not-allowed; }
        .validate-btn { color: #00ff00 !important; } /* Vert vif */
        .delete-btn { color: #ff0000 !important; } /* Rouge vif */
        .totals-table { 
            width: 150px; border-collapse: collapse; 
            float: right; margin-left: 10px; 
        }
        .totals-table th, .totals-table td { 
            border: 1px solid #ddd; padding: 5px; font-size: 14px; text-align: right; 
            white-space: nowrap; 
        }
        .totals-table th { background: #f4f4f4; }
        textarea { resize: vertical; }
        @media (max-width: 600px) {
            .facturation-section { flex-direction: column; }
            .totals-table { float: none; width: 100%; margin: 10px 0; }
            .facturation-section table { font-size: 14px; }
            .facturation-section input, select, textarea { font-size: 14px; padding: 6px; }
            .facturation-section th, td { padding: 6px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßæ Bon d‚Äôintervention</h1>

        <section class="section">
            <h2>üë§ Client</h2>
            <label>Nom client: <input type="text" id="clientName" readonly></label>
            <label>Lieu d‚Äôintervention: <input type="text" id="lieu" readonly></label>
        </section>

        <section class="facturation-section">
            <div class="prestations">
                <h3>Prestations & mat√©riel</h3>
                <table id="facturationTable">
                    <thead>
                        <tr>
                            <th>Code article</th>
                            <th>D√©signation</th>
                            <th>Quantit√©</th>
                            <th>PU HT ‚Ç¨</th>
                            <th>Total HT ‚Ç¨</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="facturationBody"></tbody>
                </table>
                <button onclick="addPrestation()">‚ûï Ajouter une ligne</button>
            </div>
            <table class="totals-table">
                <tr><th>Total HT</th><td><span id="totalHT">0</span> ‚Ç¨</td></tr>
                <tr><th>Total TVA (20%)</th><td><span id="totalTVA">0</span> ‚Ç¨</td></tr>
                <tr><th>Total TTC</th><td><span id="totalTTC">0</span> ‚Ç¨</td></tr>
            </table>
            <div>
                <h3>Modalit√©s de r√®glement</h3>
                <label>Mode de paiement:
                    <select id="paymentMode">
                        <option value="">S√©lectionner</option>
                        <option value="Ch√®que">Ch√®que</option>
                        <option value="Virement">Virement</option>
                        <option value="Esp√®ces">Esp√®ces</option>
                    </select>
                </label>
                <label>D√©lai de paiement:
                    <select id="paymentDelay">
                        <option value="">S√©lectionner</option>
                        <option value="√Ä l‚Äôintervention">√Ä l‚Äôintervention</option>
                        <option value="√Ä r√©ception de facture">√Ä r√©ception de facture</option>
                        <option value="√Ä r√©ception de facture sous 30 jours">√Ä r√©ception de facture sous 30 jours</option>
                    </select>
                </label>
                <label>Observations:
                    <textarea id="observations" rows="4" placeholder="Texte libre"></textarea>
                </label>
            </div>
        </section>

        <section class="section">
            <h2>‚úçÔ∏è Signatures</h2>
            <label>Nom du client signataire: <input type="text" id="signatureClient"></label>
            <label>Fait √†: <input type="text" id="signatureLieu" value="Paris"></label>
            <label>Le: <input type="date" id="signatureDate" value="2025-05-17"></label>
            <label>Nom du technicien: <input type="text" id="signatureTech"></label>
        </section>

        <section class="section">
            <h2>üìÑ R√©sum√© CRM</h2>
            <p id="crmSummary">Aucun CRM associ√© (client particulier ou intervention directe).</p>
        </section>

        <section class="section nav-buttons">
            <button onclick="validateBon()">‚úÖ Valider le bon</button>
            <button onclick="generatePDF()">üìÑ G√©n√©rer le PDF</button>
            <button onclick="sendEmail()">üìß Envoyer par email</button>
            <a href="intervention.html"><button>‚¨ÖÔ∏è Retour</button></a>
        </section>

        <div class="navigation nav-buttons">
            <a href="index.html">üè† Accueil</a>
            <a href="client.html">üìÅ Clients</a>
            <a href="intervention.html">üõ†Ô∏è Intervention</a>
            <a href="parametres.html">‚öôÔ∏è Param√®tres</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (!interventionData.client || !interventionData.lieu) {
                alert('S√©lectionnez un client et un lieu depuis Interventions.');
                window.location.href = 'intervention.html';
                return;
            }
            document.getElementById('clientName').value = interventionData.client;
            document.getElementById('lieu').value = interventionData.lieu;
            if (interventionData.crm_extincteurs) {
                interventionData.crm_extincteurs.forEach(item => addPrestationFromCRM(item));
                document.getElementById('crmSummary').textContent = interventionData.crm_summary || 'R√©sum√© des op√©rations CRM charg√©.';
            }
        };

        function addPrestation() {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" placeholder="Code"></td>
                <td><input type="text" class="designation" placeholder="D√©signation"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="0" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="total">0</td>
                <td>
                    <button class="action-btn validate-btn" onclick="validateRow(this)" title="Valider">‚òëÔ∏è</button>
                    <button class="action-btn delete-btn" onclick="this.parentElement.parentElement.remove(); updateTotals()" title="Supprimer">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
            updateTotals();
        }

        function addPrestationFromCRM(item) {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" value="${item.code || ''}"></td>
                <td><input type="text" class="designation" value="${item.designation || ''}"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="${item.prix || 0}" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="total">0</td>
                <td>
                    <button class="action-btn validate-btn" onclick="validateRow(this)" title="Valider">‚òëÔ∏è</button>
                    <button class="action-btn delete-btn" onclick="this.parentElement.parentElement.remove(); updateTotals()" title="Supprimer">üóëÔ∏è</button>
                </td>
            `;
            tbody.appendChild(row);
            updateTotals();
        }

        function validateRow(button) {
            const row = button.parentElement.parentElement;
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => input.readOnly = true);
            button.disabled = true;
            updateTotals();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#facturationBody tr').forEach(row => {
                const qty = parseFloat(row.querySelector('.qty').value) || 0;
                const pu = parseFloat(row.querySelector('.pu').value) || 0;
                const total = qty * pu;
                row.querySelector('.total').textContent = total.toFixed(2);
                totalHT += total;
            });
            const tva = 0.2; // 20% TVA
            const totalTVA = totalHT * tva;
            const totalTTC = totalHT + totalTVA;
            document.getElementById('totalHT').textContent = totalHT.toFixed(2);
            document.getElementById('totalTVA').textContent = totalTVA.toFixed(2);
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2);
        }

        function validateBon() {
            const client = document.getElementById('clientName').value;
            const signatureClient = document.getElementById('signatureClient').value;
            const signatureTech = document.getElementById('signatureTech').value;
            const prestations = document.querySelectorAll('#facturationBody tr');
            const paymentMode = document.getElementById('paymentMode').value;
            const paymentDelay = document.getElementById('paymentDelay').value;
            const observations = document.getElementById('observations').value;

            if (!client) { alert("Nom client obligatoire."); return; }
            if (!prestations.length) { alert("Ajoutez une prestation."); return; }
            if (!paymentMode) { alert("Mode de paiement requis."); return; }
            if (!paymentDelay) { alert("D√©lai de paiement requis."); return; }
            if (!signatureClient || !signatureTech) { alert("Signatures obligatoires."); return; }

            const bonData = {
                client: client,
                lieu: document.getElementById('lieu').value,
                prestations: Array.from(prestations).map(row => ({
                    code: row.querySelector('.code').value,
                    designation: row.querySelector('.designation').value,
                    qty: row.querySelector('.qty').value,
                    pu: row.querySelector('.pu').value,
                    total: row.querySelector('.total').textContent
                })),
                paymentMode: paymentMode,
                paymentDelay: paymentDelay,
                observations: observations,
                signatureClient: signatureClient,
                signatureTech: signatureTech,
                date: document.getElementById('signatureDate').value
            };

            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            drafts['bon_intervention'] = bonData;
            localStorage.setItem('drafts', JSON.stringify(drafts));

            alert('Bon valid√© et sauvegard√© !');
        }

        function generatePDF() {
            const element = document.querySelector('.container');
            const opt = {
                margin: 1,
                filename: 'bon_intervention.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function sendEmail() {
            const bonData = JSON.parse(localStorage.getItem('drafts'))?.bon_intervention;
            if (!bonData) { alert('Validez le bon d‚Äôabord.'); return; }
            alert('Envoi email non disponible sans serveur. Donn√©es pr√™tes : ' + JSON.stringify(bonData));
        }
    </script>
</body>
</html>