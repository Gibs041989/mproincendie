<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'intervention</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <style>
        .facturation-section { display: flex; gap: 20px; margin-bottom: 20px; }
        .prestations { flex: 1; }
        .facturation-section table { width: 100%; border-collapse: collapse; }
        .facturation-section th, td { padding: 10px; border: 1px solid #ddd; }
        .facturation-section input, select, textarea { 
            width: 100%; padding: 8px; font-size: 16px; border: 1px solid #ccc; border-radius: 4px; 
        }
        .facturation-section th:nth-child(1) { width: 16%; } /* Code article */
        .facturation-section th:nth-child(2) { width: 38%; } /* D√©signation */
        .facturation-section th:nth-child(3) { width: 10%; } /* Qt√© */
        .facturation-section th:nth-child(4) { width: 18%; } /* PU HT */
        .facturation-section th:nth-child(5) { width: 18%; } /* Total HT */
        .facturation-section tr { cursor: pointer; }
        .facturation-section tr.active { background: #f0f0f0; }
        .action-buttons { display: none; text-align: right; margin: 5px 0; }
        .action-buttons button { font-size: 16px; padding: 5px 10px; margin-left: 10px; }
        .validate-btn { color: #00ff00; }
        .delete-btn { color: #ff0000; }
        .totals-table { 
            width: 80px; border-collapse: collapse; 
            float: right; margin-left: 10px; 
        }
        .totals-table th, .totals-table td { 
            border: 1px solid #ddd; padding: 4px 4px; font-size: 13px; text-align: right; 
            white-space: nowrap; 
        }
        .totals-table th { width: 55px; background: #f4f4f4; }
        .totals-table td { width: 25px; }
        textarea { resize: vertical; }
        canvas { border: 1px solid #ddd; display: block; margin-top: 5px; }
        .clear-btn { margin-top: 5px; padding: 5px; font-size: 14px; }
        .action-dialog { 
            position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); 
            background: #fff; border: 1px solid #ddd; padding: 20px; z-index: 1000; 
            box-shadow: 0 2px 10px rgba(0,0,0,0.1); text-align: center; 
        }
        .action-dialog button { margin: 0 10px; padding: 5px 10px; }
        .overlay { 
            position: fixed; top: 0; left: 0; width: 100%; height: 100%; 
            background: rgba(0,0,0,0.5); z-index: 999; 
        }
        @media (max-width: 600px) {
            .facturation-section { flex-direction: column; }
            .totals-table { 
                float: right; 
                width: 200px !important; 
                margin: 10px 10px 10px 0; 
            }
            .totals-table th, .totals-table td { width: auto; }
            .facturation-section table { font-size: 14px; }
            .facturation-section input, select, textarea { font-size: 14px; padding: 6px; }
            .facturation-section th, td { padding: 6px; }
            .facturation-section th:nth-child(1) { width: 15%; } /* Code article */
            .facturation-section th:nth-child(2) { width: 37%; } /* D√©signation */
            .facturation-section th:nth-child(3) { width: 8%; } /* Qt√© */
            .facturation-section th:nth-child(4) { width: 18%; } /* PU HT */
            .facturation-section th:nth-child(5) { width: 14%; } /* Total HT */
            canvas { width: 100%; height: 150px; }
            .action-dialog { width: 80%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßæ Bon d‚Äôintervention</h1>

        <section class="section">
            <h2>üë§ Client</h2>
            <label>Nom client: <input type="text" id="clientName" readonly></label>
            <label>Lieu d‚Äôintervention: <input type="text" id="lieu" readonly></label>
        </section>

        <section class="facturation-section">
            <div class="prestations">
                <h3>Prestations & mat√©riel</h3>
                <table id="facturationTable">
                    <thead>
                        <tr>
                            <th>Code article</th>
                            <th>D√©signation</th>
                            <th>Qt√©</th>
                            <th>PU HT ‚Ç¨</th>
                            <th>Total HT ‚Ç¨</th>
                        </tr>
                    </thead>
                    <tbody id="facturationBody"></tbody>
                </table>
                <button onclick="addPrestation()">‚ûï Ajouter une ligne</button>
            </div>
            <table class="totals-table">
                <tr><th>Total HT</th><td><span id="totalHT">0</span> ‚Ç¨</td></tr>
                <tr><th>Total TVA (20%)</th><td><span id="totalTVA">0</span> ‚Ç¨</td></tr>
                <tr><th>Total TTC</th><td><span id="totalTTC">0</span> ‚Ç¨</td></tr>
            </table>
            <div>
                <h3>Modalit√©s de r√®glement</h3>
                <label>Mode de paiement:
                    <select id="paymentMode">
                        <option value="">S√©lectionner</option>
                        <option value="Ch√®que">Ch√®que</option>
                        <option value="Virement">Virement</option>
                        <option value="Esp√®ces">Esp√®ces</option>
                    </select>
                </label>
                <label>D√©lai de paiement:
                    <select id="paymentDelay">
                        <option value="">S√©lectionner</option>
                        <option value="√Ä l‚Äôintervention">√Ä l‚Äôintervention</option>
                        <option value="√Ä r√©ception de facture">√Ä r√©ception de facture</option>
                        <option value="√Ä r√©ception de facture sous 30 jours">√Ä r√©ception de facture sous 30 jours</option>
                    </select>
                </label>
                <label>Observations:
                    <textarea id="observations" rows="4" placeholder="Texte libre"></textarea>
                </label>
            </div>
        </section>

        <section class="section">
            <h2>‚úçÔ∏è Signatures</h2>
            <label>Nom du client signataire: <input type="text" id="signatureClient"></label>
            <label>Signature client: 
                <canvas id="canvasClient" width="300" height="150"></canvas>
                <button class="clear-btn" onclick="clearCanvas('canvasClient')">Effacer</button>
            </label>
            <label>Fait √†: <input type="text" id="signatureLieu" value="Paris"></label>
            <label>Le: <input type="date" id="signatureDate" value="2025-05-17"></label>
            <label>Nom du technicien: <input type="text" id="signatureTech"></label>
            <label>Signature technicien: 
                <canvas id="canvasTech" width="300" height="150"></canvas>
                <button class="clear-btn" onclick="clearCanvas('canvasTech')">Effacer</button>
            </label>
        </section>

        <section class="section">
            <h2>üìÑ R√©sum√© CRM</h2>
            <p id="crmSummary">Aucun CRM associ√© (client particulier ou intervention directe).</p>
        </section>

        <section class="section nav-buttons">
            <button onclick="validateBon()">‚úÖ Valider le bon</button>
            <button onclick="generatePDF()">üìÑ G√©n√©rer le PDF</button>
            <button onclick="sendEmail()">üìß Envoyer par email</button>
            <a href="intervention.html"><button>‚¨ÖÔ∏è Retour</button></a>
        </section>

        <div class="navigation nav-buttons">
            <a href="index.html">üè† Accueil</a>
            <a href="client.html">üìÅ Clients</a>
            <a href="intervention.html">üõ†Ô∏è Intervention</a>
            <a href="parametres.html">‚öôÔ∏è Param√®tres</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (!interventionData.client || !interventionData.lieu) {
                alert('S√©lectionnez un client et un lieu depuis Interventions.');
                window.location.href = 'intervention.html';
                return;
            }
            document.getElementById('clientName').value = interventionData.client;
            document.getElementById('lieu').value = interventionData.lieu;
            if (interventionData.crm_extincteurs) {
                interventionData.crm_extincteurs.forEach(item => addPrestationFromCRM(item));
                document.getElementById('crmSummary').textContent = interventionData.crm_summary || 'R√©sum√© des op√©rations CRM charg√©.';
            }
            setupCanvas('canvasClient');
            setupCanvas('canvasTech');
        };

        let activeRow = null;

        function addPrestation() {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" placeholder="Code"></td>
                <td><input type="text" class="designation" placeholder="D√©signation"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="0" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="total">0</td>
            `;
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="validate-btn" onclick="validateRow(this.parentElement.parentElement, this.parentElement)">Valider <i class="fas fa-check-circle"></i></button>
                <button class="delete-btn" onclick="deleteRow(this.parentElement.parentElement, this.parentElement)">Supprimer <i class="fas fa-trash-alt"></i></button>
            `;
            const wrapper = document.createElement('tr');
            wrapper.appendChild(row);
            wrapper.appendChild(document.createElement('td')); // Cellule vide pour alignement
            const actionTd = document.createElement('td');
            actionTd.colSpan = 5;
            actionTd.appendChild(actionDiv);
            wrapper.appendChild(actionTd);
            tbody.appendChild(wrapper);
            activeRow = row;
            actionDiv.style.display = 'block';
            updateTotals();
        }

        function addPrestationFromCRM(item) {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" value="${item.code || ''}"></td>
                <td><input type="text" class="designation" value="${item.designation || ''}"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="${item.prix || 0}" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="total">0</td>
            `;
            const actionDiv = document.createElement('div');
            actionDiv.className = 'action-buttons';
            actionDiv.innerHTML = `
                <button class="validate-btn" onclick="validateRow(this.parentElement.parentElement, this.parentElement)">Valider <i class="fas fa-check-circle"></i></button>
                <button class="delete-btn" onclick="deleteRow(this.parentElement.parentElement, this.parentElement)">Supprimer <i class="fas fa-trash-alt"></i></button>
            `;
            const wrapper = document.createElement('tr');
            wrapper.appendChild(row);
            wrapper.appendChild(document.createElement('td')); // Cellule vide pour alignement
            const actionTd = document.createElement('td');
            actionTd.colSpan = 5;
            actionTd.appendChild(actionDiv);
            wrapper.appendChild(actionTd);
            tbody.appendChild(wrapper);
            activeRow = row;
            actionDiv.style.display = 'block';
            updateTotals();
        }

        function validateRow(row, actionDiv) {
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => input.readOnly = true);
            row.classList.add('active');
            actionDiv.style.display = 'none';
            activeRow = null;
            row.onclick = () => showActionDialog(row, actionDiv);
            updateTotals();
        }

        function deleteRow(row, actionDiv) {
            row.parentElement.remove();
            activeRow = null;
            updateTotals();
        }

        function showActionDialog(row, actionDiv) {
            const overlay = document.createElement('div');
            overlay.className = 'overlay';
            document.body.appendChild(overlay);

            const dialog = document.createElement('div');
            dialog.className = 'action-dialog';
            dialog.innerHTML = `
                <p>Que voulez-vous faire ?</p>
                <button onclick="editRow(this.parentElement, '${row.id}')">Modifier</button>
                <button onclick="deleteRowWithDialog(this.parentElement, '${row.id}')">Supprimer</button>
                <button onclick="closeDialog(this.parentElement)">Annuler</button>
            `;
            document.body.appendChild(dialog);
        }

        function editRow(dialog, rowId) {
            const row = document.getElementById(rowId);
            const inputs = row.querySelectorAll('input');
            inputs.forEach(input => input.readOnly = false);
            const actionDiv = row.nextElementSibling.nextElementSibling.querySelector('.action-buttons');
            actionDiv.style.display = 'block';
            activeRow = row;
            row.classList.remove('active');
            closeDialog(dialog);
        }

        function deleteRowWithDialog(dialog, rowId) {
            const row = document.getElementById(rowId);
            row.parentElement.remove();
            activeRow = null;
            updateTotals();
            closeDialog(dialog);
        }

        function closeDialog(dialog) {
            dialog.previousElementSibling.remove();
            dialog.remove();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#facturationBody tr:not(.action-buttons)').forEach(row => {
                if (!row.querySelector('.action-buttons')) {
                    const qty = parseFloat(row.querySelector('.qty').value) || 0;
                    const pu = parseFloat(row.querySelector('.pu').value) || 0;
                    const total = qty * pu;
                    row.querySelector('.total').textContent = total.toFixed(2);
                    totalHT += total;
                }
            });
            const tva = 0.2; // 20% TVA
            const totalTVA = totalHT * tva;
            const totalTTC = totalHT + totalTVA;
            document.getElementById('totalHT').textContent = totalHT.toFixed(2);
            document.getElementById('totalTVA').textContent = totalTVA.toFixed(2);
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2);
        }

        function setupCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            let drawing = false;

            ctx.lineWidth = 2;
            ctx.lineCap = 'round';
            ctx.strokeStyle = '#000';

            canvas.addEventListener('mousedown', startDrawing);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDrawing);
            canvas.addEventListener('mouseout', stopDrawing);

            canvas.addEventListener('touchstart', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousedown', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });

            canvas.addEventListener('touchmove', (e) => {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent('mousemove', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                canvas.dispatchEvent(mouseEvent);
            });

            canvas.addEventListener('touchend', (e) => {
                e.preventDefault();
                const mouseEvent = new MouseEvent('mouseup', {});
                canvas.dispatchEvent(mouseEvent);
            });

            function startDrawing(e) {
                drawing = true;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                ctx.beginPath();
                ctx.moveTo(x, y);
            }

            function draw(e) {
                if (!drawing) return;
                const rect = canvas.getBoundingClientRect();
                const x = e.clientX - rect.left;
                const y = e.clientY - rect.top;
                ctx.lineTo(x, y);
                ctx.stroke();
            }

            function stopDrawing() {
                drawing = false;
                ctx.closePath();
            }
        }

        function clearCanvas(canvasId) {
            const canvas = document.getElementById(canvasId);
            const ctx = canvas.getContext('2d');
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }

        function validateBon() {
            const client = document.getElementById('clientName').value;
            const signatureClient = document.getElementById('signatureClient').value;
            const signatureTech = document.getElementById('signatureTech').value;
            const prestations = document.querySelectorAll('#facturationBody tr:not(.action-buttons)');
            const paymentMode = document.getElementById('paymentMode').value;
            const paymentDelay = document.getElementById('paymentDelay').value;
            const observations = document.getElementById('observations').value;

            if (!client) { alert("Nom client obligatoire."); return; }
            if (!prestations.length) { alert("Ajoutez une prestation."); return; }
            if (!paymentMode) { alert("Mode de paiement requis."); return; }
            if (!paymentDelay) { alert("D√©lai de paiement requis."); return; }
            if (!signatureClient || !signatureTech) { alert("Noms des signataires obligatoires."); return; }

            const canvasClient = document.getElementById('canvasClient');
            const canvasTech = document.getElementById('canvasTech');
            const signatureClientData = canvasClient.toDataURL();
            const signatureTechData = canvasTech.toDataURL();

            const bonData = {
                client: client,
                lieu: document.getElementById('lieu').value,
                prestations: Array.from(prestations).map(row => ({
                    code: row.querySelector('.code').value,
                    designation: row.querySelector('.designation').value,
                    qty: row.querySelector('.qty').value,
                    pu: row.querySelector('.pu').value,
                    total: row.querySelector('.total').textContent
                })),
                paymentMode: paymentMode,
                paymentDelay: paymentDelay,
                observations: observations,
                signatureClient: signatureClient,
                signatureClientData: signatureClientData,
                signatureTech: signatureTech,
                signatureTechData: signatureTechData,
                date: document.getElementById('signatureDate').value
            };

            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            drafts['bon_intervention'] = bonData;
            localStorage.setItem('drafts', JSON.stringify(drafts));

            alert('Bon valid√© et sauvegard√© !');
        }

        function generatePDF() {
            const element = document.querySelector('.container');
            const opt = {
                margin: 1,
                filename: 'bon_intervention.pdf',
                image: { type: 'jpeg', quality: 0.98 },
                html2canvas: { scale: 2 },
                jsPDF: { unit: 'in', format: 'letter', orientation: 'portrait' }
            };
            html2pdf().set(opt).from(element).save();
        }

        function sendEmail() {
            const bonData = JSON.parse(localStorage.getItem('drafts'))?.bon_intervention;
            if (!bonData) { alert('Validez le bon d‚Äôabord.'); return; }
            alert('Envoi email non disponible sans serveur. Donn√©es pr√™tes : ' + JSON.stringify(bonData));
        }
    </script>
</body>
</html>