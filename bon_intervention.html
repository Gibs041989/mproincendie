<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'intervention</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .facturation-section { display: grid; gap: 20px; margin-bottom: 20px; }
        .facturation-section table { width: 100%; border-collapse: collapse; }
        .facturation-section th, td { padding: 8px; border: 1px solid #ddd; }
        .facturation-section input, select { width: 100%; padding: 5px; }
        .facturation-section button { padding: 10px; font-size: 16px; }
        .totals { font-weight: bold; }
        @media (max-width: 600px) {
            .facturation-section { grid-template-columns: 1fr; }
            .facturation-section table { font-size: 14px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üßæ Bon d‚Äôintervention</h1>

        <section class="section">
            <h2>üë§ Client</h2>
            <label>Nom client: <input type="text" id="clientName" readonly></label>
            <label>Lieu d‚Äôintervention: <input type="text" id="lieu" readonly></label>
        </section>

        <section class="facturation-section">
            <h2>üì¶ Facturation</h2>
            <div>
                <h3>Prestations & mat√©riel</h3>
                <table id="facturationTable">
                    <thead>
                        <tr>
                            <th>Code</th>
                            <th>D√©signation</th>
                            <th>Qt√©</th>
                            <th>PU ‚Ç¨</th>
                            <th>Total ‚Ç¨</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody id="facturationBody"></tbody>
                </table>
                <button onclick="addPrestation()">‚ûï Ajouter une ligne</button>
                <p class="totals">Montant total HT: <span id="totalHT">0</span> ‚Ç¨</p>
                <p class="totals">Montant TTC: <span id="totalTTC">0</span> ‚Ç¨</p>
            </div>
            <div>
                <h3>Modalit√©s de r√®glement</h3>
                <label>Mode de paiement:
                    <select id="paymentMode"></select>
                </label>
                <label>D√©lai de paiement:
                    <select id="paymentDelay"></select>
                </label>
            </div>
        </section>

        <section class="section">
            <h2>‚úçÔ∏è Signatures</h2>
            <label>Nom du client signataire: <input type="text" id="signatureClient"></label>
            <label>Fait √†: <input type="text" id="signatureLieu" value="Paris"></label>
            <label>Le: <input type="date" id="signatureDate" value="2025-05-17"></label>
            <label>Nom du technicien: <input type="text" id="signatureTech"></label>
        </section>

        <section class="section">
            <h2>üìÑ R√©sum√© CRM</h2>
            <p id="crmSummary">Aucun CRM associ√© (client particulier ou intervention directe).</p>
        </section>

        <section class="section nav-buttons">
            <button onclick="validateBon()">‚úÖ Valider le bon</button>
            <button onclick="generatePDF()">üìÑ G√©n√©rer le PDF</button>
            <button onclick="sendEmail()">üìß Envoyer par email</button>
            <a href="intervention.html"><button>‚¨ÖÔ∏è Retour</button></a>
        </section>

        <div class="navigation nav-buttons">
            <a href="index.html">üè† Accueil</a>
            <a href="client.html">üìÅ Clients</a>
            <a href="intervention.html">üõ†Ô∏è Intervention</a>
            <a href="parametres.html">‚öôÔ∏è Param√®tres</a>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script>
        window.onload = () => {
            const interventionData = JSON.parse(localStorage.getItem('currentIntervention')) || {};
            if (!interventionData.client || !interventionData.lieu) {
                alert('S√©lectionnez un client et un lieu depuis Interventions.');
                window.location.href = 'intervention.html';
                return;
            }
            document.getElementById('clientName').value = interventionData.client;
            document.getElementById('lieu').value = interventionData.lieu;
            if (interventionData.crm_extincteurs) {
                interventionData.crm_extincteurs.forEach(item => addPrestationFromCRM(item));
                document.getElementById('crmSummary').textContent = interventionData.crm_summary || 'R√©sum√© des op√©rations CRM charg√©.';
            }
            loadPaymentOptions();
        };

        function loadPaymentOptions() {
            const settings = JSON.parse(localStorage.getItem('settings')) || {
                paymentModes: ['virement', 'cheque', 'cb', 'especes'],
                paymentDelays: ['reception', '30jours', 'finmois']
            };
            const paymentModeSelect = document.getElementById('paymentMode');
            const paymentDelaySelect = document.getElementById('paymentDelay');
            paymentModeSelect.innerHTML = '<option value="">S√©lectionner</option>';
            paymentDelaySelect.innerHTML = '<option value="">S√©lectionner</option>';
            settings.paymentModes.forEach(mode => {
                const option = document.createElement('option');
                option.value = mode;
                option.textContent = mode;
                paymentModeSelect.appendChild(option);
            });
            settings.paymentDelays.forEach(delay => {
                const option = document.createElement('option');
                option.value = delay;
                option.textContent = delay;
                paymentDelaySelect.appendChild(option);
            });
        }

        function addPrestation() {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" placeholder="Code"></td>
                <td><input type="text" class="designation" placeholder="D√©signation"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="0" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="total">0</td>
                <td><button onclick="this.parentElement.parentElement.remove(); updateTotals()">Supprimer</button></td>
            `;
            tbody.appendChild(row);
            updateTotals();
        }

        function addPrestationFromCRM(item) {
            const tbody = document.getElementById('facturationBody');
            const row = document.createElement('tr');
            row.innerHTML = `
                <td><input type="text" class="code" value="${item.code || ''}"></td>
                <td><input type="text" class="designation" value="${item.designation || ''}"></td>
                <td><input type="number" class="qty" value="1" min="1" onchange="updateTotals()"></td>
                <td><input type="number" class="pu" value="${item.prix || 0}" min="0" step="0.01" onchange="updateTotals()"></td>
                <td class="