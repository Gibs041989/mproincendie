<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'Intervention - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    <script src="https://cdn.emailjs.com/dist/email.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/signature_pad@4.2.0/dist/signature_pad.umd.min.js"></script>
    <style>
        .section { margin-bottom: 20px; padding: 10px; }
        .client-info { margin-bottom: 20px; padding: 15px; background: #f9fafb; border-radius: 8px; }
        .client-info p { font-size: 15px; margin: 5px 0; }
        #prestationsTable th, #prestationsTable td { padding: 12px; font-size: 15px; }
        #prestationsTable input, #prestationsTable select { padding: 10px; font-size: 15px; }
        .add-btn { background: #10b981; color: white; padding: 10px 20px; border-radius: 8px; }
        .add-btn:hover { background: #059669; }
        .validated { background: #f0fdf4; }
        .check-icon { color: #10b981; margin-left: 8px; }
        .check-icon.disabled { color: #ccc; }
        .edit-icon { color: #3b82f6; }
        .delete-icon { color: #ef4444; }
        .shortcuts { display: flex; justify-content: space-evenly; gap: 15px; margin-top: 20px; }
        .shortcut-btn { background: #9ca3af; color: white; padding: 12px; border-radius: 8px; }
        .shortcut-btn:hover { background: #8b929e; }
        .signature-container { margin-top: 20px; }
        #signaturePad { border: 1px solid #ddd; border-radius: 8px; width: 100%; height: 150px; }
        @media (max-width: 600px) {
            #prestationsTable td:before { font-size: 14px; }
            #prestationsTable td select, #prestationsTable td input { font-size: 14px; padding: 8px; }
            .shortcuts { flex-wrap: wrap; gap: 10px; }
            .shortcut-btn { padding: 10px; }
        }
        @media print {
            .shortcuts, .add-btn, .signature-container canvas { display: none; }
            .signature-container img { display: block; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bon d'Intervention</h1>

        <section class="section client-info">
            <h2>Client</h2>
            <p><strong>Nom :</strong> <span id="clientName"></span></p>
            <p><strong>Adresse :</strong> <span id="clientAddress"></span></p>
            <p><strong>Lieu d‚Äôintervention :</strong> <span id="locationAddress"></span></p>
        </section>

        <section class="section">
            <h2>R√©sum√© CRM Extincteurs</h2>
            <table id="crmExtincteursTable">
                <thead>
                    <tr><th>ID</th><th>Type</th><th>√âtat</th><th>Abr√©viation</th></tr>
                </thead>
                <tbody id="crmExtincteursBody"></tbody>
            </table>
        </section>

        <section class="section">
            <h2>D√©tails Intervention</h2>
            <div class="info-container">
                <div class="info-box">
                    <label for="interventionDate">Date *</label>
                    <input type="date" id="interventionDate" required>
                </div>
                <div class="info-box">
                    <label for="technician">Technicien *</label>
                    <input type="text" id="technician" placeholder="Nom du technicien" required>
                </div>
                <div class="info-box">
                    <label for="status">Statut</label>
                    <select id="status">
                        <option value="en_cours">En cours</option>
                        <option value="termine">Termin√©</option>
                        <option value="annule">Annul√©</option>
                    </select>
                </div>
                <div class="info-box">
                    <label for="paymentTerms">Modalit√©s de paiement *</label>
                    <select id="paymentTerms" required>
                        <option value="virement_30j">Virement 30 jours</option>
                        <option value="cheque">Ch√®que √† r√©ception</option>
                        <option value="especes">Esp√®ces</option>
                    </select>
                </div>
            </div>
        </section>

        <section class="section">
            <h2>üìã Prestations & Mat√©riel</h2>
            <table id="prestationsTable">
                <thead>
                    <tr><th>D√©signation</th><th>Qt√©</th><th>PU HT (‚Ç¨)</th><th>Total HT</th></tr>
                </thead>
                <tbody id="prestationsBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow()">‚ûï Ajouter une ligne</button>
            <table id="totalsTable">
                <tr><th>Total HT</th><td id="totalHT">0.00 ‚Ç¨</td></tr>
                <tr><th>TVA 20%</th><td id="tva">0.00 ‚Ç¨</td></tr>
                <tr><th>Total TTC</th><td id="totalTTC">0.00 ‚Ç¨</td></tr>
            </table>
        </section>

        <section class="section signature-container">
            <h2>Signature Client</h2>
            <canvas id="signaturePad"></canvas>
            <button class="secondary" onclick="clearSignature()">Effacer</button>
            <img id="signatureImage" style="display: none;">
        </section>

        <div class="shortcuts">
            <button class="shortcut-btn" onclick="saveIntervention()" title="Enregistrer"><i class="fas fa-save"></i></button>
            <button class="shortcut-btn" onclick="printIntervention()" title="PDF"><i class="fas fa-file-pdf"></i></button>
            <button class="shortcut-btn" onclick="sendIntervention()" title="Envoyer"><i class="fas fa-envelope"></i></button>
            <button class="shortcut-btn" onclick="cancelIntervention()" title="Annuler"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        emailjs.init("YOUR_EMAILJS_USER_ID"); // Remplacer par ton ID EmailJS
        let index = 0;
        let isValidated = false;
        const articlesDB = [
            { name: "Extincteur CO2 5kg", unitPrice: 150.00 },
            { name: "Maintenance RIA", unitPrice: 80.00 },
            { name: "BAES Type 1", unitPrice: 120.00 }
        ];

        // Initialiser SignaturePad
        const canvas = document.getElementById('signaturePad');
        const signaturePad = new SignaturePad(canvas, {
            penColor: 'black',
            backgroundColor: 'white'
        });
        function resizeCanvas() {
            const ratio = Math.max(window.devicePixelRatio || 1, 1);
            canvas.width = canvas.offsetWidth * ratio;
            canvas.height = canvas.offsetHeight * ratio;
            canvas.getContext('2d').scale(ratio, ratio);
            signaturePad.clear();
        }
        window.addEventListener('resize', resizeCanvas);
        resizeCanvas();
        function clearSignature() {
            signaturePad.clear();
            document.getElementById('signatureImage').src = '';
            document.getElementById('signatureImage').style.display = 'none';
        }

        function addRow() {
            const tbody = document.getElementById('prestationsBody');
            const row = document.createElement('tr');
            row.id = `row-${index}`;
            row.innerHTML = `
                <td data-label="D√©signation">
                    <select class="designation" id="des-${index}" onchange="onInputChange(${index})">
                        <option value="">--Choisir--</option>
                        ${articlesDB.map(article => `<option value="${article.name}" data-price="${article.unitPrice}">${article.name}</option>`).join('')}
                        <option value="custom">Autre</option>
                    </select>
                    <input type="text" class="custom-designation" id="cust-${index}" style="display:none;" placeholder="Saisie libre" oninput="onInputChange(${index})">
                    <span class="icon-holder">
                        <i class="fas fa-check-circle check-icon" onclick="validateRow(${index})" title="Valider"></i>
                        <i class="fas fa-pen edit-icon disabled" title="Modifier"></i>
                        <i class="fas fa-trash delete-icon disabled" title="Supprimer"></i>
                    </span>
                </td>
                <td data-label="Qt√©"><input type="number" class="quantity" id="qte-${index}" min="1" onblur="onInputChange(${index})"/></td>
                <td data-label="PU HT"><input type="number" step="0.01" class="unitPrice" id="pu-${index}" placeholder="en ‚Ç¨" onblur="onInputChange(${index})"/></td>
                <td data-label="Total HT"><input type="number" class="total" id="total-${index}" readonly /></td>`;
            tbody.appendChild(row);
            index++;
            savePrestations();
            updateTotals();
        }

        function onInputChange(i) {
            const row = document.getElementById(`row-${i}`);
            const desSel = document.getElementById(`des-${i}`);
            const custInput = document.getElementById(`cust-${i}`);
            const qteInput = document.getElementById(`qte-${i}`);
            const puInput = document.getElementById(`pu-${i}`);
            const total = document.getElementById(`total-${i}`);

            if (desSel.value === "custom") {
                custInput.style.display = "block";
                puInput.value = "";
            } else {
                custInput.style.display = "none";
                if (desSel.selectedOptions[0].dataset.price) {
                    puInput.value = desSel.selectedOptions[0].dataset.price;
                }
            }

            const qte = parseFloat(qteInput.value) || 0;
            const pu = parseFloat(puInput.value) || 0;
            if (qte <= 0 || isNaN(qte)) {
                qteInput.classList.add('error');
                total.value = "";
                return;
            }
            if (pu <= 0 || isNaN(pu)) {
                puInput.classList.add('error');
                total.value = "";
                return;
            }
            qteInput.classList.remove('error');
            puInput.classList.remove('error');
            total.value = (qte * pu).toFixed(2);
            savePrestations();
            updateTotals();
        }

        function validateRow(i) {
            const row = document.getElementById(`row-${i}`);
            const desSel = document.getElementById(`des-${i}`);
            const custInput = document.getElementById(`cust-${i}`);
            const qteInput = document.getElementById(`qte-${i}`);
            const puInput = document.getElementById(`pu-${i}`);
            const designation = desSel.value === "custom" ? custInput.value.trim() : desSel.value;
            const quantity = parseFloat(qteInput.value) || 0;
            const unitPrice = parseFloat(puInput.value) || 0;

            if (!designation || quantity <= 0 || unitPrice <= 0) {
                alert('Remplir d√©signation, quantit√© (>0) et PU HT (>0).');
                return;
            }
            row.querySelectorAll('input, select').forEach(input => input.disabled = true);
            row.classList.add('validated');
            row.querySelector('.icon-holder').innerHTML = `
                <i class="fas fa-check-circle check-icon disabled" title="Valid√©"></i>
                <i class="fas fa-pen edit-icon" onclick="enableEdit(${index})" title="Modifier"></i>
                <i class="fas fa-trash delete-icon" onclick="deleteRow(${index})" title="Supprimer"></i>`;
            savePrestations();
            updateTotals();
            addRow();
        }

        function enableEdit(i) {
            const row = document.getElementById(`row-${i}`);
            row.querySelectorAll('input, select').forEach(input => input.disabled = false);
            row.classList.remove('validated');
            row.querySelector('.icon-holder').innerHTML = `
                <i class="fas fa-check-circle check-icon" onclick="validateRow(${i})" title="Valider"></i>
                <i class="fas fa-pen edit-icon disabled" title="Modifier"></i>
                <i class="fas fa-trash delete-icon disabled" title="Supprimer"></i>`;
            savePrestations();
            updateTotals();
        }

        function deleteRow(i) {
            document.getElementById(`row-${i}`)?.remove();
            savePrestations();
            updateTotals();
        }

        function savePrestations() {
            const prestationsData = [];
            document.querySelectorAll('#prestationsBody tr').forEach(row => {
                const select = row.querySelector('.designation');
                const custom = row.querySelector('.custom-designation');
                const designation = select?.value === 'custom' ? custom?.value.trim() : select?.value;
                const quantity = row.querySelector('.quantity')?.value;
                const unitPrice = row.querySelector('.unitPrice')?.value;
                const total = row.querySelector('.total')?.value;
                if (designation && quantity && unitPrice && total) {
                    prestationsData.push({ designation, quantity, unitPrice, total });
                }
            });
            try {
                localStorage.setItem('prestationsData', JSON.stringify(prestationsData));
            } catch {
                alert('Erreur sauvegarde : stockage plein.');
            }
        }

        function loadPrestations() {
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            const tbody = document.getElementById('prestationsBody');
            prestationsData.forEach((item, i) => {
                const isCustom = !articlesDB.some(article => article.name === item.designation);
                const row = document.createElement('tr');
                row.id = `row-${i}`;
                row.innerHTML = `
                    <td data-label="D√©signation">
                        <select class="designation" id="des-${i}" onchange="onInputChange(${i})" disabled>
                            <option value="">--Choisir--</option>
                            ${articlesDB.map(article => `<option value="${article.name}" data-price="${article.unitPrice}" ${article.name === item.designation ? 'selected' : ''}>${article.name}</option>`).join('')}
                            <option value="custom" ${isCustom ? 'selected' : ''}>Autre</option>
                        </select>
                        <input type="text" class="custom-designation" id="cust-${i}" value="${isCustom ? item.designation : ''}" style="display:${isCustom ? 'block' : 'none'};" disabled>
                        <span class="icon-holder">
                            <i class="fas fa-check-circle check-icon disabled" title="Valid√©"></i>
                            <i class="fas fa-pen edit-icon" onclick="enableEdit(${i})" title="Modifier"></i>
                            <i class="fas fa-trash delete-icon" onclick="deleteRow(${i})" title="Supprimer"></i>
                        </span>
                    </td>
                    <td data-label="Qt√©"><input type="number" class="quantity" id="qte-${i}" value="${item.quantity}" min="1" onblur="onInputChange(${i})" disabled/></td>
                    <td data-label="PU HT"><input type="number" step="0.01" class="unitPrice" id="pu-${i}" value="${item.unitPrice}" onblur="onInputChange(${i})" disabled/></td>
                    <td data-label="Total HT"><input type="number" class="total" id="total-${i}" value="${item.total}" readonly /></td>`;
                row.classList.add('validated');
                tbody.appendChild(row);
            });
            index = prestationsData.length;
            updateTotals();
            if (!prestationsData.length) addRow();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#prestationsBody tr').forEach(row => {
                const total = parseFloat(row.querySelector('.total')?.value) || 0;
                if (total > 0) totalHT += total;
            });
            const tva = totalHT * 0.2;
            const totalTTC = totalHT + tva;
            document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
            document.getElementById('tva').textContent = tva.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
        }

        function loadClientInfo() {
            const intervention = JSON.parse(localStorage.getItem('currentIntervention') || '{}');
            document.getElementById('clientName').textContent = intervention.client || 'Non d√©fini';
            document.getElementById('clientAddress').textContent = intervention.adresse || 'Non d√©fini';
            const locationAddress = document.getElementById('locationAddress');
            const location = document.getElementById('locationSelect')?.value || intervention.locationAddress || '';
            locationAddress.textContent = location && location !== intervention.adresse ? location : 'M√™me adresse';
        }

        function loadCrmExtincteurs() {
            const extincteursData = JSON.parse(localStorage.getItem('extincteursData') || '[]');
            const tbody = document.getElementById('crmExtincteursBody');
            tbody.innerHTML = '';
            extincteursData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `<td>${item.id || 'N/A'}</td><td>${item.type || 'N/A'}</td><td>${item.etat || 'N/A'}</td><td>${item.abreviation || 'N/A'}</td>`;
                tbody.appendChild(row);
            });
        }

        function saveIntervention() {
            const clientData = {
                interventionDate: document.getElementById('interventionDate').value,
                technician: document.getElementById('technician').value.trim(),
                status: document.getElementById('status').value,
                paymentTerms: document.getElementById('paymentTerms').value
            };
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            if (!clientData.interventionDate || !clientData.technician || !clientData.paymentTerms) {
                alert('Champs obligatoires : Date, Technicien, Modalit√©s de paiement.');
                ['interventionDate', 'technician', 'paymentTerms'].forEach(id => {
                    if (!document.getElementById(id).value) document.getElementById(id).classList.add('error');
                });
                return;
            }
            if (!prestationsData.length) {
                alert('Ajoutez au moins une prestation valid√©e.');
                return;
            }
            if (signaturePad.isEmpty()) {
                alert('Signature client requise.');
                return;
            }
            isValidated = true;
            const signatureData = signaturePad.toDataURL();
            document.getElementById('signatureImage').src = signatureData;
            document.getElementById('signatureImage').style.display = 'block';
            localStorage.setItem('interventionData', JSON.stringify(clientData));
            localStorage.setItem('signatureData', signatureData);
            const crmData = JSON.parse(localStorage.getItem('crmData') || '[]');
            const intervention = JSON.parse(localStorage.getItem('currentIntervention') || '{}');
            crmData.push({
                date: clientData.interventionDate,
                intervention: `Intervention pour ${intervention.client || 'Client'}`,
                technician: clientData.technician,
                montantTTC: document.getElementById('totalTTC').textContent
            });
            localStorage.setItem('crmData', JSON.stringify(crmData));
            alert('Bon valid√© et enregistr√© !');
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
        }

        function printIntervention() {
            if (!isValidated) {
                alert('Veuillez valider le bon.');
                return;
            }
            const element = document.querySelector('.container');
            html2pdf().set({ filename: 'bon_intervention.pdf', margin: 10 }).from(element).save();
        }

        function sendIntervention() {
            if (!isValidated) {
                alert('Veuillez valider le bon.');
                return;
            }
            const clientData = JSON.parse(localStorage.getItem('interventionData') || '{}');
            const intervention = JSON.parse(localStorage.getItem('currentIntervention') || '{}');
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            const signatureData = localStorage.getItem('signatureData') || '';
            emailjs.send('YOUR_SERVICE_ID', 'YOUR_TEMPLATE_ID', {
                to_email: intervention.email || 'client@example.com',
                client: intervention.client,
                date: clientData.interventionDate,
                prestations: JSON.stringify(prestationsData),
                total: document.getElementById('totalTTC').textContent,
                signature: signatureData
            }).then(() => alert('Email envoy√© !'), () => alert('Erreur envoi.'));
        }

        function cancelIntervention() {
            if (confirm('Annuler le bon d‚Äôintervention ?')) {
                localStorage.removeItem('interventionData');
                localStorage.removeItem('prestationsData');
                localStorage.removeItem('signatureData');
                window.location.reload();
            }
        }

        window.onload = () => {
            loadClientInfo();
            loadCrmExtincteurs();
            loadPrestations();
        };
    </script>
</body>
</html>