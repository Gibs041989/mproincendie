<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bon d'Intervention - MPro Incendie</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css"/>
    <style>
        body { font-family: sans-serif; padding: 20px; background: #f9fafb; }
        .container { max-width: 100%; box-sizing: border-box; }
        .section { margin-bottom: 20px; padding: 10px; border-bottom: 1px solid #eee; }
        h1, h2 { color: #222; }
        .info-container { display: flex; flex-wrap: wrap; gap: 20px; }
        .info-box { flex: 1; min-width: 250px; }
        .info-box label { font-weight: bold; font-size: 14px; color: #444; }
        .info-box input, .info-box select, .info-box textarea {
            width: 100%; padding: 6px; margin-top: 5px; font-size: 13px;
            border: 1px solid #ccc; border-radius: 3px; box-sizing: border-box;
        }
        .info-box input.error, .info-box select.error, .info-box textarea.error { border: 1px solid red; }
        table { width: 100%; border-collapse: collapse; margin-bottom: 20px; }
        th, td { border: 1px solid #ddd; padding: 8px; font-size: 14px; vertical-align: top; }
        th { background-color: #f3f4f6; }
        th:nth-child(1), td:nth-child(1) { width: 40%; }
        th:nth-child(2), td:nth-child(2) { width: 15%; }
        th:nth-child(3), td:nth-child(3) { width: 20%; }
        th:nth-child(4), td:nth-child(4) { width: 25%; }
        #totalsTable { width: 100%; max-width: 220px; margin: 10px 0; border-collapse: collapse; }
        #totalsTable th, #totalsTable td { padding: 6px; border: 1px solid #ddd; text-align: left; font-size: 13px; color: #222; font-weight: 500; }
        #totalsTable th { background-color: #f0f0f0; }
        #totalsTable td { background-color: #fff; }
        .add-btn {
            background-color: #10b981; color: white; padding: 6px 12px;
            border: none; border-radius: 5px; font-size: 13px;
            display: inline-flex; align-items: center; gap: 6px;
            cursor: pointer; margin: 10px 0; justify-content: flex-start;
        }
        .add-btn:hover { background-color: #059669; }
        .validated { background-color: #f0fdf4; }
        .check-icon { color: #10b981; margin-left: 6px; cursor: pointer; }
        .check-icon.disabled { color: #ccc; cursor: not-allowed; }
        .edit-icon, .delete-icon {
            margin-left: 6px; cursor: pointer;
        }
        .edit-icon { color: #3b82f6; }
        .delete-icon { color: #ef4444; }
        .action-buttons { margin-top: 8px; display: flex; justify-content: flex-start; gap: 8px; }
        .action-buttons button { font-size: 14px; padding: 6px 12px; border: none; border-radius: 4px; cursor: pointer; }
        .action-buttons .validate-modif-btn { background: #10b981; color: white; }
        .shortcuts { display: flex; gap: 10px; justify-content: center; margin-top: 20px; }
        .shortcut-btn { background: #3b82f6; color: white; padding: 8px; border-radius: 5px; cursor: pointer; }
        .shortcut-btn:hover { background: #2563eb; }
        .shortcut-btn i { font-size: 16px; }
        .save-btn {
            background-color: #3b82f6; color: white; padding: 8px 16px;
            border: none; border-radius: 5px; font-size: 14px;
            cursor: pointer; margin-top: 20px; width: 100%;
        }
        .save-btn:hover { background-color: #2563eb; }
        input[type='number'], input[type='text'], select, textarea {
            width: 100%; padding: 6px; font-size: 13px;
            box-sizing: border-box; border: 1px solid #ccc; border-radius: 3px;
        }
        input[type='number'].no-arrows {
            -webkit-appearance: none;
            -moz-appearance: textfield;
            appearance: none;
        }
        input[type='number'].no-arrows::-webkit-inner-spin-button,
        input[type='number'].no-arrows::-webkit-outer-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        @media (max-width: 600px) {
            body { padding: 10px; }
            .section { margin-bottom: 20px; padding: 8px; }
            .info-container { flex-direction: column; }
            table th { display: none; }
            table tr { display: block; margin-bottom: 8px; border: 1px solid #ddd; padding: 8px; border-radius: 5px; background: #fff; }
            table td:nth-child(1) { display: block; width: 100%; padding: 4px 0; }
            table td:nth-child(1) select, table td:nth-child(1) input { width: 100%; font-size: 11px; padding: 6px; }
            .prestations-row { display: flex; gap: 3%; align-items: flex-start; margin-top: 4px; }
            table td:nth-child(2) { flex: 0 0 25%; padding: 4px 0; }
            table td:nth-child(3) { flex: 0 0 35%; padding: 4px 0; }
            table td:nth-child(4) { flex: 0 0 40%; padding: 4px 0; }
            table td select, table td input { width: 100%; font-size: 11px; padding: 6px; }
            table td:before { content: attr(data-label); display: block; font-size: 10px; font-weight: bold; color: #444; margin-bottom: 2px; }
            table td:nth-child(1):before { content: "D√©signation"; }
            table td:nth-child(2):before { content: "Qt√©"; }
            table td:nth-child(3):before { content: "PU HT (‚Ç¨)"; }
            table td:nth-child(4):before { content: "Total HT (‚Ç¨)"; }
            .action-buttons { justify-content: flex-start; margin-top: 8px; }
            .action-buttons button { font-size: 12px; padding: 6px 10px; }
            #totalsTable { max-width: 160px; margin-left: auto; margin-right: 0; }
            #totalsTable th, #totalsTable td { padding: 4px; font-size: 12px; }
            .add-btn { font-size: 12px; padding: 5px 10px; }
            .save-btn { width: 100%; }
            .shortcuts { flex-wrap: wrap; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Bon d'Intervention - MPro Incendie</h1>

        <!-- Section R√©sum√© CRM -->
        <section class="section">
            <h2>R√©sum√© CRM</h2>
            <table id="crmTable">
                <thead>
                    <tr>
                        <th>Date</th>
                        <th>Intervention</th>
                        <th>Technicien</th>
                        <th>Montant TTC</th>
                    </tr>
                </thead>
                <tbody id="crmBody">
                    <!-- Donn√©es charg√©es dynamiquement -->
                </tbody>
            </table>
        </section>

        <!-- Section Informations Client -->
        <section class="section">
            <h2>Informations Client</h2>
            <div class="info-container">
                <div class="info-box">
                    <label for="clientName">Nom du client *</label>
                    <input type="text" id="clientName" placeholder="Nom du client">
                </div>
                <div class="info-box">
                    <label for="clientAddress">Adresse</label>
                    <input type="text" id="clientAddress" placeholder="Adresse">
                </div>
                <div class="info-box">
                    <label for="clientPhone">T√©l√©phone</label>
                    <input type="text" id="clientPhone" placeholder="T√©l√©phone">
                </div>
            </div>
        </section>

        <!-- Section D√©tails Intervention -->
        <section class="section">
            <h2>D√©tails Intervention</h2>
            <div class="info-container">
                <div class="info-box">
                    <label for="interventionDate">Date *</label>
                    <input type="date" id="interventionDate">
                </div>
                <div class="info-box">
                    <label for="technician">Technicien *</label>
                    <input type="text" id="technician" placeholder="Nom du technicien">
                </div>
                <div class="info-box">
                    <label for="status">Statut</label>
                    <select id="status">
                        <option value="en_cours">En cours</option>
                        <option value="termine">Termin√©</option>
                        <option value="annule">Annul√©</option>
                    </select>
                </div>
                <div class="info-box">
                    <label for="paymentTerms">Modalit√©s de paiement</label>
                    <select id="paymentTerms">
                        <option value="virement_30j">Virement 30 jours</option>
                        <option value="cheque">Ch√®que √† r√©ception</option>
                        <option value="especes">Esp√®ces</option>
                    </select>
                </div>
            </div>
        </section>

        <!-- Section Prestations & Mat√©riel -->
        <section class="section">
            <h2>üìã Prestations & Mat√©riel</h2>
            <table id="prestationsTable">
                <thead>
                    <tr>
                        <th>D√©signation</th>
                        <th>Qt√©</th>
                        <th>PU HT (‚Ç¨)</th>
                        <th>Total HT</th>
                    </tr>
                </thead>
                <tbody id="prestationsBody"></tbody>
            </table>
            <button class="add-btn" onclick="addRow()">‚ûï Ajouter une ligne</button>
            <table id="totalsTable">
                <tr><th>Total HT</th><td id="totalHT">0.00 ‚Ç¨</td></tr>
                <tr><th>TVA 20%</th><td id="tva">0.00 ‚Ç¨</td></tr>
                <tr><th>Total TTC</th><td id="totalTTC">0.00 ‚Ç¨</td></tr>
            </table>
        </section>

        <!-- Raccourcis -->
        <div class="shortcuts">
            <button class="shortcut-btn" onclick="saveIntervention()" title="Enregistrer"><i class="fas fa-save"></i></button>
            <button class="shortcut-btn" onclick="printIntervention()" title="Imprimer"><i class="fas fa-print"></i></button>
            <button class="shortcut-btn" onclick="sendIntervention()" title="Envoyer"><i class="fas fa-envelope"></i></button>
            <button class="shortcut-btn" onclick="cancelIntervention()" title="Annuler"><i class="fas fa-times"></i></button>
        </div>
    </div>

    <script>
        let index = 0;
        let isValidated = false;
        const articlesDB = [
            { name: "Extincteur CO2 5kg", unitPrice: 150.00 },
            { name: "Maintenance RIA", unitPrice: 80.00 },
            { name: "BAES Type 1", unitPrice: 120.00 }
        ];

        function addRow() {
            const tbody = document.getElementById('prestationsBody');
            const rows = document.querySelectorAll('#prestationsBody tr:not([id*="button-row"])');
            const newIndex = index++;
            const row = document.createElement('tr');
            row.id = `row-${newIndex}`;
            row.innerHTML = `
                <td data-label="D√©signation">
                    <select class="designation" id="des-${newIndex}" onchange="onInputChange(${newIndex})">
                        <option value="">--Choisir--</option>
                        ${articlesDB.map(article => `<option value="${article.name}" data-price="${article.unitPrice}">${article.name}</option>`).join('')}
                        <option value="custom">Autre (saisie manuelle)</option>
                    </select>
                    <input type="text" class="custom-designation" id="cust-${newIndex}" style="display:none;" placeholder="Saisie libre" oninput="onInputChange(${newIndex})">
                    <span class="icon-holder">
                        <i class="fas fa-check-circle check-icon" onclick="validateRow(${newIndex})" title="Valider"></i>
                        <i class="fas fa-pen edit-icon disabled" title="Modifier"></i>
                        <i class="fas fa-trash delete-icon disabled" title="Supprimer"></i>
                    </span>
                </td>
                <td data-label="Qt√©"><input type="number" class="quantity" id="qte-${newIndex}" min="1" onblur="onInputChange(${newIndex})"/></td>
                <td data-label="PU HT"><input type="text" inputmode="decimal" pattern="[0-9]*\.?[0-9]+" class="unitPrice" id="pu-${newIndex}" placeholder="en ‚Ç¨" onblur="onInputChange(${newIndex})"/></td>
                <td data-label="Prix Total HT"><input type="number" class="total no-arrows" id="total-${newIndex}" readonly /></td>`;
            tbody.appendChild(row);
            savePrestations();
            updateTotals();
        }

        function onInputChange(i) {
            const row = document.getElementById(`row-${i}`);
            const desSel = document.getElementById(`des-${i}`);
            const custInput = document.getElementById(`cust-${i}`);
            const qteInput = document.getElementById(`qte-${i}`);
            const puInput = document.getElementById(`pu-${i}`);
            const total = document.getElementById(`total-${i}`);
            let designation = "";

            if (desSel.value === "custom") {
                custInput.style.display = "block";
                designation = custInput.value.trim();
                puInput.value = "";
            } else {
                custInput.style.display = "none";
                designation = desSel.value;
                if (desSel.selectedOptions[0].dataset.price) {
                    puInput.value = desSel.selectedOptions[0].dataset.price;
                }
            }

            const qte = parseFloat(qteInput.value) || 0;
            const pu = parseFloat(puInput.value);
            if (isNaN(pu) || pu < 0) {
                puInput.style.border = '1px solid red';
                total.value = "";
                return;
            } else {
                puInput.style.border = '1px solid #ccc';
            }
            if (qte <= 0 && qteInput.value !== "") {
                qteInput.style.border = '1px solid red';
                total.value = "";
                return;
            } else {
                qteInput.style.border = '1px solid #ccc';
            }
            total.value = (qte > 0 && pu > 0) ? (qte * pu).toFixed(2) : "";
        }

        function validateRow(i) {
            const row = document.getElementById(`row-${i}`);
            const desSel = document.getElementById(`des-${i}`);
            const custInput = document.getElementById(`cust-${i}`);
            const qteInput = document.getElementById(`qte-${i}`);
            const puInput = document.getElementById(`pu-${i}`);
            const designation = desSel.value === "custom" ? custInput.value.trim() : desSel.value;
            const quantity = parseFloat(qteInput.value) || 0;
            const unitPrice = parseFloat(puInput.value) || 0;
            if (!designation || quantity <= 0 || unitPrice <= 0) {
                alert('Veuillez remplir d√©signation, quantit√© (>0) et PU HT (>0).');
                return;
            }
            row.querySelectorAll('input, select').forEach(input => input.disabled = true);
            row.classList.add('validated');
            const iconHolder = row.querySelector('.icon-holder');
            iconHolder.innerHTML = `
                <i class="fas fa-check-circle check-icon disabled" title="Valid√©"></i>
                <i class="fas fa-pen edit-icon" onclick="enableEdit(${i})" title="Modifier"></i>
                <i class="fas fa-trash delete-icon" onclick="deleteRow(${i})" title="Supprimer"></i>`;
            const buttonRow = document.getElementById(`button-row-${i}`);
            if (buttonRow) buttonRow.remove();
            savePrestations();
            updateTotals();
            addRow();
        }

        function enableEdit(i) {
            const row = document.getElementById(`row-${i}`);
            row.querySelectorAll('input, select').forEach(input => input.disabled = false);
            row.classList.remove('validated');
            const iconHolder = row.querySelector('.icon-holder');
            iconHolder.innerHTML = `
                <i class="fas fa-check-circle check-icon" onclick="validateRow(${i})" title="Valider"></i>
                <i class="fas fa-pen edit-icon disabled" title="Modifier"></i>
                <i class="fas fa-trash delete-icon disabled" title="Supprimer"></i>`;
            const buttonRow = document.createElement('tr');
            buttonRow.id = `button-row-${i}`;
            buttonRow.innerHTML = `
                <td colspan="4">
                    <div class="action-buttons">
                        <button class="validate-modif-btn" onclick="validateRow(${i})">Valider modif</button>
                    </div>
                </td>`;
            document.getElementById('prestationsBody').insertBefore(buttonRow, row.nextSibling);
            savePrestations();
            updateTotals();
        }

        function deleteRow(i) {
            const row = document.getElementById(`row-${i}`);
            const buttonRow = document.getElementById(`button-row-${i}`);
            if (row) row.remove();
            if (buttonRow) buttonRow.remove();
            savePrestations();
            updateTotals();
        }

        function savePrestations() {
            const prestationsData = [];
            document.querySelectorAll('#prestationsBody tr:not([id*="button-row"])').forEach(row => {
                const select = row.querySelector('.designation');
                const customDesignation = row.querySelector('.custom-designation');
                const designation = select.value === 'custom' ? customDesignation.value : select.value;
                const quantity = row.querySelector('.quantity').value;
                const unitPrice = row.querySelector('.unitPrice').value;
                const total = row.querySelector('.total').value;
                if (designation && quantity && unitPrice && total) {
                    prestationsData.push({
                        designation: designation,
                        quantity: quantity,
                        unitPrice: unitPrice,
                        total: total
                    });
                }
            });
            localStorage.setItem('prestationsData', JSON.stringify(prestationsData));
        }

        function loadPrestations() {
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            const tbody = document.getElementById('prestationsBody');
            prestationsData.forEach((item, index) => {
                const isCustom = !articlesDB.some(article => article.name === item.designation);
                const row = document.createElement('tr');
                row.id = `row-${index}`;
                row.innerHTML = `
                    <td data-label="D√©signation">
                        <select class="designation" id="des-${index}" onchange="onInputChange(${index})" disabled>
                            <option value="">--Choisir--</option>
                            ${articlesDB.map(article => `<option value="${article.name}" data-price="${article.unitPrice}" ${article.name === item.designation ? 'selected' : ''}>${article.name}</option>`).join('')}
                            <option value="custom" ${isCustom ? 'selected' : ''}>Autre (saisie manuelle)</option>
                        </select>
                        <input type="text" class="custom-designation" id="cust-${index}" value="${isCustom ? item.designation : ''}" style="display:${isCustom ? 'block' : 'none'};" oninput="onInputChange(${index})" disabled>
                        <span class="icon-holder">
                            <i class="fas fa-check-circle check-icon disabled" title="Valid√©"></i>
                            <i class="fas fa-pen edit-icon" onclick="enableEdit(${index})" title="Modifier"></i>
                            <i class="fas fa-trash delete-icon" onclick="deleteRow(${index})" title="Supprimer"></i>
                        </span>
                    </td>
                    <td data-label="Qt√©"><input type="number" class="quantity" id="qte-${index}" value="${item.quantity || ''}" min="1" onblur="onInputChange(${index})" disabled/></td>
                    <td data-label="PU HT"><input type="text" inputmode="decimal" pattern="[0-9]*\.?[0-9]+" class="unitPrice" id="pu-${index}" value="${item.unitPrice || ''}" onblur="onInputChange(${index})" disabled/></td>
                    <td data-label="Prix Total HT"><input type="number" class="total no-arrows" id="total-${index}" value="${item.total || ''}" readonly /></td>`;
                row.classList.add('validated');
                tbody.appendChild(row);
            });
            index = prestationsData.length;
            updateTotals();
            if (prestationsData.length === 0) addRow();
        }

        function updateTotals() {
            let totalHT = 0;
            document.querySelectorAll('#prestationsBody tr:not([id*="button-row"])').forEach(row => {
                const total = parseFloat(row.querySelector('.total')?.value) || 0;
                if (!isNaN(total) && total >= 0) {
                    totalHT += total;
                }
            });
            const tva = totalHT * 0.2;
            const totalTTC = totalHT + tva;
            document.getElementById('totalHT').textContent = totalHT.toFixed(2) + ' ‚Ç¨';
            document.getElementById('tva').textContent = tva.toFixed(2) + ' ‚Ç¨';
            document.getElementById('totalTTC').textContent = totalTTC.toFixed(2) + ' ‚Ç¨';
        }

        function saveIntervention() {
            const clientData = {
                clientName: document.getElementById('clientName').value.trim(),
                clientAddress: document.getElementById('clientAddress').value.trim(),
                clientPhone: document.getElementById('clientPhone').value.trim(),
                interventionDate: document.getElementById('interventionDate').value,
                technician: document.getElementById('technician').value.trim(),
                status: document.getElementById('status').value,
                paymentTerms: document.getElementById('paymentTerms').value
            };
            const prestationsData = JSON.parse(localStorage.getItem('prestationsData') || '[]');
            if (!clientData.clientName || !clientData.interventionDate || !clientData.technician) {
                alert('Veuillez remplir les champs obligatoires : Nom du client, Date, Technicien.');
                if (!clientData.clientName) document.getElementById('clientName').classList.add('error');
                if (!clientData.interventionDate) document.getElementById('interventionDate').classList.add('error');
                if (!clientData.technician) document.getElementById('technician').classList.add('error');
                return;
            }
            if (prestationsData.length === 0) {
                alert('Veuillez ajouter au moins une prestation valid√©e.');
                return;
            }
            isValidated = true;
            localStorage.setItem('interventionData', JSON.stringify(clientData));
            const crmData = JSON.parse(localStorage.getItem('crmData') || '[]');
            crmData.push({
                date: clientData.interventionDate,
                intervention: `Intervention pour ${clientData.clientName}`,
                technician: clientData.technician,
                montantTTC: document.getElementById('totalTTC').textContent
            });
            localStorage.setItem('crmData', JSON.stringify(crmData));
            alert('Bon d‚Äôintervention valid√© et enregistr√© !');
            document.querySelectorAll('.error').forEach(el => el.classList.remove('error'));
            loadCrmData();
        }

        function loadIntervention() {
            const clientData = JSON.parse(localStorage.getItem('interventionData') || '{}');
            document.getElementById('clientName').value = clientData.clientName || '';
            document.getElementById('clientAddress').value = clientData.clientAddress || '';
            document.getElementById('clientPhone').value = clientData.clientPhone || '';
            document.getElementById('interventionDate').value = clientData.interventionDate || '';
            document.getElementById('technician').value = clientData.technician || '';
            document.getElementById('status').value = clientData.status || 'en_cours';
            document.getElementById('paymentTerms').value = clientData.paymentTerms || 'virement_30j';
        }

        function loadCrmData() {
            const crmData = JSON.parse(localStorage.getItem('crmData') || '[]');
            const tbody = document.getElementById('crmBody');
            tbody.innerHTML = '';
            crmData.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${item.date}</td>
                    <td>${item.intervention}</td>
                    <td>${item.technician}</td>
                    <td>${item.montantTTC}</td>`;
                tbody.appendChild(row);
            });
        }

        function printIntervention() {
            if (!isValidated) {
                alert('Veuillez valider le bon d‚Äôintervention avant d‚Äôimprimer.');
                return;
            }
            window.print();
        }

        function sendIntervention() {
            if (!isValidated) {
                alert('Veuillez valider le bon d‚Äôintervention avant d‚Äôenvoyer.');
                return;
            }
            alert('Bon d‚Äôintervention envoy√© (fonctionnalit√© simul√©e).');
        }

        function cancelIntervention() {
            if (confirm('Voulez-vous annuler ce bon d‚Äôintervention ?')) {
                localStorage.removeItem('interventionData');
                localStorage.removeItem('prestationsData');
                window.location.reload();
            }
        }

        // Initialisation
        loadIntervention();
        loadPrestations();
        loadCrmData();
    </script>
</body>
</html>