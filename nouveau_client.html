

<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Nouveau client - Optimis√©</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    body { font-family: 'Segoe UI', sans-serif; padding: 20px; background: #f5f5f5; }
    form { background: white; padding: 20px; border-radius: 10px; max-width: 700px; margin: auto; }
    h1 { color: #b30000; font-size: 1.5rem; }
    label { display: block; margin-top: 15px; font-weight: 600; }
    input, select, button {
      width: 100%; padding: 10px; font-size: 1rem; margin-top: 5px;
      border-radius: 5px; border: 1px solid #ccc; box-sizing: border-box;
    }
    .row { display: flex; flex-wrap: wrap; gap: 10px; }
    .row > div { flex: 1; min-width: 120px; }
    .adresse-intervention {
      border: 1px dashed #ccc;
      padding: 10px;
      margin-top: 15px;
      border-radius: 6px;
    }
    .small-btn {
      background: #0077cc; color: white; margin-top: 5px;
      font-size: 0.9rem; width: auto; padding: 6px 10px;
    }
  </style>
</head>
<body>
<h1>‚ûï Nouveau client</h1>
<form onsubmit="enregistrerClient(); return false;">
<label>Nom / Raison sociale</label>
<input id="nom" required="" type="text"/>
<div class="row">
<div><label>SIRET</label><input id="siret" type="text"/></div>
<div><label>Dirigeant</label><input id="dirigeant" type="text"/></div>
</div>
<label>Adresse principale</label>
<div class="row">
<div><input id="rue" placeholder="N¬∞ et rue" type="text"/></div>
<div><input id="cp" oninput="suggestVille(this.value, 'ville')" placeholder="Code postal" type="text"/></div>
<div><input id="ville" list="villes" placeholder="Ville"/></div>
</div>
<button class="small-btn" onclick="geolocaliser('rue','cp','ville')" type="button">üìç Utiliser ma position</button>
<div class="row">
<div><label>T√©l√©phone</label><input id="telephone" type="tel"/></div>
<div><label>Email comptabilit√©</label><input id="email_compta" type="email"/></div>
<div><label>Email direction</label><input id="email_direction" type="email"/></div>
</div>
<label>Nom du contact r√©f√©rent</label>
<input id="contact" type="text"/>
<label>Adresses d‚Äôintervention</label>
<div id="adresses-intervention">
<div class="adresse-intervention">
<input class="lieu-nom" placeholder="Nom du lieu" type="text"/>
<input class="lieu-rue" placeholder="N¬∞ et rue" type="text"/>
<input class="lieu-cp" oninput="suggestVille(this.value, this.nextElementSibling.id)" placeholder="Code postal" type="text"/>
<input class="lieu-ville" id="lieu-ville-0" list="villes" placeholder="Ville"/>
<input class="lieu-contact" placeholder="Contact sur place" type="text"/>
<button class="small-btn" onclick="geolocaliserBloc(this)" type="button">üìç Utiliser ma position</button>
</div>
</div>
<button onclick="ajouterAdresse()" type="button">‚ûï Ajouter une adresse</button>
<button type="submit">‚úÖ Enregistrer client</button>
</form>
<datalist id="villes"></datalist>
<script>
    function ajouterAdresse() {
      const container = document.getElementById("adresses-intervention");
      const index = container.children.length;
      const div = document.createElement("div");
      div.className = "adresse-intervention";
      div.innerHTML = `
        <input type="text" placeholder="Nom du lieu" class="lieu-nom" />
        <input type="text" placeholder="N¬∞ et rue" class="lieu-rue" />
        <input type="text" placeholder="Code postal" class="lieu-cp" oninput="suggestVille(this.value, 'lieu-ville-${index}')" />
        <input list="villes" placeholder="Ville" class="lieu-ville" id="lieu-ville-${index}" />
        <input type="text" placeholder="Contact sur place" class="lieu-contact" />
        <button type="button" class="small-btn" onclick="geolocaliserBloc(this)">üìç Utiliser ma position</button>
      `;
      container.appendChild(div);
    }

    function enregistrerClient() {
      const client = {
        nom: document.getElementById("nom").value,
        siret: document.getElementById("siret").value,
        dirigeant: document.getElementById("dirigeant").value,
        rue: document.getElementById("rue").value,
        cp: document.getElementById("cp").value,
        ville: document.getElementById("ville").value,
        telephone: document.getElementById("telephone").value,
        email_compta: document.getElementById("email_compta").value,
        email_direction: document.getElementById("email_direction").value,
        contact: document.getElementById("contact").value,
        adresses_intervention: Array.from(document.querySelectorAll(".adresse-intervention")).map(div => ({
          nom: div.querySelector(".lieu-nom").value,
          rue: div.querySelector(".lieu-rue").value,
          cp: div.querySelector(".lieu-cp").value,
          ville: div.querySelector(".lieu-ville").value,
          contact: div.querySelector(".lieu-contact").value
        }))
      };
      let clients = JSON.parse(localStorage.getItem("clients") || "[]");
      clients.push(client);
      localStorage.setItem("clients", JSON.stringify(clients));
      localStorage.setItem("client_recent", client.nom);
      alert("Client '" + client.nom + "' enregistr√© ! Redirection...");
      
      const urlParams = new URLSearchParams(window.location.search);
      const redirection = urlParams.get('from') === 'intervention' ? 'intervention.html' : 'clients.html';
      setTimeout(() => { window.location.href = redirection; }, 300);
    
    }

    async function geolocaliser(idRue, idCp, idVille) {
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
        const data = await res.json();
        document.getElementById(idRue).value = data.address.road || "";
        document.getElementById(idCp).value = data.address.postcode || "";
        document.getElementById(idVille).value = data.address.city || data.address.town || data.address.village || "";
      });
    }

    async function geolocaliserBloc(button) {
      const bloc = button.parentElement;
      navigator.geolocation.getCurrentPosition(async pos => {
        const { latitude, longitude } = pos.coords;
        const res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${latitude}&lon=${longitude}`);
        const data = await res.json();
        bloc.querySelector(".lieu-rue").value = data.address.road || "";
        bloc.querySelector(".lieu-cp").value = data.address.postcode || "";
        bloc.querySelector(".lieu-ville").value = data.address.city || data.address.town || data.address.village || "";
      });
    }

    async function suggestVille(cp, targetId) {
      if (cp.length < 4) return;
      const res = await fetch(`https://geo.api.gouv.fr/communes?codePostal=${cp}&fields=nom`);
      const villes = await res.json();
      const datalist = document.getElementById("villes");
      datalist.innerHTML = "";
      villes.forEach(v => {
        const opt = document.createElement("option");
        opt.value = v.nom;
        datalist.appendChild(opt);
      });
    }
  </script>
</body>
</html>
