
<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8" />
  <title>Intervention - Mendes Protection Incendie</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet" />
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
    }
  </style>
</head>
<body class="min-h-screen pb-24 text-gray-800">
  <h1 class="text-xl font-bold text-red-700 mb-4">➕ Nouvelle intervention</h1>

  <section class="bg-white rounded shadow p-4 mb-6">
    <h2 class="text-lg font-semibold mb-2">👤 Client</h2>
    <label class="text-sm text-gray-600">Choisir un client existant</label>
    <select id="select-client" class="w-full p-2 border rounded mb-2"></select>
    <button onclick="window.location.href='nouveau_client.html?from=intervention'" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded text-sm">➕ Nouveau client</button>

    <label class="mt-4 block text-sm text-gray-600">
      <input id="check-lieu-diff" type="checkbox" onchange="toggleLieu()"> Lieu d’intervention différent
    </label>
    <div id="lieu-diff" style="display: none;">
      <label class="text-sm text-gray-600">Adresse du lieu d’intervention</label>
      <input type="text" placeholder="Saisir adresse ou nom du site" class="w-full p-2 border rounded" />
    </div>

    <label class="mt-4 block text-sm text-gray-600">Lieu d’intervention associé</label>
    <select id="select-lieu" class="w-full p-2 border rounded mt-1" style="display: none;">
      <option value="">-- Choisir un lieu --</option>
    </select>
  </section>

  <section class="bg-white rounded shadow p-4 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-3">🔧 Type d’intervention</h2>
    <div class="grid grid-cols-1 sm:grid-cols-2 gap-4 text-sm">
      <a href="intervention_extincteurs.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-center">🧯 Extincteurs</a>
      <a href="intervention_baes.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-center">💡 BAES</a>
      <a href="intervention_ria.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-center">🚿 RIA</a>
      <a href="intervention_desenfumage.html" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded text-center">💨 Désenfumage</a>
      <a id="btn-bon" href="#" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded text-center col-span-full">🧾 Bon d’intervention</a>
    </div>
  </section>

  <section class="bg-white rounded shadow p-4 mb-6">
    <h2 class="text-lg font-semibold text-gray-800 mb-2">📄 Brouillons en cours</h2>
    <div id="brouillons-container" class="space-y-3 text-sm text-gray-700">
      <em>Aucun brouillon en cours.</em>
    </div>
  </section>

  <footer class="fixed bottom-0 left-0 right-0 bg-white border-t shadow flex justify-around p-3 text-xs z-50">
    <a href="index.html" class="flex flex-col items-center gap-1">
      <span class="text-xl">🏠</span>
      <span>Accueil</span>
    </a>
    <a href="clients.html" class="flex flex-col items-center gap-1">
      <span class="text-xl">📁</span>
      <span>Clients</span>
    </a>
    <a href="intervention.html" class="flex flex-col items-center gap-1">
      <span class="text-xl">🛠️</span>
      <span>Intervention</span>
    </a>
  </footer>

  <script>
    function toggleLieu() {
      document.getElementById("lieu-diff").style.display =
        document.getElementById("check-lieu-diff").checked ? "block" : "none";
    }

    function chargerClients() {
      const select = document.getElementById("select-client");
      const clients = JSON.parse(localStorage.getItem("clients") || "[]");
      const urlParams = new URLSearchParams(window.location.search);
      const nomClientURL = urlParams.get("client");
      const clientRecent = localStorage.getItem("client_recent");

      select.innerHTML = '<option value="">-- Sélectionner --</option>';
      clients.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.nom;
        opt.textContent = `${c.nom} – ${c.ville}`;
        if ((nomClientURL && c.nom === nomClientURL) || (clientRecent && c.nom === clientRecent)) {
          opt.selected = true;
        }
        select.appendChild(opt);
      });

      // Déclencher l'affichage des lieux si un client est déjà sélectionné
      setTimeout(() => {
        if (select.value) {
          select.dispatchEvent(new Event("change"));
        }
      }, 100);
    }

    function chargerBrouillons() {
      const container = document.getElementById("brouillons-container");
      container.innerHTML = "";
      for (let key in localStorage) {
        if (key.startsWith("crm_extincteurs_") || key.startsWith("crm_ria_") || key.startsWith("crm_baes_") || key.startsWith("crm_desenfumage_") || key.startsWith("bon_intervention_")) {
          const type = key.includes("extincteurs") ? "Extincteurs" :
                       key.includes("ria") ? "RIA" :
                       key.includes("baes") ? "BAES" :
                       key.includes("desenfumage") ? "Désenfumage" :
                       "Bon d’intervention";
          const label = key.split("_").slice(-1)[0];
          const div = document.createElement("div");
          div.className = "border rounded p-3 bg-gray-50";
          div.innerHTML = `
            <strong>${label}</strong><br/>
            <small>Type : ${type}</small>
            <div class="mt-2 flex gap-3">
              <button onclick="reprendreBrouillon('${key}')" class="bg-blue-600 text-white px-3 py-1 rounded">Reprendre</button>
              <button onclick="supprimerBrouillon('${key}')" class="bg-red-600 text-white px-3 py-1 rounded">Supprimer</button>
            </div>
          `;
          container.appendChild(div);
        }
      }
      if (container.innerHTML === "") {
        container.innerHTML = "<em>Aucun brouillon en cours.</em>";
      }
    }

    function reprendreBrouillon(key) {
      localStorage.setItem("current_brouillon", key);
      window.location.href = "intervention_extincteurs.html";
    }

    function supprimerBrouillon(key) {
      if (confirm("Supprimer ce brouillon ?")) {
        localStorage.removeItem(key);
        chargerBrouillons();
      }
    }

    document.getElementById("select-client").addEventListener("change", () => {
      const nomClient = document.getElementById("select-client").value;
      const clients = JSON.parse(localStorage.getItem("clients") || "[]");
      const client = clients.find(c => c.nom === nomClient);
      const lieuSelect = document.getElementById("select-lieu");
      lieuSelect.innerHTML = "<option value=''>-- Choisir un lieu --</option>";

      if (client && client.adresses_intervention && client.adresses_intervention.length) {
        client.adresses_intervention.forEach(ad => {
          const opt = document.createElement("option");
          opt.value = ad.rue + ' - ' + ad.ville;
          opt.textContent = (ad.nom || '') + ' - ' + ad.rue + ', ' + ad.ville;
          lieuSelect.appendChild(opt);
        });
        lieuSelect.style.display = "block";
      } else {
        lieuSelect.style.display = "none";
      }
    });

    document.getElementById("btn-bon").addEventListener("click", function(e) {
    e.preventDefault();
    const select = document.getElementById("select-client");
    const nom = select.value;
    if (!nom) {
      alert("Veuillez sélectionner un client avant de générer le bon d’intervention.");
      return;
    }
    const nomClean = nom.replace(/\s+/g, '_').normalize("NFD").replace(/\p{Diacritic}/gu, "").toUpperCase();
    window.location.href = `bon_intervention_RESUME_CLAIR_OK.html?client=${encodeURIComponent(nomClean)}`;
  });

window.onload = () => {
      chargerClients();
      chargerBrouillons();
    };
  </script>
</body>
</html>
