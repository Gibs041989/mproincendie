<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interventions - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <style>
        .nav-buttons { display: flex; flex-wrap: wrap; gap: 10px; justify-content: center; }
        .nav-buttons a, .nav-buttons button { flex: 1 1 150px; text-align: center; padding: 12px; font-size: 16px; }
        @media (max-width: 600px) {
            .nav-buttons a, .nav-buttons button { flex: 1 1 100%; }
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>‚ûï Interventions</h1>

        <section class="section">
            <h2>üë§ Client</h2>
            <label>S√©lectionner un client existant: 
                <select id="clientSelect" onchange="selectClient()">
                    <option value="">-- S√©lectionner --</option>
                </select>
            </label>
            <a href="nouveau_client.html"><button>‚ûï Nouveau client</button></a>
            <label><input type="checkbox" id="lieuDifferent" onchange="toggleLieuForm()"> Lieu d‚Äôintervention diff√©rent</label>
            <div id="lieuForm" style="display: none;">
                <label>Adresse du lieu d‚Äôintervention: <input type="text" id="lieuAdresse"></label>
            </div>
            <label>Lieu d‚Äôintervention associ√©: 
                <select id="lieuSelect">
                    <option value="">-- Choisir un lieu --</option>
                </select>
            </label>
        </section>

        <section class="section">
            <h2>üîß Type d‚Äôintervention</h2>
            <select id="typeIntervention">
                <option value="">-- Choisir --</option>
                <option value="extincteurs">üßØ Extincteurs (CRM)</option>
                <option value="baes">üí° BAES (CRM)</option>
                <option value="ria">üöø RIA (CRM)</option>
                <option value="desenfumage">üí® D√©senfumage (CRM)</option>
                <option value="bon_intervention">üßæ Bon d‚Äôintervention (direct)</option>
            </select>
            <div class="nav-buttons">
                <button onclick="startIntervention()">D√©marrer l‚Äôintervention</button>
            </div>
        </section>

        <section class="section">
            <h2>üìÑ Brouillons en cours</h2>
            <div id="brouillonsList">Aucun brouillon en cours.</div>
        </section>

        <div class="navigation nav-buttons">
            <a href="index.html">üè† Accueil</a>
            <a href="client.html">üìÅ Clients</a>
        </div>
    </div>

    <script>
        let clients = JSON.parse(localStorage.getItem('clients')) || [];

        window.onload = () => {
            const clientSelect = document.getElementById('clientSelect');
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });
            loadBrouillons();
        };

        function toggleLieuForm() {
            const lieuForm = document.getElementById('lieuForm');
            const lieuSelect = document.getElementById('lieuSelect');
            if (document.getElementById('lieuDifferent').checked) {
                lieuForm.style.display = 'block';
                lieuSelect.style.display = 'none';
            } else {
                lieuForm.style.display = 'none';
                lieuSelect.style.display = 'block';
            }
        }

        function selectClient() {
            const client = document.getElementById('clientSelect').value;
            const lieu = document.getElementById('lieuDifferent').checked 
                ? document.getElementById('lieuAdresse').value 
                : document.getElementById('lieuSelect').value;
            const interventionData = { client, lieu };
            localStorage.setItem('currentIntervention', JSON.stringify(interventionData));

            const lieuSelect = document.getElementById('lieuSelect');
            lieuSelect.innerHTML = '<option value="">-- Choisir un lieu --</option>';
            const clientData = clients.find(c => c.name === client);
            if (clientData && clientData.lieux) {
                clientData.lieux.forEach(lieu => {
                    const option = document.createElement('option');
                    option.value = lieu.adresse;
                    option.textContent = `${lieu.adresse}, ${lieu.ville}`;
                    lieuSelect.appendChild(option);
                });
            }
        }

        function startIntervention() {
            const type = document.getElementById('typeIntervention').value;
            const client = document.getElementById('clientSelect').value;
            const lieu = document.getElementById('lieuDifferent').checked 
                ? document.getElementById('lieuAdresse').value 
                : document.getElementById('lieuSelect').value;
            if (!client) {
                alert('Veuillez s√©lectionner un client.');
                return;
            }
            if (!lieu) {
                alert('Veuillez s√©lectionner ou entrer un lieu.');
                return;
            }
            if (!type) {
                alert('Veuillez s√©lectionner un type d‚Äôintervention.');
                return;
            }
            const interventionData = { client, lieu };
            localStorage.setItem('currentIntervention', JSON.stringify(interventionData));
            if (type === 'bon_intervention') {
                window.location.href = 'bon_intervention.html';
            } else {
                window.location.href = `CRM_${type}.html`;
            }
        }

        function loadBrouillons() {
            const drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            const brouillonsList = document.getElementById('brouillonsList');
            brouillonsList.innerHTML = '';
            if (Object.keys(drafts).length === 0) {
                brouillonsList.textContent = 'Aucun brouillon en cours.';
                return;
            }
            for
            (const [key, draft] of Object.entries(drafts)) {
                const div = document.createElement('div');
                div.className = 'brouillon';
                div.innerHTML = `
                    ${key}: Client ${draft.client || 'Inconnu'} - ${draft.date || 'Sans date'}
                    <button onclick="loadDraft('${key}')">Charger</button>
                    <button onclick="deleteDraft('${key}')">Supprimer</button>
                `;
                brouillonsList.appendChild(div);
            }
        }

        function loadDraft(key) {
            const drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            const draft = drafts[key];
            if (draft) {
                localStorage.setItem('currentIntervention', JSON.stringify(draft));
                window.location.href = key === 'bon_intervention' ? 'bon_intervention.html' : `CRM_${key.split('_')[1]}.html`;
            }
        }

        function deleteDraft(key) {
            let drafts = JSON.parse(localStorage.getItem('drafts')) || {};
            delete drafts[key];
            localStorage.setItem('drafts', JSON.stringify(drafts));
            loadBrouillons();
        }
    </script>
</body>
</html>