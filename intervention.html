<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interventions - MPro Incendie</title>
    <link rel="stylesheet" href="css/styles.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
</head>
<body>
    <div class="container">
        <h1>‚ûï Interventions</h1>

        <section class="section">
            <h2>üë§ Client</h2>
            <label>S√©lectionner un client existant: 
                <select id="clientSelect">
                    <option value="">-- S√©lectionner --</option>
                </select>
            </label>
            <p><a href="nouveau_client.html"><button class="action">‚ûï Nouveau client</button></a></p>
            <label><input type="checkbox" id="differentLocation"> Lieu d‚Äôintervention diff√©rent</label>
            <div id="locationInputs" style="display: none;">
                <label>Adresse du lieu d‚Äôintervention: <input type="text" id="locationAddress"></label>
            </div>
            <label>Lieu d‚Äôintervention associ√©: 
                <select id="locationSelect">
                    <option value="">-- Choisir un lieu --</option>
                </select>
            </label>
        </section>

        <section class="section">
            <h2>üîß Type d‚Äôintervention</h2>
            <select id="interventionType">
                <option value="">-- Choisir --</option>
                <option value="extincteurs">üßØ Extincteurs (CRM)</option>
                <option value="baes">üí° BAES (CRM)</option>
                <option value="ria">üöø RIA (CRM)</option>
                <option value="desenfumage">üí® D√©senfumage (CRM)</option>
                <option value="bon_intervention">üßæ Bon d‚Äôintervention (direct)</option>
            </select>
            <p><button class="primary" onclick="startIntervention()">D√©marrer l‚Äôintervention</button></p>
        </section>

        <section class="section" id="crmSummary">
            <h2>üìÑ Brouillons en cours</h2>
            <div id="draftsList">
                <p id="noDrafts">Aucun brouillon en cours.</p>
            </div>
        </section>
    </div>

    <div class="footer-nav">
        <div class="navigation nav-buttons">
            <a href="index.html">üè† Accueil</a>
            <a href="client.html">üìÅ Clients</a>
        </div>
    </div>

    <script>
        window.onload = () => {
            loadClients();
            loadDrafts();
        };

        function loadClients() {
            const clients = JSON.parse(localStorage.getItem('clients') || '[]');
            const clientSelect = document.getElementById('clientSelect');
            clientSelect.innerHTML = '<option value="">-- S√©lectionner --</option>';
            clients.forEach(client => {
                const option = document.createElement('option');
                option.value = client.name;
                option.textContent = client.name;
                clientSelect.appendChild(option);
            });

            clientSelect.addEventListener('change', () => {
                const clientName = clientSelect.value;
                const client = clients.find(c => c.name === clientName);
                const locationSelect = document.getElementById('locationSelect');
                locationSelect.innerHTML = '<option value="">-- Choisir un lieu --</option>';
                if (client) {
                    localStorage.setItem('currentIntervention', JSON.stringify({
                        client: client.name,
                        adresse: client.adresse,
                        codePostal: client.codePostal,
                        ville: client.ville,
                        telephone: client.telephone,
                        email: client.email
                    }));

                    if (client.locations) {
                        client.locations.forEach(loc => {
                            const option = document.createElement('option');
                            option.value = loc;
                            option.textContent = loc;
                            locationSelect.appendChild(option);
                        });
                    }
                }
            });
        }

        function toggleLocationInputs() {
            const differentLocation = document.getElementById('differentLocation').checked;
            document.getElementById('locationInputs').style.display = differentLocation ? 'block' : 'none';
        }

        document.getElementById('differentLocation').addEventListener('change', toggleLocationInputs);

        function startIntervention() {
            const client = document.getElementById('clientSelect').value;
            const interventionType = document.getElementById('interventionType').value;

            if (!client) {
                alert('Veuillez s√©lectionner un client.');
                return;
            }

            if (!interventionType) {
                alert('Veuillez s√©lectionner un type d‚Äôintervention.');
                return;
            }

            let page;
            switch (interventionType) {
                case 'extincteurs':
                    page = 'CRM_extincteurs.html';
                    break;
                case 'baes':
                    page = 'CRM_baes.html';
                    break;
                case 'ria':
                    page = 'CRM_ria.html';
                    break;
                case 'desenfumage':
                    page = 'CRM_desenfumage.html';
                    break;
                case 'bon_intervention':
                    page = 'bon_intervention.html';
                    break;
            }

            window.location.href = page;
        }

        function loadDrafts() {
            const drafts = JSON.parse(localStorage.getItem('drafts') || '{}');
            const draftsList = document.getElementById('draftsList');
            const noDrafts = document.getElementById('noDrafts');
            draftsList.innerHTML = '';
            let hasDrafts = false;
            for (const [key, draft] of Object.entries(drafts)) {
                if (draft.summary) {
                    hasDrafts = true;
                    const draftItem = document.createElement('p');
                    draftItem.innerHTML = `<a href="${key === 'bon_intervention' ? 'bon_intervention.html' : key + '.html'}">${draft.summary}</a>`;
                    draftsList.appendChild(draftItem);
                }
            }
            noDrafts.style.display = hasDrafts ? 'none' : 'block';
        }
    </script>
</body>
</html>