

<!DOCTYPE html>

<html lang="fr">
<head>
<meta charset="utf-8"/>
<title>Intervention - MproIntervention</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<style>
    body {
      font-family: 'Segoe UI', sans-serif;
      margin: 0;
      padding: 20px;
      background: #f5f5f5;
    }
    h1 { color: #b30000; font-size: 1.5rem; }
    section { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 1px 4px rgba(0,0,0,0.1); }
    label { font-weight: 600; display: block; margin-top: 10px; }
    input, select {
      width: 100%; padding: 10px; margin-top: 5px; border: 1px solid #ccc; border-radius: 4px;
    }
    button {
      background: #0077cc; color: white; border: none; padding: 10px 20px;
      border-radius: 6px; margin-top: 15px; cursor: pointer;
    }
    .type-btns {
      display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;
    }
    .type-btns button {
      flex: 1 1 calc(50% - 10px);
      background: #e60000;
    }
    .brouillon {
      border: 1px solid #ccc; border-radius: 6px; padding: 10px; margin-bottom: 10px;
      background: #fff;
    }
    .brouillon-actions {
      margin-top: 10px;
    }
    .brouillon-actions button {
      margin-right: 10px;
      padding: 6px 12px;
    }
    .nav-shortcuts {
      position: fixed;
      bottom: 0; left: 0; right: 0;
      background: white;
      display: flex;
      justify-content: center;
      gap: 30px;
      border-top: 1px solid #ccc;
      padding: 12px 0;
      font-size: 1.8rem;
      z-index: 999;
    }
  </style>
</head>
<body>
<h1>➕ Nouvelle intervention</h1>
<section>
<h2>🧑 Client</h2>
<label>Choisir un client existant</label>
<select id="select-client">
<option value="">-- Sélectionner --</option>
</select>
<button onclick="window.location.href='nouveau_client.html'">➕ Nouveau client</button>
<label style="margin-top: 20px;">
<input id="check-lieu-diff" onchange="toggleLieu()" type="checkbox"/> Lieu d’intervention différent
    </label>
<div id="lieu-diff" style="display: none;">
<label>Adresse du lieu d’intervention</label>
<input placeholder="Saisir adresse ou nom du site" type="text"/>
</div>
<label style="margin-top: 20px;">Lieu d’intervention (si différent ou multiple)</label><select id="select-lieu" style="margin-top: 5px; display: none;"><option value="">-- Choisir un lieu --</option></select></section>
<section>
<h2>🛠️ Type d’intervention</h2>
<div class="type-btns">
<button onclick="window.location.href='intervention_extincteurs.html'">🧯 Extincteurs</button>
<button onclick="window.location.href='intervention_baes.html'">💡 BAES</button>
<button onclick="window.location.href='intervention_ria.html'">🚿 RIA</button>
<button onclick="window.location.href='intervention_desenfumage.html'">💨 Désenfumage</button>
<button onclick="window.location.href='bon_intervention.html'">🔧 Bon d’intervention</button>
</div>
</section>
<section>
<h2>📝 Brouillons en cours</h2>
<div id="brouillons-container">Chargement des brouillons...</div>
</section>
<div class="nav-shortcuts">
<a href="index.html" title="Accueil">🏠</a>
<a href="intervention_extincteurs.html" title="Extincteurs">🧯</a>
<a href="intervention_ria.html" title="RIA">🚿</a>
<a href="intervention_baes.html" title="BAES">💡</a>
<a href="intervention_desenfumage.html" title="Désenfumage">💨</a>
</div>
<script>
    function toggleLieu() {
      document.getElementById("lieu-diff").style.display =
        document.getElementById("check-lieu-diff").checked ? "block" : "none";
    }

    function ajouterClient() {
      alert("Redirection vers la création d’un nouveau client.");
    }

    function chargerBrouillons() {
  const container = document.getElementById("brouillons-container");
  container.innerHTML = "";
  for (let key in localStorage) {
    if (key.startsWith("crm_extincteurs_") || key.startsWith("crm_ria_") || key.startsWith("crm_baes_") || key.startsWith("crm_desenfumage_") || key.startsWith("bon_intervention_")) {
      const type = key.includes("extincteurs") ? "Extincteurs" :
                   key.includes("ria") ? "RIA" :
                   key.includes("baes") ? "BAES" :
                   key.includes("desenfumage") ? "Désenfumage" :
                   "Bon d’intervention";
      const label = key.split("_").slice(-1)[0];
      const div = document.createElement("div");
      div.className = "brouillon";
      div.innerHTML = `
        <strong>${label}</strong><br/>
        <small>Type : ${type}</small>
        <div class="brouillon-actions">
          <button onclick="reprendreBrouillon('${key}')">Reprendre</button>
          <button onclick="supprimerBrouillon('${key}')">Supprimer</button>
        </div>
      `;
      container.appendChild(div);
    }
  }
  if (container.innerHTML === "") {
    container.innerHTML = "<em>Aucun brouillon en cours.</em>";
  }
}
      const container = document.getElementById("brouillons-container");
      container.innerHTML = "";
      for (let key in localStorage) {
        if (key.startsWith("crm_extincteurs_")) {
          const div = document.createElement("div");
          div.className = "brouillon";
          div.innerHTML = `
            <strong>${key.replace("crm_extincteurs_", "")}</strong>
            <div class="brouillon-actions">
              <button onclick="reprendreBrouillon('${key}')">Reprendre</button>
              <button onclick="supprimerBrouillon('${key}')">Supprimer</button>
            </div>
          `;
          container.appendChild(div);
        }
      }
      if (container.innerHTML === "") {
        container.innerHTML = "<em>Aucun brouillon en cours.</em>";
      }
    }

    function reprendreBrouillon(key) {
      localStorage.setItem("current_brouillon", key);
      window.location.href = "intervention_extincteurs.html";
    }

    function supprimerBrouillon(key) {
      if (confirm("Supprimer ce brouillon ?")) {
        localStorage.removeItem(key);
        chargerBrouillons();
      }
    }

    window.onload = () => {
      chargerBrouillons();
    };
  
function chargerClients() {
  const select = document.getElementById("select-client");
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  clients.forEach(c => {
    const opt = document.createElement("option");
    opt.value = c.nom;
    opt.textContent = c.nom + " – " + c.adresse;
    select.appendChild(opt);
  });
}
window.onload = () => {
  chargerBrouillons();
  chargerClients();
};

    function chargerClients() {
      const select = document.getElementById("select-client");
      const clients = JSON.parse(localStorage.getItem("clients") || "[]");
      
      const urlClient = new URLSearchParams(window.location.search).get('client');
      const urlClient = new URLSearchParams(window.location.search).get('client');
      const client_recent = urlClient || localStorage.getItem("client_recent");
    
      clients.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.nom;
        opt.textContent = c.nom + " – " + c.ville;
        if (client_recent && c.nom === client_recent) {
          opt.selected = true;
          localStorage.removeItem("client_recent");
        }
        select.appendChild(opt);
      });
    }
    
document.getElementById("select-client").addEventListener("change", () => {
  const nomClient = document.getElementById("select-client").value;
  const clients = JSON.parse(localStorage.getItem("clients") || "[]");
  const client = clients.find(c => c.nom === nomClient);
  const lieuSelect = document.getElementById("select-lieu");
  lieuSelect.innerHTML = "<option value=''>-- Choisir un lieu --</option>";

  if (client && client.adresses_intervention && client.adresses_intervention.length) {
    client.adresses_intervention.forEach(ad => {
      const opt = document.createElement("option");
      opt.value = ad.rue + ' - ' + ad.ville;
      opt.textContent = (ad.nom || '') + ' - ' + ad.rue + ', ' + ad.ville;
      lieuSelect.appendChild(opt);
    });
    lieuSelect.style.display = "block";
  } else {
    lieuSelect.style.display = "none";
  }
});
</script>
</body>
</html>
