<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Compte-rendu Extincteurs - MPRO Intervention</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #f5f5f5;
      padding: 20px;
      margin-bottom: 100px;
      max-width: 960px;
      margin-left: auto;
      margin-right: auto;
    }
    h2 { color: #b30000; }
    label { font-weight: 600; display: block; margin-top: 10px; }
    input, select, textarea {
      font-size: 16px;
      width: 100%;
      padding: 10px;
      border: 1px solid #ccc;
      border-radius: 4px;
      box-sizing: border-box;
    }
    .btn {
      display: inline-block;
      padding: 10px 20px;
      background: #0077cc;
      color: white;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      margin-top: 20px;
    }
    .btn:hover { background: #005fa3; }
    .extincteur-bloc {
      background: white;
      border: 1px solid #ccc;
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
    }
    summary {
      font-weight: bold;
      cursor: pointer;
    }
    .nav-shortcuts {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      background: white;
      display: flex;
      justify-content: space-around;
      border-top: 1px solid #ccc;
      padding: 12px 0;
      font-size: 1.5rem;
      z-index: 999;
    }
    @media (max-width: 768px) {
      .nav-shortcuts { font-size: 1.3rem; }
    }
  </style>
</head>
<body>
  <div class="bg-white p-4 flex items-center justify-between shadow mb-4">
    <img class="h-12" src="logo-mendes.png" alt="Logo MPRO"/>
  </div>

  <div class="bg-white p-4 shadow rounded mb-4" id="bandeau-client">
    <p><strong>üßæ Client :</strong> <span id="nom-client">[Nom client]</span></p>
    <p><strong>üìç Lieu d‚Äôintervention :</strong> <span id="lieu-intervention">[Lieu d‚Äôintervention]</span></p>
  </div>

  <h2>Compte-rendu Extincteurs</h2>

  <section>
    <label for="date_intervention">üìÖ Date d‚Äôintervention</label>
    <input type="date" id="date_intervention" />

    <label for="technicien">üë®‚Äçüîß Technicien</label>
    <input type="text" id="technicien" placeholder="Nom et pr√©nom" />
  </section>

  <section id="extincteurs-container" style="margin-top: 30px;"></section>

  <button class="btn" onclick="ajouterExtincteur()">‚ûï Ajouter un extincteur</button>

  <div style="margin-top: 30px;">
    <h3>‚úÖ Devoir de conseil</h3>
    <div style="display: flex; flex-direction: column; gap: 12px; margin-top: 10px;">
      <label class="dc-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; cursor: pointer;">
        <span>Registre pr√©sent et √† jour</span><input type="checkbox" id="dc-registre" />
      </label>
      <label class="dc-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; cursor: pointer;">
        <span>Signal√©tique √† jour</span><input type="checkbox" id="dc-signaletique" />
      </label>
      <label class="dc-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; cursor: pointer;">
        <span>BAES pr√©sents</span><input type="checkbox" id="dc-baes" />
      </label>
      <label class="dc-item" style="display: flex; justify-content: space-between; align-items: center; padding: 12px; border: 1px solid #ccc; border-radius: 8px; background: #f9f9f9; cursor: pointer;">
        <span>Plans de s√©curit√© pr√©sents et √† jour</span><input type="checkbox" id="dc-plans" />
      </label>
    </div>
  </div>

  <div style="margin-top: 30px;">
    <h3>üìù Observations g√©n√©rales</h3>
    <textarea id="observation_generale" rows="4" placeholder="Remarques..."></textarea>
  </div>

  <div style="margin: 30px 0; text-align: center;">
    <button class="btn" onclick="validerCompteRendu()">‚úÖ Valider le compte rendu</button>
    <button class="btn" onclick="window.location.href='bon.html'" style="background:#28a745;">‚û°Ô∏è Passer au bon d‚Äôintervention</button>
  </div>

  <div class="nav-shortcuts">
    <a href="index.html" title="Accueil">üè†</a>
    <a href="intervention.html" title="Intervention">üìã</a>
    <a href="clients.html" title="Clients">üë•</a>
    <a href="parametres.html" title="Param√®tres">‚öôÔ∏è</a>
  </div>

<script>
  const ID_CLIENT = localStorage.getItem("id_client") || "CLIENT123";

  function getExtincteursData() {
    const blocs = document.querySelectorAll(".extincteur-bloc");
    const extincteurs = [];
    blocs.forEach((bloc) => {
      extincteurs.push({
        type: bloc.querySelector(".ext-type")?.value || "",
        pp: bloc.querySelector(".ext-pp")?.checked || false,
        fab: bloc.querySelector(".ext-fab")?.value || "",
        year: bloc.querySelector(".ext-year")?.value || "",
        niv: bloc.querySelector(".ext-niv")?.value || "",
        emplacement: bloc.querySelector(".ext-emplacement")?.value || "",
        obs: bloc.querySelector(".ext-obs")?.value || ""
      });
    });
    return extincteurs;
  }

  function getFormData() {
    return {
      date: document.getElementById("date_intervention").value,
      technicien: document.getElementById("technicien").value,
      extincteurs: getExtincteursData(),
      devoir_conseil: {
        registre: document.getElementById("dc-registre").checked,
        signaletique: document.getElementById("dc-signaletique").checked,
        baes: document.getElementById("dc-baes").checked,
        plans: document.getElementById("dc-plans").checked
      },
      observation: document.getElementById("observation_generale").value,
      nom_client: localStorage.getItem("nom_client") || "",
      lieu_intervention: localStorage.getItem("lieu_intervention") || ""
    };
  }

  function sauvegarderCRM() {
    const data = getFormData();
    localStorage.setItem("crm_extincteurs_" + ID_CLIENT, JSON.stringify(data));
    localStorage.setItem("crm_extincteurs_DATE", new Date().toLocaleDateString("fr-FR"));
  }

  function restaurerCRM() {
    const data = JSON.parse(localStorage.getItem("crm_extincteurs_" + ID_CLIENT));
    if (!data) return;
    document.getElementById("date_intervention").value = data.date || "";
    document.getElementById("technicien").value = data.technicien || "";
    document.getElementById("observation_generale").value = data.observation || "";
    document.getElementById("dc-registre").checked = data.devoir_conseil.registre;
    document.getElementById("dc-signaletique").checked = data.devoir_conseil.signaletique;
    document.getElementById("dc-baes").checked = data.devoir_conseil.baes;
    document.getElementById("dc-plans").checked = data.devoir_conseil.plans;
    data.extincteurs.forEach(ext => {
      ajouterExtincteur();
      const bloc = document.querySelectorAll(".extincteur-bloc").at(-1);
      bloc.querySelector(".ext-type").value = ext.type;
      bloc.querySelector(".ext-pp").checked = ext.pp;
      bloc.querySelector(".ext-fab").value = ext.fab;
      bloc.querySelector(".ext-year").value = ext.year;
      bloc.querySelector(".ext-niv").value = ext.niv;
      bloc.querySelector(".ext-emplacement").value = ext.emplacement;
      bloc.querySelector(".ext-obs").value = ext.obs;
    });
  }

  function ajouterExtincteur() {
    const container = document.getElementById("extincteurs-container");
    const bloc = document.createElement("details");
    bloc.className = "extincteur-bloc";
    bloc.open = true;

    const summary = document.createElement("summary");
    summary.textContent = `üßØ Extincteur`;
    bloc.appendChild(summary);

    const contenu = document.createElement("div");
    contenu.innerHTML = `
      <label>Type</label><input type="text" class="ext-type" />
      <label>PP ? <input type="checkbox" class="ext-pp" /></label>
      <label>Fabricant</label><input type="text" class="ext-fab" />
      <label>Mill√©sime</label><input type="text" class="ext-year" />
      <label>Niveau</label><input type="text" class="ext-niv" />
      <label>Emplacement</label><input type="text" class="ext-emplacement" />
      <label>Observation</label><textarea rows="3" class="ext-obs"></textarea>
    `;
    bloc.appendChild(contenu);
    container.appendChild(bloc);
  }

  document.addEventListener("DOMContentLoaded", () => {
    const ancienne = localStorage.getItem("crm_extincteurs_" + ID_CLIENT);
    if (ancienne) {
      if (confirm("üì• Un brouillon existe. Voulez-vous le restaurer ?")) restaurerCRM();
    }

    setInterval(sauvegarderCRM, 15000);

    document.querySelector("button[onclick*='bon.html']")
      .addEventListener("click", () => {
        const data = getFormData();
        localStorage.setItem("crm_resume_" + ID_CLIENT, JSON.stringify(data));
      });

    document.querySelector("button[onclick*='validerCompteRendu']")
      .addEventListener("click", () => {
        const data = getFormData();
        const historique = JSON.parse(localStorage.getItem("crm_historique_" + ID_CLIENT) || "[]");
        historique.push({
          date: data.date,
          technicien: data.technicien,
          extincteurs: data.extincteurs,
          observation: data.observation
        });
        localStorage.setItem("crm_historique_" + ID_CLIENT, JSON.stringify(historique));
        localStorage.removeItem("crm_extincteurs_" + ID_CLIENT);
        alert("‚úÖ Compte-rendu enregistr√© dans l'historique.");
      });
  });
</script>
</body>
</html>